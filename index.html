<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality & Scrap Dashboard</title>
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #4e73df; --secondary: #858796; --success: #1cc88a; --danger: #e74a3b; --bg: #f8f9fc; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; }
        
        /* Sidebar */
        .sidebar { min-height: 100vh; background: linear-gradient(180deg, #4e73df 10%, #224abe 100%); color: white; }
        .nav-link { color: rgba(255,255,255,0.8); margin-bottom: 5px; cursor: pointer; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.2); border-radius: 5px; font-weight: bold; }
        
        /* Cards */
        .card { border: none; border-radius: 10px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); margin-bottom: 20px; }
        .card-header { background: white; border-bottom: 1px solid #e3e6f0; font-weight: bold; color: #4e73df; }
        
        /* Loading */
        #loading { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; text-align: center; padding-top: 20%; }
        
        .logo-area { text-align: center; padding: 20px; }
        .logo-area img { max-width: 120px; background: white; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

<!-- Loading Spinner -->
<div id="loading"><div class="spinner-border text-primary" role="status"></div><h3>Processing Data...</h3></div>

<div class="container-fluid">
    <div class="row">
        
        <!-- SIDEBAR -->
        <div class="col-md-2 sidebar p-3">
            <div class="logo-area">
                <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
                <h6 class="mt-2 small">Quality Control Tool</h6>
            </div>
            <hr>
            <nav class="nav flex-column">
                <a class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-chart-line me-2"></i> Dashboard</a>
                <a class="nav-link" onclick="showSection('production')"><i class="fas fa-plus-circle me-2"></i> Production Entry</a>
                <a class="nav-link" onclick="showSection('upload')"><i class="fas fa-file-excel me-2"></i> Bulk Upload</a>
            </nav>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-10 p-4">
            
            <!-- SECTION: DASHBOARD -->
            <div id="dashboard-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 text-gray-800">Review Dashboard</h1>
                    <button class="btn btn-primary btn-sm" onclick="fetchDashboardData()"><i class="fas fa-sync"></i> Refresh Data</button>
                </div>

                <!-- 1. LINE WISE SCRAP RATE -->
                <div class="card">
                    <div class="card-header">1. Line Wise Scrap Rate & Value</div>
                    <div class="card-body">
                        <canvas id="lineChart" height="80"></canvas>
                        <div class="table-responsive mt-3">
                            <table class="table table-bordered table-sm text-center" id="lineTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Line</th><th>Prod Value</th><th>Scrap Value</th><th>Rate %</th>
                                        <th>PCBA</th><th>Speaker</th><th>Battery</th><th>Magnet</th><th>Other</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- 2. MODEL WISE -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">2. Model Wise Performance</div>
                            <div class="card-body">
                                <canvas id="modelChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 4. PART WISE TOP 5 -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">4. Top 5 High Scrap Parts</div>
                            <div class="card-body">
                                <canvas id="partChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. DATE WISE TREND -->
                <div class="card mt-4">
                    <div class="card-header">3. Date / Month Wise Trend (Last 30 Days)</div>
                    <div class="card-body">
                        <canvas id="dateChart" height="60"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECTION: PRODUCTION ENTRY -->
            <div id="production-section" style="display:none;">
                <h3><i class="fas fa-edit"></i> Daily Production Entry</h3>
                <div class="card mt-3" style="max-width: 600px;">
                    <div class="card-body">
                        <form id="prodForm">
                            <div class="mb-3">
                                <label>Date</label>
                                <input type="date" id="pDate" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label>Model</label>
                                <select id="pModel" class="form-select"></select>
                            </div>
                            <div class="mb-3">
                                <label>Line No</label>
                                <input type="text" id="pLine" class="form-control" placeholder="L-01" required>
                            </div>
                            <div class="mb-3">
                                <label>Output Qty</label>
                                <input type="number" id="pOut" class="form-control" placeholder="0" required>
                            </div>
                            <button type="button" class="btn btn-success w-100" onclick="saveProduction()">Save Data</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- SECTION: BULK UPLOAD -->
            <div id="upload-section" style="display:none;">
                <h3><i class="fas fa-file-upload"></i> Bulk Scrap Upload</h3>
                <div class="card mt-3">
                    <div class="card-body text-center p-5">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h5>Select Excel File</h5>
                        <p class="text-muted">Columns: Doc Date, Line No, Material, Part Code, Price, Reject Qty, etc.</p>
                        <input type="file" id="uploadFile" class="form-control w-50 mx-auto mb-3" accept=".xlsx">
                        <button class="btn btn-primary" onclick="processExcel()">Upload Data</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // ******************************************************
    // PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
    // ******************************************************
    const API_URL = "https://script.google.com/macros/s/AKfycbw_odWVTIL3i5ibw22TzBo6SluKgHKoiLg6rk3WIn_lrHWnyCtZ1A5Ayc1aXPQBfuMh-w/exec"; 

    // --- NAVIGATION ---
    function showSection(id) {
        document.getElementById('dashboard-section').style.display = 'none';
        document.getElementById('production-section').style.display = 'none';
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById(id + '-section').style.display = 'block';
        
        // Update active sidebar
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');

        if(id === 'dashboard') fetchDashboardData();
    }

    // --- 1. FETCH & PROCESS DATA FOR DASHBOARD ---
    async function fetchDashboardData() {
        document.getElementById('loading').style.display = 'block';
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            processDataForCharts(data);
        } catch (error) {
            Swal.fire("Error", "Failed to fetch data", "error");
        }
        document.getElementById('loading').style.display = 'none';
    }

    // --- 2. CALCULATE LOGIC (THE BRAINS) ---
    function processDataForCharts(data) {
        // Data Structure helpers
        let models = {}; // Model Name -> Price
        data.models.forEach(m => models[m[0]] = m[1]);
        
        let lineData = {}; // Key: LineNo -> { prodVal: 0, scrapVal: 0, cat: {} }
        let modelStats = {}; // Key: Model -> { prodVal: 0, scrapVal: 0 }
        let partStats = {}; // Key: PartDesc -> scrapVal
        let dateStats = {}; // Key: Date -> scrapVal

        // 1. Process Production (Good Qty)
        // Col: 2=Model, 3=Line, 5=Qty
        data.production.forEach(row => {
            let model = row[2];
            let line = row[3];
            let qty = parseFloat(row[5]) || 0;
            let price = models[model] || 0;
            let val = qty * price;

            // Line Logic
            if(!lineData[line]) lineData[line] = { prodVal: 0, scrapVal: 0, cat: {} };
            lineData[line].prodVal += val;

            // Model Logic
            if(!modelStats[model]) modelStats[model] = { prodVal: 0, scrapVal: 0 };
            modelStats[model].prodVal += val;
        });

        // 2. Process Scrap (Bad Qty)
        // Col: 3=Line, 7=Category, 8=Desc, 9=Model, 11=Price, 12=Qty
        data.scrap.forEach(row => {
            let line = row[3];
            let cat = row[7] || "Other";
            let desc = row[8];
            let model = row[9];
            let price = parseFloat(row[11]) || 0;
            let qty = parseFloat(row[12]) || 0;
            let val = qty * price;
            let date = new Date(row[1]).toLocaleDateString();

            // Line Logic
            if(!lineData[line]) lineData[line] = { prodVal: 0, scrapVal: 0, cat: {} };
            lineData[line].scrapVal += val;
            if(!lineData[line].cat[cat]) lineData[line].cat[cat] = 0;
            lineData[line].cat[cat] += val;

            // Model Logic
            if(!modelStats[model]) modelStats[model] = { prodVal: 0, scrapVal: 0 };
            modelStats[model].scrapVal += val;

            // Part Logic
            if(!partStats[desc]) partStats[desc] = 0;
            partStats[desc] += val;

            // Date Logic
            if(!dateStats[date]) dateStats[date] = 0;
            dateStats[date] += val;
        });

        // 3. RENDER CHARTS
        renderLineChart(lineData);
        renderModelChart(modelStats);
        renderPartChart(partStats);
        renderDateChart(dateStats);

        // Populate Model Dropdown for Entry Form
        const sel = document.getElementById('pModel');
        sel.innerHTML = "";
        Object.keys(models).forEach(m => {
            let opt = document.createElement('option');
            opt.value = m; opt.text = m;
            sel.add(opt);
        });
    }

    // --- CHART RENDERING ---
    let chartInstance = {};

    function renderLineChart(data) {
        // Prepare arrays
        let labels = Object.keys(data).sort();
        let rates = [];
        let html = "";
        
        labels.forEach(line => {
            let pVal = data[line].prodVal;
            let sVal = data[line].scrapVal;
            let rate = pVal > 0 ? (sVal / pVal) * 100 : 0;
            rates.push(rate.toFixed(2));

            // Table Row
            let cat = data[line].cat;
            html += `<tr>
                <td>${line}</td>
                <td>${pVal.toFixed(0)}</td>
                <td>${sVal.toFixed(0)}</td>
                <td class="${rate > 2 ? 'text-danger fw-bold' : 'text-success'}">${rate.toFixed(2)}%</td>
                <td>${(cat['PCBA'] || 0).toFixed(0)}</td>
                <td>${(cat['Speaker'] || 0).toFixed(0)}</td>
                <td>${(cat['Battery'] || 0).toFixed(0)}</td>
                <td>${(cat['Magnet'] || 0).toFixed(0)}</td>
                <td>${(cat['Other'] || cat['Other Parts'] || 0).toFixed(0)}</td>
            </tr>`;
        });

        document.querySelector('#lineTable tbody').innerHTML = html;

        // Chart
        const ctx = document.getElementById('lineChart');
        if(chartInstance.line) chartInstance.line.destroy();
        chartInstance.line = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Scrap Rate %', data: rates, backgroundColor: '#4e73df' }]
            }
        });
    }

    function renderModelChart(data) {
        let labels = Object.keys(data);
        let sVals = labels.map(k => data[k].scrapVal);
        
        const ctx = document.getElementById('modelChart');
        if(chartInstance.model) chartInstance.model.destroy();
        chartInstance.model = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: sVals, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'] }] }
        });
    }

    function renderPartChart(data) {
        // Sort top 5
        let sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 5);
        
        const ctx = document.getElementById('partChart');
        if(chartInstance.part) chartInstance.part.destroy();
        chartInstance.part = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(i => i[0].substring(0, 15)+'...'),
                datasets: [{ label: 'Loss Value', data: sorted.map(i => i[1]), backgroundColor: '#e74a3b' }]
            },
            options: { indexAxis: 'y' }
        });
    }

    function renderDateChart(data) {
        let sortedDates = Object.keys(data).sort((a,b) => new Date(a) - new Date(b));
        
        const ctx = document.getElementById('dateChart');
        if(chartInstance.date) chartInstance.date.destroy();
        chartInstance.date = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [{ label: 'Daily Scrap Value', data: sortedDates.map(d => data[d]), borderColor: '#f6c23e', fill: false }]
            }
        });
    }

    // --- 3. SAVE FUNCTIONS (Production & Bulk) ---
    function saveProduction() {
        const payload = {
            action: 'production',
            date: document.getElementById('pDate').value,
            model: document.getElementById('pModel').value,
            lineNo: document.getElementById('pLine').value,
            output: document.getElementById('pOut').value
        };
        
        sendData(payload);
    }

    function processExcel() {
        const file = document.getElementById('uploadFile').files[0];
        if(!file) return alert("Select file");
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const workbook = XLSX.read(e.target.result, {type: 'array', cellDates: true});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            sendData({ action: 'bulk_scrap', rows: json });
        };
        reader.readAsArrayBuffer(file);
    }

    function sendData(payload) {
        document.getElementById('loading').style.display = 'block';
        fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors', // Important for Apps Script
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
        }).then(() => {
            document.getElementById('loading').style.display = 'none';
            Swal.fire("Success", "Data sent to Google Sheet", "success");
            if(payload.action === 'production') document.getElementById('prodForm').reset();
        });
    }

    // Initial Load
    window.onload = fetchDashboardData;
</script>

</body>
</html>
