<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Quality Dashboard Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --success: #10b981; --danger: #ef4444; }
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: var(--primary); color: white; padding: 10px 30px; border-bottom: 3px solid var(--accent); }
        .logo { height: 40px; background: white; padding: 5px; border-radius: 5px; }
        .stat-card { background: white; border-radius: 12px; padding: 15px; border-top: 5px solid var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.08); text-align: center; }
        .stat-label { font-size: 12px; color: #64748b; font-weight: 700; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: 800; color: #1e293b; }
        .chart-container { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); height: 320px; margin-bottom: 20px; }
        .card-table { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .btn-main { border-radius: 6px; font-weight: 600; padding: 6px 15px; }
        #fileInput { display: none; }
        .table th { background: #f8fafc; font-size: 11px; }
        .preview-badge { background: #ffc107; color: #000; padding: 4px 12px; border-radius: 4px; font-size: 12px; display: none; }
    </style>
</head>
<body>

<nav class="navbar d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <h5 class="mb-0">QUALITY <span style="color: #38bdf8;">DASHBOARD</span></h5>
    </div>
    <div class="d-flex gap-2">
        <div id="pTag" class="preview-badge mt-1"><i class="bi bi-eye"></i> PREVIEW MODE</div>
        <label for="fileInput" class="btn btn-outline-light btn-main"><i class="bi bi-upload"></i> Upload</label>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
        <button id="saveBtn" class="btn btn-success btn-main" onclick="saveData()" style="display:none;">Save</button>
        <button class="btn btn-danger btn-main" onclick="exportToPPT()">PPT</button>
    </div>
</nav>

<div class="container-fluid mt-3 px-4">
    <!-- Filters -->
    <div class="d-flex gap-3 mb-3 align-items-center bg-white p-2 rounded shadow-sm">
        <span class="fw-bold ms-2">Filters:</span>
        <select id="monthFilter" class="form-select form-select-sm w-auto" onchange="renderFromStorage()">
            <option value="All">All Months</option>
            <option value="0">January</option><option value="1">February</option><option value="2">March</option>
            <option value="3">April</option><option value="4">May</option><option value="5">June</option>
            <option value="6">July</option><option value="7">August</option><option value="8">September</option>
            <option value="9">October</option><option value="10" selected>November</option><option value="11">December</option>
        </select>
        <select id="yearFilter" class="form-select form-select-sm w-auto" onchange="renderFromStorage()">
            <option value="2025" selected>2025</option>
            <option value="2024">2024</option>
        </select>
        <button class="btn btn-sm text-danger ms-auto" onclick="clearDB()">Delete All Saved Data</button>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
        <div class="col-md-3"><div class="stat-card"><span class="stat-label">FPY %</span><span class="stat-value text-primary" id="k-fpy">0%</span></div></div>
        <div class="col-md-3"><div class="stat-card" style="border-top-color:#ef4444"><span class="stat-label">Rejection %</span><span class="stat-value text-danger" id="k-rej">0%</span></div></div>
        <div class="col-md-3"><div class="stat-card" style="border-top-color:#10b981"><span class="stat-label">Total Input</span><span class="stat-value" id="k-in">0</span></div></div>
        <div class="col-md-3"><div class="stat-card" style="border-top-color:#f59e0b"><span class="stat-label">Total Defects</span><span class="stat-value" id="k-def">0</span></div></div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-3">
        <div class="col-md-7"><div class="chart-container"><h6>Top 5 Defects</h6><canvas id="pChart"></canvas></div></div>
        <div class="col-md-5"><div class="chart-container"><h6>Category Contribution</h6><canvas id="cChart"></canvas></div></div>
    </div>

    <!-- Line Wise Table -->
    <div class="card-table">
        <h6 class="fw-bold mb-3 text-primary">Line-Wise Performance</h6>
        <table class="table table-sm table-hover border">
            <thead>
                <tr>
                    <th>Line No</th><th>Input</th><th>Defects</th><th>FPY %</th><th>Rej %</th><th>Top Defect</th>
                </tr>
            </thead>
            <tbody id="lineTable"></tbody>
        </table>
    </div>

    <!-- Action Plan -->
    <div class="card-table">
        <h6 class="fw-bold mb-3 text-danger">Defect Action Plan</h6>
        <table class="table table-bordered table-sm">
            <thead class="table-light">
                <tr><th>Defect</th><th>Qty</th><th>Root Cause</th><th>Corrective Action</th><th>Status</th></tr>
            </thead>
            <tbody id="planTable"></tbody>
        </table>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('califonix_v4')) || [];
    let uploadData = [];
    let cp, cc;

    window.onload = () => { if(db.length > 0) renderFromStorage(); };

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const wb = XLSX.read(evt.target.result, { type: 'binary', cellDates: true });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            // Smart Cleaning: Convert all headers to lowercase and trim spaces
            uploadData = data.map(row => {
                let cleanRow = {};
                for (let key in row) {
                    let k = key.trim().toLowerCase().replace(/\s+/g, '');
                    cleanRow[k] = row[key];
                }
                return cleanRow;
            });

            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('pTag').style.display = 'block';
            process(uploadData);
        };
        reader.readAsBinaryString(file);
    });

    function saveData() {
        db = [...uploadData, ...db];
        localStorage.setItem('califonix_v4', JSON.stringify(db));
        uploadData = [];
        document.getElementById('saveBtn').style.display = 'none';
        document.getElementById('pTag').style.display = 'none';
        renderFromStorage();
        alert("Data Saved!");
    }

    function renderFromStorage() {
        const m = document.getElementById('monthFilter').value;
        const y = document.getElementById('yearFilter').value;
        const filtered = db.filter(r => {
            const d = new Date(r.date);
            return (m === "All" || d.getMonth() == m) && d.getFullYear() == y;
        });
        process(filtered);
    }

    function process(data) {
        let tIn = 0, tDef = 0, defs = {}, cats = {}, lines = {};

        data.forEach(r => {
            // Field mapping based on cleaned keys
            let qty = parseInt(r.defectqty || r["defectqty"] || 0);
            let inp = parseInt(r.input || r["input"] || 0);
            let line = r.line || "N/A";
            let cat = r.category || "Other";
            let defName = r.defect || "None";

            tIn += inp;
            tDef += qty;

            if(defName !== "None") defs[defName] = (defs[defName] || 0) + qty;
            cats[cat] = (cats[cat] || 0) + qty;

            if(!lines[line]) lines[line] = { i:0, d:0, ds:{} };
            lines[line].i += inp;
            lines[line].d += qty;
            if(defName !== "None") lines[line].ds[defName] = (lines[line].ds[defName] || 0) + qty;
        });

        // Update KPIs
        document.getElementById('k-in').innerText = tIn.toLocaleString();
        document.getElementById('k-def').innerText = tDef.toLocaleString();
        document.getElementById('k-fpy').innerText = tIn > 0 ? (((tIn-tDef)/tIn)*100).toFixed(2)+"%" : "0%";
        document.getElementById('k-rej').innerText = tIn > 0 ? ((tDef/tIn)*100).toFixed(2)+"%" : "0%";

        updateCharts(defs, cats);
        updateTables(lines, defs);
    }

    function updateCharts(defs, cats) {
        if(cp) cp.destroy(); if(cc) cc.destroy();
        const top5 = Object.entries(defs).sort((a,b)=>b[1]-a[1]).slice(0,5);
        
        cp = new Chart(document.getElementById('pChart'), {
            type: 'bar',
            data: { labels: top5.map(x=>x[0]), datasets: [{ label:'Qty', data: top5.map(x=>x[1]), backgroundColor:'#2563eb' }]},
            options: { responsive: true, maintainAspectRatio: false }
        });

        cc = new Chart(document.getElementById('cChart'), {
            type: 'pie',
            data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#10b981','#f59e0b','#ef4444','#6366f1','#8b5cf6'] }]},
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function updateTables(lines, defs) {
        const lt = document.getElementById('lineTable');
        lt.innerHTML = '';
        Object.keys(lines).sort().forEach(l => {
            const row = lines[l];
            const fpy = row.i > 0 ? (((row.i - row.d)/row.i)*100).toFixed(2) : "0.00";
            const top = Object.entries(row.ds).sort((a,b)=>b[1]-a[1])[0]?.[0] || "-";
            lt.innerHTML += `<tr><td><b>${l}</b></td><td>${row.i}</td><td>${row.d}</td><td class="text-primary">${fpy}%</td><td class="text-danger">${(row.i>0?(row.d/row.i*100).toFixed(2):0)}%</td><td>${top}</td></tr>`;
        });

        const pt = document.getElementById('planTable');
        pt.innerHTML = '';
        Object.entries(defs).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(d => {
            pt.innerHTML += `<tr><td><b>${d[0]}</b></td><td>${d[1]}</td><td><input class="form-control form-control-sm"></td><td><input class="form-control form-control-sm"></td><td><span class="badge bg-warning">Open</span></td></tr>`;
        });
    }

    function clearDB() { if(confirm("Delete All?")) { localStorage.removeItem('califonix_v4'); location.reload(); } }

    function exportToPPT() {
        let pptx = new PptxGenJS();
        let s = pptx.addSlide();
        s.addText("QUALITY REPORT", { x:1, y:1, fontSize:24, bold:true });
        s.addText("FPY: " + document.getElementById('k-fpy').innerText, { x:1, y:2 });
        pptx.writeFile({ fileName: "Report.pptx" });
    }
</script>
</body>
</html>
