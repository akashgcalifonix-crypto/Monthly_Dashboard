<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality & Scrap Master Dashboard</title>
    
    <!-- CSS & JS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { background-color: var(--bg); font-family: 'Poppins', sans-serif; font-size: 0.9rem; }
        
        /* Sidebar */
        .sidebar { min-height: 100vh; background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); color: #fff; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 12px 20px; cursor: pointer; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: #fff; border-left-color: var(--accent); }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sub-menu { padding-left: 20px; font-size: 0.85em; background: rgba(0,0,0,0.1); }

        /* Scorecard (Top Header) */
        .scorecard-container { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .score-box { text-align: center; padding: 10px; border-right: 1px solid #eee; }
        .score-box:last-child { border-right: none; }
        .score-val { font-weight: 700; font-size: 1.1rem; color: #2c3e50; }
        .score-label { font-size: 0.75rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Controls */
        .controls-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
        .toggle-btn { cursor: pointer; padding: 5px 15px; border: 1px solid var(--accent); border-radius: 20px; color: var(--accent); transition: 0.3s; }
        .toggle-btn.active { background: var(--accent); color: white; }

        /* Cards & Tables */
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .card-header { background: white; border-bottom: 1px solid #f0f0f0; font-weight: 700; color: #2c3e50; }
        .table thead { background-color: #2c3e50; color: white; }
        .table th, .table td { vertical-align: middle; padding: 8px; font-size: 0.85rem; }
        
        /* Utility */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .badge-lg { font-size: 1rem; padding: 8px 12px; }
    </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="mt-3 text-secondary">Analyzing Quality Data...</h5>
</div>

<div class="container-fluid">
    <div class="row">
        
        <!-- SIDEBAR -->
        <div class="col-md-2 sidebar p-0">
            <div class="sidebar-header">
                <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="max-height: 50px; background: white; padding: 5px; border-radius: 5px;">
                <h6 class="mt-3 mb-0">Quality Control</h6>
            </div>
            <nav class="nav flex-column mt-2">
                <a class="nav-link active" onclick="switchSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i> Main Dashboard</a>
                
                <div class="nav-link text-uppercase small text-muted mt-2">Component Analysis</div>
                <a class="nav-link" onclick="switchSection('pcba')"><i class="fas fa-microchip me-2"></i> PCBA Report</a>
                <a class="nav-link" onclick="switchSection('speaker')"><i class="fas fa-volume-up me-2"></i> Speaker Report</a>
                <a class="nav-link" onclick="switchSection('battery')"><i class="fas fa-battery-full me-2"></i> Battery Report</a>

                <div class="nav-link text-uppercase small text-muted mt-2">Data Entry</div>
                <a class="nav-link" onclick="switchSection('production')"><i class="fas fa-edit me-2"></i> Production Entry</a>
                <a class="nav-link" onclick="switchSection('upload')"><i class="fas fa-file-upload me-2"></i> Bulk Upload</a>
            </nav>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-10 p-4">

            <!-- SECTION: DASHBOARD -->
            <div id="dashboard-section" class="content-section">
                
                <!-- 1. SCORECARD (TOP METRICS) -->
                <div class="scorecard-container">
                    <div class="row g-0">
                        <div class="col score-box">
                            <div class="score-val" id="sc-total-out">0</div>
                            <div class="score-label">Total Output</div>
                        </div>
                        <div class="col score-box">
                            <div class="score-val text-primary" id="sc-total-val">₹0</div>
                            <div class="score-label">Total Value</div>
                        </div>
                        <div class="col score-box">
                            <div class="score-val text-warning" id="sc-proc-scrap">₹0</div>
                            <div class="score-label">Process Scrap</div>
                        </div>
                        <div class="col score-box">
                            <div class="score-val text-info" id="sc-rmd-scrap">₹0</div>
                            <div class="score-label">RMD Scrap</div>
                        </div>
                        <div class="col score-box">
                            <div class="score-val text-danger" id="sc-tot-scrap">₹0</div>
                            <div class="score-label">Total Scrap</div>
                        </div>
                        <div class="col score-box" style="background: #fff3cd;">
                            <div class="score-val text-dark" id="sc-proc-rate">0%</div>
                            <div class="score-label">Process Rate</div>
                        </div>
                        <div class="col score-box" style="background: #cff4fc;">
                            <div class="score-val text-dark" id="sc-rmd-rate">0%</div>
                            <div class="score-label">RMD Rate</div>
                        </div>
                        <div class="col score-box" style="background: #2c3e50;">
                            <div class="score-val text-white" id="sc-ovr-rate">0%</div>
                            <div class="score-label text-white-50">Overall Rate</div>
                        </div>
                    </div>
                </div>

                <!-- 2. CONTROLS -->
                <div class="controls-bar">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-dark btn-sm active" id="btn-overall" onclick="setLineType('OVERALL')">Overall</button>
                        <button class="btn btn-outline-dark btn-sm" id="btn-earbuds" onclick="setLineType('EARBUDS')">Earbuds</button>
                        <button class="btn btn-outline-dark btn-sm" id="btn-case" onclick="setLineType('CASE')">Charging Case</button>
                    </div>

                    <div class="d-flex gap-3 align-items-center">
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary active" id="view-val" onclick="toggleViewMode('VALUE')">₹ Value</button>
                            <button type="button" class="btn btn-outline-primary" id="view-qty" onclick="toggleViewMode('QTY')">123 Qty</button>
                        </div>
                        
                        <select id="sortFilter" class="form-select form-select-sm" style="width: 150px;" onchange="processAndRender()">
                            <option value="DESC">Rate: High to Low</option>
                            <option value="ASC">Rate: Low to High</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="loadData()"><i class="fas fa-sync"></i> Refresh</button>
                    </div>
                </div>

                <!-- 3. MAIN LINE TABLE -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span id="chartTitle">Line Wise Analysis</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover text-center align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th rowspan="2">Line No</th>
                                        <th rowspan="2">Prod Value</th>
                                        <th rowspan="2">Scrap Value</th>
                                        <th rowspan="2">Rate %</th>
                                        <th colspan="5" id="breakdown-header">Defect Breakdown (Value ₹)</th>
                                    </tr>
                                    <tr>
                                        <th>PCBA</th><th>Speaker</th><th>Battery</th><th>Magnet</th><th>Other</th>
                                    </tr>
                                </thead>
                                <tbody id="lineTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTIONS: COMPONENT ANALYSIS (PCBA, SPEAKER, BATTERY) -->
            <div id="pcba-section" class="content-section" style="display:none;"></div>
            <div id="speaker-section" class="content-section" style="display:none;"></div>
            <div id="battery-section" class="content-section" style="display:none;"></div>

            <!-- SECTIONS: ENTRY & UPLOAD -->
            <div id="production-section" class="content-section" style="display:none;">
                <h3>Production Entry</h3>
                <div class="card p-4 shadow-sm" style="max-width: 600px;">
                    <form id="prodForm">
                        <div class="mb-3"><label>Date</label><input type="date" id="pDate" class="form-control" required></div>
                        <div class="mb-3"><label>Model</label><select id="pModel" class="form-select"></select></div>
                        <div class="mb-3">
                            <label>Line No</label>
                            <input type="text" id="pLine" class="form-control" placeholder="e.g. L-11 or L-11C" required>
                            <small class="text-muted">Enter Line No (L-1, L-1C are linked automatically)</small>
                        </div>
                        <div class="mb-3"><label>Output Qty</label><input type="number" id="pOut" class="form-control" required></div>
                        <button type="button" class="btn btn-success w-100" onclick="saveProduction()">Save Data</button>
                    </form>
                </div>
            </div>

            <div id="upload-section" class="content-section" style="display:none;">
                <h3>Bulk Scrap Upload</h3>
                <div class="card p-5 text-center">
                    <div class="border dashed p-5 bg-white rounded">
                        <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                        <h5>Upload Excel</h5>
                        <input type="file" id="uploadFile" class="form-control w-50 mx-auto mb-3" accept=".xlsx">
                        <button class="btn btn-primary" onclick="uploadExcel()">Process & Upload</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // ********************************************************
    // PASTE YOUR GOOGLE APPS SCRIPT URL HERE
    // ********************************************************
    const API_URL = "https://script.google.com/macros/s/AKfycbyD1Y63nykh84uHHhUWxkfucyVi6crvEdY4KEXVzKg3FgQCGRj55ljmjTZfGyZFcCbUyg/exec"; 

    // STATE
    let rawData = { production: [], scrap: [], models: [] };
    let modelPrices = {};
    let currentLineType = 'OVERALL'; // OVERALL, EARBUDS, CASE
    let viewMode = 'VALUE'; // VALUE, QTY

    window.onload = loadData;

    function switchSection(id) {
        document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
        
        // Handle Component Reports specifically
        if(['pcba','speaker','battery'].includes(id)) {
            renderComponentReport(id);
            document.getElementById(id+'-section').style.display = 'block';
        } else {
            document.getElementById(id+'-section').style.display = 'block';
        }
        
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // --- DATA LOADING ---
    async function loadData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            let res = await fetch(API_URL);
            let json = await res.json();
            rawData = json;
            
            // Build Model Prices
            if(json.models) {
                let pSelect = document.getElementById('pModel');
                pSelect.innerHTML = "";
                json.models.slice(1).forEach(r => {
                    modelPrices[r[0]] = parseFloat(r[1]) || 0;
                    pSelect.add(new Option(r[0], r[0]));
                });
            }
            processAndRender();
        } catch(e) { Swal.fire("Error", "Failed to load data", "error"); }
        document.getElementById('loader').style.display = 'none';
    }

    // --- MAIN PROCESSING LOGIC ---
    function processAndRender() {
        // 1. Calculate Unified Production (Base Line ID)
        let prodMap = {}; // Key: "1", "2", "3" (Base Number) -> { val: 0, qty: 0 }
        
        if(rawData.production.length > 0) {
            let h = rawData.production[0].map(x=>x.toLowerCase());
            let iLine = h.findIndex(x=>x.includes('line'));
            let iMod = h.indexOf('model') > -1 ? h.indexOf('model') : 2;
            let iOut = h.indexOf('output') > -1 ? h.indexOf('output') : h.length-1;

            rawData.production.slice(1).forEach(row => {
                let lineRaw = (row[iLine] || "").toString();
                let baseLine = normalizeLine(lineRaw); // "L-11C" -> "11"
                let model = row[iMod];
                let qty = parseFloat(row[iOut]) || 0;
                let price = modelPrices[model] || 0;
                
                if(!prodMap[baseLine]) prodMap[baseLine] = { val: 0, qty: 0 };
                prodMap[baseLine].val += (qty * price); // Full Price
                prodMap[baseLine].qty += qty;
            });
        }

        // 2. Calculate Scrap (Earbud vs Case vs Overall)
        let scrapMap = {}; 
        let scorecard = { out:0, prodVal:0, procScrap:0, rmdScrap:0, totScrap:0 };

        // Pre-fill scorecard production
        Object.values(prodMap).forEach(p => {
            scorecard.out += p.qty;
            scorecard.prodVal += p.val;
        });

        if(rawData.scrap.length > 0) {
            let h = rawData.scrap[0].map(x=>x.toString().toLowerCase());
            let iLine = h.findIndex(x=>x.includes('line'));
            let iStore = h.findIndex(x=>x.includes('storage'));
            let iCat = h.indexOf('category');
            let iDesc = h.indexOf('material description') > -1 ? h.indexOf('material description') : h.indexOf('material');
            let iPrice = h.indexOf('price');
            let iQty = h.findIndex(x=>x.includes('reject') || x.includes('qty'));

            rawData.scrap.slice(1).forEach(row => {
                let lineRaw = (row[iLine] || "").toString().toUpperCase();
                let baseLine = normalizeLine(lineRaw);
                let isCase = lineRaw.includes('C'); // Identification
                
                let storeVal = (row[iStore] || "").toString().toLowerCase();
                let isProcess = storeVal.includes('6003') || storeVal.includes('process');
                let isRMD = storeVal.includes('6002') || storeVal.includes('rmd');

                let price = parseFloat(row[iPrice]) || 0;
                let qty = parseFloat(row[iQty]) || 0;
                let val = price * qty;
                if(val === 0) return;

                // Scorecard Calculation
                scorecard.totScrap += val;
                if(isProcess) scorecard.procScrap += val;
                if(isRMD) scorecard.rmdScrap += val;

                // Filter for Table View
                if(currentLineType === 'EARBUDS' && isCase) return;
                if(currentLineType === 'CASE' && !isCase) return;

                let cat = row[iCat] || "Other Parts";
                
                // Init Line Data
                if(!scrapMap[baseLine]) scrapMap[baseLine] = { total:0, cats:{}, catsQty:{} };
                
                scrapMap[baseLine].total += val;
                
                // Category Breakdown (Value)
                if(!scrapMap[baseLine].cats[cat]) scrapMap[baseLine].cats[cat] = 0;
                scrapMap[baseLine].cats[cat] += val;

                // Category Breakdown (Qty)
                if(!scrapMap[baseLine].catsQty[cat]) scrapMap[baseLine].catsQty[cat] = 0;
                scrapMap[baseLine].catsQty[cat] += qty;
            });
        }

        renderScorecard(scorecard);
        renderTable(prodMap, scrapMap);
    }

    function normalizeLine(str) {
        // Extract numbers only to link L-1, L-01, L-1C -> "1"
        return str.replace(/[^0-9]/g, '');
    }

    function renderScorecard(s) {
        document.getElementById('sc-total-out').innerText = s.out.toLocaleString();
        document.getElementById('sc-total-val').innerText = "₹" + (s.prodVal/100000).toFixed(2) + " L";
        document.getElementById('sc-proc-scrap').innerText = "₹" + s.procScrap.toLocaleString();
        document.getElementById('sc-rmd-scrap').innerText = "₹" + s.rmdScrap.toLocaleString();
        document.getElementById('sc-tot-scrap').innerText = "₹" + s.totScrap.toLocaleString();
        
        let pRate = s.prodVal > 0 ? (s.procScrap/s.prodVal)*100 : 0;
        let rRate = s.prodVal > 0 ? (s.rmdScrap/s.prodVal)*100 : 0;
        let oRate = s.prodVal > 0 ? (s.totScrap/s.prodVal)*100 : 0;

        document.getElementById('sc-proc-rate').innerText = pRate.toFixed(2) + "%";
        document.getElementById('sc-rmd-rate').innerText = rRate.toFixed(2) + "%";
        document.getElementById('sc-ovr-rate').innerText = oRate.toFixed(2) + "%";
    }

    function renderTable(prodMap, scrapMap) {
        const tbody = document.getElementById('lineTableBody');
        tbody.innerHTML = "";
        
        // Get all base lines
        let allLines = new Set([...Object.keys(prodMap), ...Object.keys(scrapMap)]);
        let lineArray = [];

        allLines.forEach(ln => {
            let pVal = prodMap[ln] ? prodMap[ln].val : 0;
            let sVal = scrapMap[ln] ? scrapMap[ln].total : 0;
            let rate = pVal > 0 ? (sVal/pVal)*100 : 0;
            let cats = scrapMap[ln] ? scrapMap[ln].cats : {};
            let catsQty = scrapMap[ln] ? scrapMap[ln].catsQty : {};
            
            lineArray.push({ ln, pVal, sVal, rate, cats, catsQty });
        });

        // Sort
        let sortOrd = document.getElementById('sortFilter').value;
        lineArray.sort((a,b) => sortOrd === 'DESC' ? b.rate - a.rate : a.rate - b.rate);

        lineArray.forEach(item => {
            let src = viewMode === 'VALUE' ? item.cats : item.catsQty;
            let sym = viewMode === 'VALUE' ? '₹' : '';
            
            let cPCBA = (src['PCBA']||0);
            let cSpk = (src['Speaker']||0);
            let cBat = (src['Battery']||0);
            let cMag = (src['Magnet']||0);
            let cOth = (src['Other Parts']||src['Other']||0);

            let row = `<tr>
                <td class="fw-bold">Line ${item.ln}</td>
                <td>₹${item.pVal.toLocaleString()}</td>
                <td class="text-danger fw-bold">₹${item.sVal.toLocaleString()}</td>
                <td><span class="badge ${item.rate>2?'bg-danger':'bg-success'} badge-lg">${item.rate.toFixed(2)}%</span></td>
                <td>${sym}${cPCBA.toLocaleString()}</td>
                <td>${sym}${cSpk.toLocaleString()}</td>
                <td>${sym}${cBat.toLocaleString()}</td>
                <td>${sym}${cMag.toLocaleString()}</td>
                <td>${sym}${cOth.toLocaleString()}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // --- COMPONENT REPORTS (New Feature) ---
    function renderComponentReport(compName) {
        let title = compName.toUpperCase() + " Analysis";
        let targetDiv = document.getElementById(compName + '-section');
        
        // Filter Scrap Data for this Component
        let filtered = [];
        if(rawData.scrap.length > 0) {
            let h = rawData.scrap[0].map(x=>x.toLowerCase());
            let iDate = 0; 
            let iLine = h.findIndex(x=>x.includes('line'));
            let iCat = h.indexOf('category');
            let iPrice = h.indexOf('price');
            let iQty = h.findIndex(x=>x.includes('reject')||x.includes('qty'));

            rawData.scrap.slice(1).forEach(row => {
                let cat = (row[iCat]||"").toLowerCase();
                if(cat.includes(compName)) {
                    filtered.push({
                        date: new Date(row[iDate]).toLocaleDateString(),
                        line: row[iLine],
                        price: row[iPrice],
                        qty: row[iQty],
                        val: row[iPrice]*row[iQty]
                    });
                }
            });
        }

        // Generate HTML
        let html = `<h3><i class="fas fa-search me-2"></i> ${title}</h3>
                    <div class="card mt-3">
                        <div class="card-body">
                            <table class="table table-striped table-sm text-center">
                                <thead class="table-dark">
                                    <tr><th>Date</th><th>Line</th><th>Reject Qty</th><th>Loss Value (₹)</th></tr>
                                </thead>
                                <tbody>`;
        
        if(filtered.length === 0) {
            html += `<tr><td colspan="4">No data found for ${title}</td></tr>`;
        } else {
            // Sort by Date Desc
            filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
            filtered.forEach(f => {
                html += `<tr>
                    <td>${f.date}</td>
                    <td>${f.line}</td>
                    <td>${f.qty}</td>
                    <td class="fw-bold text-danger">${f.val.toLocaleString()}</td>
                </tr>`;
            });
        }
        
        html += `</tbody></table></div></div>`;
        targetDiv.innerHTML = html;
    }

    // --- UTILS ---
    function setLineType(type) {
        currentLineType = type;
        document.querySelectorAll('.controls-bar button').forEach(b => b.classList.remove('active'));
        if(type==='OVERALL') document.getElementById('btn-overall').classList.add('active');
        if(type==='EARBUDS') document.getElementById('btn-earbuds').classList.add('active');
        if(type==='CASE') document.getElementById('btn-case').classList.add('active');
        
        processAndRender();
    }

    function toggleViewMode(mode) {
        viewMode = mode;
        document.getElementById('view-val').classList.toggle('active', mode==='VALUE');
        document.getElementById('view-qty').classList.toggle('active', mode==='QTY');
        document.getElementById('breakdown-header').innerText = mode==='VALUE' ? "Defect Breakdown (Value ₹)" : "Defect Breakdown (Qty)";
        processAndRender();
    }

    // --- SAVE / UPLOAD (Standard) ---
    function saveProduction() {
        sendData({
            action: 'production',
            date: document.getElementById('pDate').value,
            model: document.getElementById('pModel').value,
            lineNo: document.getElementById('pLine').value,
            output: document.getElementById('pOut').value
        });
    }

    function uploadExcel() {
        let file = document.getElementById('uploadFile').files[0];
        if(!file) return Swal.fire("Error","Select file","warning");
        let r = new FileReader();
        r.onload = e => {
            let wb = XLSX.read(e.target.result, {type:'array'});
            let json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            sendData({action:'bulk_scrap', rows:json});
        };
        r.readAsArrayBuffer(file);
    }

    function sendData(payload) {
        document.getElementById('loader').style.display = 'flex';
        fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload)})
        .then(() => {
            document.getElementById('loader').style.display = 'none';
            Swal.fire("Success","Data Saved","success");
            if(payload.action==='production') document.getElementById('prodForm').reset();
        });
    }
</script>

</body>
</html>
