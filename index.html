<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality & Scrap Dashboard</title>
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Poppins', sans-serif; }
        
        /* Sidebar */
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #2c3e50 0%, #4ca1af 100%);
            color: #fff;
        }
        .nav-link { color: rgba(255,255,255,0.85); padding: 15px; cursor: pointer; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.2); color: #fff; font-weight: 600; border-radius: 0 25px 25px 0; }
        
        /* Dashboard Header */
        .dash-header { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* Tabs for Earbuds/Case */
        .type-tabs .nav-link { 
            color: #555; font-weight: 600; border: 1px solid #ddd; margin-right: 5px; border-radius: 5px; 
        }
        .type-tabs .nav-link.active { 
            background-color: #4ca1af; color: white; border-color: #4ca1af; 
        }

        /* Cards & Charts */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { background: white; border-bottom: 1px solid #f0f0f0; font-weight: 700; color: #2c3e50; }
        
        /* Table */
        .table thead { background-color: #2c3e50; color: white; }
        .badge-rate { font-size: 0.9em; padding: 6px 10px; }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
    <div class="spinner-border text-info" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="mt-3 text-secondary">Loading Quality Data...</h5>
</div>

<div class="container-fluid">
    <div class="row">
        
        <!-- SIDEBAR -->
        <div class="col-md-2 sidebar p-0">
            <div class="p-4 text-center">
                <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="max-height: 60px; background: white; padding: 5px; border-radius: 5px;">
                <h6 class="mt-3">Quality Control</h6>
            </div>
            <nav class="nav flex-column">
                <a class="nav-link active" onclick="switchSection('dashboard')"><i class="fas fa-chart-line me-2"></i> Dashboard</a>
                <a class="nav-link" onclick="switchSection('production')"><i class="fas fa-clipboard-check me-2"></i> Production Entry</a>
                <a class="nav-link" onclick="switchSection('upload')"><i class="fas fa-cloud-upload-alt me-2"></i> Bulk Upload</a>
            </nav>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-10 p-4">

            <!-- SECTION: DASHBOARD -->
            <div id="dashboard-section">
                
                <!-- Controls Header -->
                <div class="dash-header d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h3 class="m-0 text-dark">Review Dashboard</h3>
                        <small class="text-muted">Overview of Production vs Scrap</small>
                    </div>
                    
                    <div class="d-flex gap-3 align-items-center">
                        <!-- STORAGE FILTER -->
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="fas fa-filter text-primary"></i></span>
                            <select id="storageFilter" class="form-select" onchange="processAndRender()">
                                <option value="ALL" selected>All Storage Locations</option>
                                <option value="PROCESS">Process (6003)</option>
                                <option value="RMD">RMD (6002)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="loadData()"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>

                <!-- Type Tabs (Earbuds vs Case) -->
                <ul class="nav nav-pills type-tabs mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" onclick="setLineType('EARBUDS')">
                            <i class="fas fa-headphones me-2"></i> Earbuds Lines
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" onclick="setLineType('CASE')">
                            <i class="fas fa-battery-half me-2"></i> Charging Case (C)
                        </button>
                    </li>
                </ul>

                <!-- Charts Area -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span id="chartTitle">Line Wise Analysis (Earbuds)</span>
                    </div>
                    <div class="card-body">
                        <canvas id="lineChart" style="max-height: 350px;"></canvas>
                        
                        <!-- Data Table -->
                        <div class="table-responsive mt-4">
                            <table class="table table-bordered table-hover text-center align-middle text-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Line No</th>
                                        <th>Prod Value (₹)</th>
                                        <th>Scrap Value (₹)</th>
                                        <th>Scrap Rate %</th>
                                        <th>PCBA</th>
                                        <th>Speaker</th>
                                        <th>Battery</th>
                                        <th>Magnet</th>
                                        <th>Other</th>
                                    </tr>
                                </thead>
                                <tbody id="lineTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">Model Performance</div>
                            <div class="card-body"><canvas id="modelChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">Top 5 Defective Parts</div>
                            <div class="card-body"><canvas id="partChart"></canvas></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- SECTION: PRODUCTION -->
            <div id="production-section" style="display:none;">
                <h3 class="mb-3">Production Entry</h3>
                <div class="card p-4" style="max-width: 600px;">
                    <form id="prodForm">
                        <div class="mb-3">
                            <label>Date</label>
                            <input type="date" id="pDate" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Model</label>
                            <select id="pModel" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label>Line No</label>
                            <input type="text" id="pLine" class="form-control" placeholder="e.g. L-11 or L-11C" required>
                            <small class="text-muted">Add 'C' at end for Charging Case lines (e.g., L-11C)</small>
                        </div>
                        <div class="mb-3">
                            <label>Output Qty</label>
                            <input type="number" id="pOut" class="form-control" required>
                        </div>
                        <button type="button" class="btn btn-success w-100" onclick="saveProduction()">Submit</button>
                    </form>
                </div>
            </div>

            <!-- SECTION: UPLOAD -->
            <div id="upload-section" style="display:none;">
                <h3 class="mb-3">Bulk Scrap Upload</h3>
                <div class="card p-5 text-center">
                    <div class="border dashed p-5 bg-white rounded">
                        <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                        <h5>Upload .xlsx File</h5>
                        <p class="text-muted">Columns: Doc Date, Storage location, Line No, Price, Reject Qty, etc.</p>
                        <input type="file" id="uploadFile" class="form-control w-50 mx-auto mb-3" accept=".xlsx">
                        <button class="btn btn-primary" onclick="uploadExcel()">Process & Upload</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // ********************************************************
    // PASTE YOUR GOOGLE APPS SCRIPT URL HERE
    // ********************************************************
    const API_URL = "https://script.google.com/macros/s/AKfycbzfjYPvmCF3662_oC5nl9KR32MkxiOv4G-5BK_XxbJl5HVzBgNpy8nEPkPgbweSQHJq/exec"; 

    // STATE VARIABLES
    let rawData = { production: [], scrap: [], models: [] };
    let modelPrices = {};
    let currentLineType = 'EARBUDS'; // 'EARBUDS' or 'CASE'
    let charts = {};

    window.onload = loadData;

    function switchSection(id) {
        ['dashboard','production','upload'].forEach(s => document.getElementById(s+'-section').style.display = 'none');
        document.getElementById(id+'-section').style.display = 'block';
        document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function setLineType(type) {
        currentLineType = type;
        // Update Tabs UI
        document.querySelectorAll('.type-tabs .nav-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('chartTitle').innerText = type === 'EARBUDS' ? "Line Wise Analysis (Earbuds)" : "Line Wise Analysis (Charging Case)";
        
        processAndRender();
    }

    async function loadData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            let res = await fetch(API_URL);
            let json = await res.json();
            
            rawData = json;
            
            // Build Model Price Map
            if(json.models) {
                let mHeaders = json.models[0].map(h => h.toString().toLowerCase());
                let idxP = mHeaders.indexOf("price") > -1 ? mHeaders.indexOf("price") : 1;
                
                let pSelect = document.getElementById('pModel');
                pSelect.innerHTML = "";

                json.models.slice(1).forEach(r => {
                    modelPrices[r[0]] = parseFloat(r[idxP]) || 0;
                    pSelect.add(new Option(r[0], r[0]));
                });
            }

            processAndRender();
        } catch(e) { Swal.fire("Error", "Failed to load data", "error"); }
        document.getElementById('loader').style.display = 'none';
    }

    function processAndRender() {
        const filterStorage = document.getElementById('storageFilter').value; // ALL, PROCESS, RMD
        
        // --- 1. CALCULATE PRODUCTION VALUE PER LINE ---
        let lineProdVal = {}; 
        
        if(rawData.production.length > 0) {
            let h = rawData.production[0].map(x=>x.toLowerCase());
            let iLine = h.findIndex(x=>x.includes('line'));
            let iMod = h.indexOf('model') > -1 ? h.indexOf('model') : 2;
            let iOut = h.indexOf('output') > -1 ? h.indexOf('output') : h.length-1;

            rawData.production.slice(1).forEach(row => {
                let lineRaw = (row[iLine] || "").toString().toUpperCase().trim();
                let lineClean = lineRaw.replace(/\s/g, ''); // Remove spaces for checking
                
                // TYPE CHECK (Earbud vs Case)
                let isCase = lineClean.endsWith('C') || lineClean.includes('-C');
                if(currentLineType === 'EARBUDS' && isCase) return;
                if(currentLineType === 'CASE' && !isCase) return;

                let model = row[iMod];
                let qty = parseFloat(row[iOut]) || 0;
                let price = modelPrices[model] || 0;
                
                if(!lineProdVal[lineRaw]) lineProdVal[lineRaw] = 0;
                lineProdVal[lineRaw] += (qty * price);
            });
        }

        // --- 2. CALCULATE SCRAP VALUE PER LINE ---
        let lineScrapData = {};
        let modelScrap = {};
        let partScrap = {};

        if(rawData.scrap.length > 0) {
            let h = rawData.scrap[0].map(x=>x.toString().toLowerCase());
            let iLine = h.findIndex(x=>x.includes('line'));
            let iStore = h.findIndex(x=>x.includes('storage'));
            let iMat = h.indexOf('material');
            let iDesc = h.indexOf('material description');
            let iCat = h.indexOf('category');
            let iModel = h.indexOf('model');
            let iPrice = h.indexOf('price');
            let iQty = h.findIndex(x=>x.includes('reject') || x.includes('qty'));

            rawData.scrap.slice(1).forEach(row => {
                let lineRaw = (row[iLine] || "").toString().toUpperCase().trim();
                let lineClean = lineRaw.replace(/\s/g, '');

                // TYPE CHECK
                let isCase = lineClean.endsWith('C') || lineClean.includes('-C');
                if(currentLineType === 'EARBUDS' && isCase) return;
                if(currentLineType === 'CASE' && !isCase) return;

                // FILTER CHECK (Process vs RMD)
                let storeVal = (row[iStore] || "").toString();
                if(filterStorage === 'PROCESS' && !storeVal.includes('6003') && !storeVal.toLowerCase().includes('process')) return;
                if(filterStorage === 'RMD' && !storeVal.includes('6002') && !storeVal.toLowerCase().includes('rmd')) return;

                let price = parseFloat(row[iPrice]) || 0;
                let qty = parseFloat(row[iQty]) || 0;
                let val = price * qty;
                if(val === 0) return;

                let cat = row[iCat] || "Other";
                let desc = row[iDesc] || row[iMat];
                let model = row[iModel];

                // Line Aggregation
                if(!lineScrapData[lineRaw]) lineScrapData[lineRaw] = { total: 0, cats: {} };
                lineScrapData[lineRaw].total += val;
                if(!lineScrapData[lineRaw].cats[cat]) lineScrapData[lineRaw].cats[cat] = 0;
                lineScrapData[lineRaw].cats[cat] += val;

                // Model Aggregation
                modelScrap[model] = (modelScrap[model] || 0) + val;

                // Part Aggregation
                partScrap[desc] = (partScrap[desc] || 0) + val;
            });
        }

        renderCharts(lineProdVal, lineScrapData, modelScrap, partScrap);
    }

    function renderCharts(prodData, scrapData, modelData, partData) {
        // --- 1. Line Chart & Table ---
        const tbody = document.getElementById('lineTableBody');
        tbody.innerHTML = "";
        
        let allLines = new Set([...Object.keys(prodData), ...Object.keys(scrapData)]);
        let sortedLines = Array.from(allLines).sort();
        
        let labels = [];
        let rates = [];

        sortedLines.forEach(line => {
            let pVal = prodData[line] || 0;
            let sVal = scrapData[line] ? scrapData[line].total : 0;
            let rate = pVal > 0 ? (sVal/pVal)*100 : 0;
            let cats = scrapData[line] ? scrapData[line].cats : {};

            labels.push(line);
            rates.push(rate.toFixed(2));

            let row = `<tr>
                <td><strong>${line}</strong></td>
                <td>${pVal.toLocaleString('en-IN')}</td>
                <td class="text-danger fw-bold">${sVal.toLocaleString('en-IN')}</td>
                <td><span class="badge ${rate > 2 ? 'bg-danger' : 'bg-success'} badge-rate">${rate.toFixed(2)}%</span></td>
                <td>${(cats['PCBA']||0).toFixed(0)}</td>
                <td>${(cats['Speaker']||0).toFixed(0)}</td>
                <td>${(cats['Battery']||0).toFixed(0)}</td>
                <td>${(cats['Magnet']||0).toFixed(0)}</td>
                <td>${(cats['Other Parts']||cats['Other']||0).toFixed(0)}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        if(charts.line) charts.line.destroy();
        charts.line = new Chart(document.getElementById('lineChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Scrap Rate %', data: rates, backgroundColor: '#4ca1af', borderRadius:4 }]
            },
            options: { responsive:true, plugins:{legend:{display:false}} }
        });

        // --- 2. Model Chart ---
        if(charts.model) charts.model.destroy();
        charts.model = new Chart(document.getElementById('modelChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(modelData),
                datasets: [{ data: Object.values(modelData), backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'] }]
            }
        });

        // --- 3. Part Chart ---
        let topParts = Object.entries(partData).sort((a,b)=>b[1]-a[1]).slice(0,5);
        if(charts.part) charts.part.destroy();
        charts.part = new Chart(document.getElementById('partChart'), {
            type: 'bar',
            data: {
                labels: topParts.map(x=>x[0].substring(0,15)+'...'),
                datasets: [{ label: 'Loss Value', data: topParts.map(x=>x[1]), backgroundColor: '#FF6384' }]
            },
            options: { indexAxis: 'y' }
        });
    }

    // --- SAVE FUNCTIONS ---
    function saveProduction() {
        sendData({
            action: 'production',
            date: document.getElementById('pDate').value,
            model: document.getElementById('pModel').value,
            lineNo: document.getElementById('pLine').value,
            output: document.getElementById('pOut').value
        });
    }

    function uploadExcel() {
        let file = document.getElementById('uploadFile').files[0];
        if(!file) return Swal.fire("Error","Select file","warning");
        let r = new FileReader();
        r.onload = e => {
            let wb = XLSX.read(e.target.result, {type:'array'});
            let json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            sendData({action:'bulk_scrap', rows:json});
        };
        r.readAsArrayBuffer(file);
    }

    function sendData(payload) {
        document.getElementById('loader').style.display = 'flex';
        fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload)})
        .then(() => {
            document.getElementById('loader').style.display = 'none';
            Swal.fire("Success","Data Saved","success");
            if(payload.action==='production') document.getElementById('prodForm').reset();
        });
    }
</script>

</body>
</html>
