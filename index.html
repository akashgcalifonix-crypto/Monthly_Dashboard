<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Quality Dashboard</title>
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --success: #10b981; --danger: #ef4444; }
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; font-size: 14px; }
        .navbar { background: var(--primary); color: white; padding: 10px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .logo { height: 40px; background: white; padding: 3px; border-radius: 5px; }
        
        .stat-card { background: white; border-radius: 12px; padding: 20px; border-bottom: 4px solid var(--accent); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-label { font-size: 12px; color: #64748b; font-weight: bold; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: 800; color: #1e293b; }

        .chart-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); min-height: 350px; }
        .btn-custom { border-radius: 8px; font-weight: 600; }
        
        #fileInput { display: none; }
        .table-responsive { background: white; border-radius: 12px; padding: 15px; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .sticky-header { position: sticky; top: 0; background: white; z-index: 10; }
    </style>
</head>
<body>

<nav class="navbar d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo" alt="Logo">
        <h4 class="mb-0">CALIFONIX <span style="color: #38bdf8;">DASHBOARD</span></h4>
    </div>
    <div class="d-flex gap-2">
        <label for="fileInput" class="btn btn-success btn-custom"><i class="bi bi-file-earmark-excel me-1"></i> Upload Excel</label>
        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
        <button class="btn btn-danger btn-custom" onclick="exportToPPT()"><i class="bi bi-file-earmark-ppt me-1"></i> Export PPT</button>
    </div>
</nav>

<div class="container-fluid mt-3">
    <!-- Filter Bar -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="bg-white p-3 rounded shadow-sm d-flex gap-4 align-items-center">
                <span><strong><i class="bi bi-funnel"></i> View Data For:</strong></span>
                <select id="monthFilter" class="form-select w-auto" onchange="processAndRender()">
                    <option value="All">All Months</option>
                    <option value="0">January</option><option value="1">February</option>
                    <option value="2">March</option><option value="3">April</option>
                    <option value="4">May</option><option value="5">June</option>
                    <option value="6">July</option><option value="7">August</option>
                    <option value="8">September</option><option value="9">October</option>
                    <option value="10" selected>November</option><option value="11">December</option>
                </select>
                <select id="yearFilter" class="form-select w-auto" onchange="processAndRender()">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                </select>
                <button class="btn btn-outline-danger btn-sm ms-auto" onclick="clearData()">Clear All Data</button>
            </div>
        </div>
    </div>

    <!-- KPI Summary -->
    <div class="row g-3 mb-4 text-center">
        <div class="col-md-3">
            <div class="stat-card" style="border-color: #2563eb;">
                <div class="stat-label">FPY (First Pass Yield)</div>
                <div class="stat-value" id="kpi-fpy">0%</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-color: #ef4444;">
                <div class="stat-label">Line Rejection Rate</div>
                <div class="stat-value" id="kpi-rejection">0%</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-color: #10b981;">
                <div class="stat-label">Total Input</div>
                <div class="stat-value" id="kpi-input">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-color: #f59e0b;">
                <div class="stat-label">Total Defects</div>
                <div class="stat-value" id="kpi-defects">0</div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3">
        <div class="col-md-8">
            <div class="chart-container">
                <h6 class="fw-bold"><i class="bi bi-bar-chart-line"></i> Top 5 Defects (Pareto)</h6>
                <canvas id="paretoChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <h6 class="fw-bold"><i class="bi bi-pie-chart"></i> Category Contribution %</h6>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Table Section -->
    <div class="table-responsive">
        <h6 class="fw-bold mb-3">Data Preview & Edit (Selected Month)</h6>
        <table class="table table-hover table-sm align-middle">
            <thead class="table-dark sticky-header">
                <tr>
                    <th>Date</th><th>Model</th><th>Line</th><th>Defect</th><th>Qty</th><th>Category</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="7" class="text-center">No data available. Please upload an Excel file.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let dbData = JSON.parse(localStorage.getItem('califonixData')) || [];
    let charts = {};

    window.onload = () => { if(dbData.length > 0) processAndRender(); };

    // --- 1. File Upload & Data Cleaning ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const workbook = XLSX.read(evt.target.result, { type: 'binary', cellDates: true });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);
            
            // Clean Column Names (Remove spaces and make standard)
            const cleaned = json.map(row => {
                let newRow = {};
                for (let key in row) {
                    let k = key.trim(); // "Date   " -> "Date"
                    newRow[k] = row[key];
                }
                return newRow;
            });

            dbData = [...cleaned, ...dbData];
            localStorage.setItem('califonixData', JSON.stringify(dbData));
            processAndRender();
            alert("Data Uploaded and Saved Successfully!");
        };
        reader.readAsBinaryString(file);
    });

    // --- 2. Data Processing ---
    function processAndRender() {
        const selMonth = document.getElementById('monthFilter').value;
        const selYear = document.getElementById('yearFilter').value;

        let filtered = dbData.filter(r => {
            const d = new Date(r.Date);
            const mMatch = selMonth === "All" || d.getMonth() == selMonth;
            const yMatch = d.getFullYear() == selYear;
            return mMatch && yMatch;
        });

        updateDashboard(filtered);
    }

    function updateDashboard(data) {
        let tInput = 0, tDefects = 0;
        let defectCounts = {}, catCounts = {};
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No records found for this period.</td></tr>';
        }

        data.forEach((row, index) => {
            let qty = parseInt(row["Defect Qty"]) || 0;
            let inp = parseInt(row["Input"]) || 0;
            
            tInput += inp;
            tDefects += qty;

            if(row.Defect) defectCounts[row.Defect] = (defectCounts[row.Defect] || 0) + qty;
            if(row.Category) catCounts[row.Category] = (catCounts[row.Category] || 0) + qty;

            // Date Formatting
            let dStr = row.Date instanceof Date ? row.Date.toLocaleDateString() : row.Date;

            tbody.innerHTML += `
                <tr>
                    <td>${dStr}</td>
                    <td>${row.Model || '-'}</td>
                    <td>${row.Line || '-'}</td>
                    <td>${row.Defect || '-'}</td>
                    <td>${qty}</td>
                    <td><span class="badge bg-info text-dark">${row.Category || 'N/A'}</span></td>
                    <td>
                        <i class="bi bi-trash text-danger cursor-pointer" onclick="deleteRow(${index})"></i>
                    </td>
                </tr>
            `;
        });

        // KPIs
        const fpy = tInput > 0 ? (((tInput - tDefects) / tInput) * 100).toFixed(2) : 0;
        const rej = tInput > 0 ? ((tDefects / tInput) * 100).toFixed(2) : 0;

        document.getElementById('kpi-fpy').innerText = fpy + "%";
        document.getElementById('kpi-rejection').innerText = rej + "%";
        document.getElementById('kpi-input').innerText = tInput.toLocaleString();
        document.getElementById('kpi-defects').innerText = tDefects.toLocaleString();

        renderCharts(defectCounts, catCounts);
    }

    // --- 3. Charting ---
    function renderCharts(defData, catData) {
        if(charts.p) charts.p.destroy();
        if(charts.c) charts.c.destroy();

        // Pareto (Top 5)
        const sorted = Object.entries(defData).sort((a,b) => b[1]-a[1]).slice(0,5);
        charts.p = new Chart(document.getElementById('paretoChart'), {
            type: 'bar',
            data: {
                labels: sorted.map(x=>x[0]),
                datasets: [{ label: 'Defect Qty', data: sorted.map(x=>x[1]), backgroundColor: '#2563eb' }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // Category Pie
        charts.c = new Chart(document.getElementById('categoryChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(catData),
                datasets: [{ data: Object.values(catData), backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6366f1', '#ec4899'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- 4. Actions ---
    function deleteRow(idx) {
        if(confirm("Are you sure you want to delete this record?")) {
            dbData.splice(idx, 1);
            localStorage.setItem('califonixData', JSON.stringify(dbData));
            processAndRender();
        }
    }

    function clearData() {
        if(confirm("Warning! This will delete all saved data. Continue?")) {
            localStorage.removeItem('califonixData');
            location.reload();
        }
    }

    function exportToPPT() {
        let pptx = new PptxGenJS();
        let slide = pptx.addSlide();
        slide.addText("QUALITY REPORT: CALIFONIX", { x:0.5, y:0.5, fontSize:28, bold:true, color:'0f172a' });
        slide.addText("Month: " + document.getElementById('monthFilter').options[document.getElementById('monthFilter').selectedIndex].text, { x:0.5, y:1.1, fontSize:18 });
        
        slide.addText("FPY: " + document.getElementById('kpi-fpy').innerText, { x:0.5, y:2, w:3, h:1, fill:'F1F5F9', align:'center', bold:true });
        slide.addText("REJECTION: " + document.getElementById('kpi-rejection').innerText, { x:4, y:2, w:3, h:1, fill:'F1F5F9', align:'center', bold:true });
        
        pptx.writeFile({ fileName: "Califonix_Report.pptx" });
    }
</script>

</body>
</html>
