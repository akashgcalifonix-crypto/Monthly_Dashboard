<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Quality Dashboard Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --success: #10b981; --danger: #ef4444; }
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: var(--primary); color: white; padding: 12px 30px; border-bottom: 3px solid var(--accent); }
        .logo { height: 45px; background: white; padding: 5px; border-radius: 5px; }
        
        /* KPI Cards */
        .stat-card { background: white; border-radius: 12px; padding: 20px; border-top: 5px solid var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.08); text-align: center; height: 100%; }
        .stat-label { font-size: 13px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; display: block; }
        .stat-value { font-size: 28px; font-weight: 800; color: #1e293b; display: block; }

        /* Chart Containers */
        .chart-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 20px; position: relative; height: 350px; width: 100%; }
        
        /* Tables */
        .card-table { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .table thead { background: #f8fafc; }
        .table th { font-size: 12px; text-transform: uppercase; color: #64748b; }
        
        .btn-main { border-radius: 8px; font-weight: 600; padding: 8px 18px; }
        #fileInput { display: none; }
        .preview-mode-alert { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; display: none; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<nav class="navbar d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <h4 class="mb-0">QUALITY <span style="color: #38bdf8;">PORTAL</span></h4>
    </div>
    <div class="d-flex gap-2">
        <label for="fileInput" class="btn btn-outline-light btn-main"><i class="bi bi-file-earmark-arrow-up"></i> Upload Excel</label>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
        
        <button id="saveBtn" class="btn btn-success btn-main" onclick="confirmSave()" style="display:none;">
            <i class="bi bi-cloud-check"></i> Save Data
        </button>
        
        <button class="btn btn-danger btn-main" onclick="exportToPPT()"><i class="bi bi-file-earmark-ppt"></i> Export PPT</button>
    </div>
</nav>

<div class="container-fluid mt-4 px-4">
    
    <div id="previewAlert" class="preview-mode-alert">
        <i class="bi bi-info-circle-fill"></i> PREVIEWING NEW DATA: Please check the dashboard below and click 'Save Data' to store it.
    </div>

    <!-- Filters -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-6 d-flex gap-3 align-items-center">
            <h5 class="mb-0 fw-bold">Performance Summary</h5>
            <select id="monthFilter" class="form-select w-auto shadow-sm" onchange="loadSavedData()">
                <option value="All">All Months</option>
                <option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option>
                <option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option>
                <option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option>
                <option value="9">Oct</option><option value="10" selected>Nov</option><option value="11">Dec</option>
            </select>
            <select id="yearFilter" class="form-select w-auto shadow-sm" onchange="loadSavedData()">
                <option value="2025">2025</option>
                <option value="2024">2024</option>
            </select>
        </div>
        <div class="col-md-6 text-end">
             <button class="btn btn-sm btn-outline-danger" onclick="resetDatabase()">Reset All Records</button>
        </div>
    </div>

    <!-- KPI Row -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card" style="border-top-color: #2563eb;">
                <span class="stat-label">First Pass Yield (FPY)</span>
                <span class="stat-value text-primary" id="kpi-fpy">0%</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-top-color: #ef4444;">
                <span class="stat-label">Rejection Rate</span>
                <span class="stat-value text-danger" id="kpi-rej">0%</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-top-color: #10b981;">
                <span class="stat-label">Monthly Total Input</span>
                <span class="stat-value" id="kpi-input">0</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-top-color: #f59e0b;">
                <span class="stat-label">Monthly Total Defects</span>
                <span class="stat-value" id="kpi-defects">0</span>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3 mb-4">
        <div class="col-md-7">
            <div class="chart-container">
                <h6 class="fw-bold mb-3">Top 5 Defects (Pareto)</h6>
                <canvas id="paretoChart"></canvas>
            </div>
        </div>
        <div class="col-md-5">
            <div class="chart-container">
                <h6 class="fw-bold mb-3">Defect Distribution by Category</h6>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Line Wise Table -->
    <div class="card-table">
        <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Line-Wise Performance Details</h6>
        <div class="table-responsive">
            <table class="table table-hover align-middle text-center border">
                <thead>
                    <tr>
                        <th>Line No</th>
                        <th>Input Qty</th>
                        <th>Defect Qty</th>
                        <th>FPY %</th>
                        <th>Rejection %</th>
                        <th>Major Defect Issue</th>
                    </tr>
                </thead>
                <tbody id="lineBody">
                    <tr><td colspan="6" class="text-muted">No data found.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Action Plan Section -->
    <div class="card-table">
        <h6 class="fw-bold mb-3 text-danger"><i class="bi bi- lightning-fill me-2"></i>Top 5 Defect Action Plan</h6>
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th width="20%">Defect Name</th>
                        <th width="10%">Count</th>
                        <th>Root Cause Analysis</th>
                        <th>Corrective Action Plan</th>
                        <th width="10%">Status</th>
                    </tr>
                </thead>
                <tbody id="actionPlanBody">
                    <!-- Top 5 defects will appear here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let masterData = JSON.parse(localStorage.getItem('califonix_v3_db')) || [];
    let uploadBuffer = [];
    let chartP, chartC;

    window.onload = () => { if(masterData.length > 0) loadSavedData(); };

    // --- 1. File Upload & Processing ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const workbook = XLSX.read(evt.target.result, { type: 'binary', cellDates: true });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            uploadBuffer = json.map(row => {
                let cleanRow = {};
                for (let key in row) cleanRow[key.trim()] = row[key];
                return cleanRow;
            });

            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('previewAlert').style.display = 'block';
            
            updateDashboard(uploadBuffer); // Show Preview
        };
        reader.readAsBinaryString(file);
    });

    function confirmSave() {
        if(confirm("Save this data to the permanent database?")) {
            masterData = [...uploadBuffer, ...masterData];
            localStorage.setItem('califonix_v3_db', JSON.stringify(masterData));
            uploadBuffer = [];
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('previewAlert').style.display = 'none';
            loadSavedData();
        }
    }

    function loadSavedData() {
        const m = document.getElementById('monthFilter').value;
        const y = document.getElementById('yearFilter').value;

        let filtered = masterData.filter(r => {
            const d = new Date(r.Date);
            return (m === "All" || d.getMonth() == m) && d.getFullYear() == y;
        });

        updateDashboard(filtered);
    }

    // --- 2. Dashboard Rendering Engine ---
    function updateDashboard(data) {
        let totalInput = 0, totalDefects = 0;
        let defMap = {}, catMap = {}, lineMap = {};

        data.forEach(r => {
            const qty = parseInt(r["Defect Qty"]) || 0;
            const inp = parseInt(r.Input) || 0;
            const line = r.Line || "Unknown";
            const cat = r.Category || "Process";

            totalInput += inp;
            totalDefects += qty;

            // Pareto data
            if(r.Defect) defMap[r.Defect] = (defMap[r.Defect] || 0) + qty;
            // Pie data
            catMap[cat] = (catMap[cat] || 0) + qty;
            // Line wise
            if(!lineMap[line]) lineMap[line] = { inp: 0, def: 0, defs: {} };
            lineMap[line].inp += inp;
            lineMap[line].def += qty;
            if(r.Defect) lineMap[line].defs[r.Defect] = (lineMap[line].defs[r.Defect] || 0) + qty;
        });

        // Update KPIs
        document.getElementById('kpi-input').innerText = totalInput.toLocaleString();
        document.getElementById('kpi-defects').innerText = totalDefects.toLocaleString();
        const fpyVal = totalInput > 0 ? (((totalInput - totalDefects)/totalInput)*100).toFixed(2) : 0;
        const rejVal = totalInput > 0 ? ((totalDefects/totalInput)*100).toFixed(2) : 0;
        
        document.getElementById('kpi-fpy').innerText = fpyVal + "%";
        document.getElementById('kpi-rej').innerText = rejVal + "%";

        renderCharts(defMap, catMap);
        renderLineTable(lineMap);
        renderActionPlan(defMap);
    }

    function renderCharts(defMap, catMap) {
        if(chartP) chartP.destroy();
        if(chartC) chartC.destroy();

        const sortedDef = Object.entries(defMap).sort((a,b) => b[1]-a[1]).slice(0, 5);

        const ctxP = document.getElementById('paretoChart').getContext('2d');
        chartP = new Chart(ctxP, {
            type: 'bar',
            data: {
                labels: sortedDef.map(x=>x[0]),
                datasets: [{ 
                    label: 'Count', 
                    data: sortedDef.map(x=>x[1]), 
                    backgroundColor: '#2563eb',
                    borderRadius: 5
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const ctxC = document.getElementById('categoryChart').getContext('2d');
        chartC = new Chart(ctxC, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catData),
                datasets: [{ 
                    data: Object.values(catData), 
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6366f1', '#ec4899'] 
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderLineTable(lineMap) {
        const body = document.getElementById('lineBody');
        body.innerHTML = '';
        const sortedLines = Object.keys(lineMap).sort();

        sortedLines.forEach(l => {
            const ld = lineMap[l];
            const fpy = ld.inp > 0 ? (((ld.inp - ld.def)/ld.inp)*100).toFixed(2) : "0.00";
            const rej = ld.inp > 0 ? ((ld.def/ld.inp)*100).toFixed(2) : "0.00";
            const topDef = Object.entries(ld.defs).sort((a,b)=>b[1]-a[1])[0]?.[0] || "-";

            body.innerHTML += `
                <tr>
                    <td class="fw-bold">${l}</td>
                    <td>${ld.inp.toLocaleString()}</td>
                    <td>${ld.def.toLocaleString()}</td>
                    <td class="text-primary fw-bold">${fpy}%</td>
                    <td class="text-danger fw-bold">${rej}%</td>
                    <td class="text-muted small">${topDef}</td>
                </tr>`;
        });
    }

    function renderActionPlan(defMap) {
        const body = document.getElementById('actionPlanBody');
        body.innerHTML = '';
        const top5 = Object.entries(defMap).sort((a,b) => b[1]-a[1]).slice(0, 5);

        top5.forEach(item => {
            body.innerHTML += `
                <tr>
                    <td class="fw-bold">${item[0]}</td>
                    <td class="text-center">${item[1]}</td>
                    <td><input type="text" class="form-control form-control-sm" placeholder="Reason for ${item[0]}..."></td>
                    <td><input type="text" class="form-control form-control-sm" placeholder="Action taken..."></td>
                    <td class="text-center"><span class="badge bg-warning">Open</span></td>
                </tr>`;
        });
    }

    // --- Helpers ---
    function resetDatabase() {
        if(confirm("This will permanently delete all saved records. Continue?")) {
            localStorage.removeItem('califonix_v3_db');
            location.reload();
        }
    }

    function exportToPPT() {
        let pptx = new PptxGenJS();
        let slide = pptx.addSlide();
        slide.addText("QUALITY ANALYTICS REPORT - CALIFONIX", { x:0.5, y:0.5, fontSize:24, bold:true, color:'0f172a' });
        slide.addText(`Generated on: ${new Date().toLocaleDateString()}`, { x:0.5, y:1.0, fontSize:14 });
        
        slide.addText("FPY: " + document.getElementById('kpi-fpy').innerText, { x:0.5, y:2, w:3, h:1, fill:{color:'F1F5F9'}, align:'center', bold:true });
        slide.addText("REJ%: " + document.getElementById('kpi-rej').innerText, { x:4, y:2, w:3, h:1, fill:{color:'F1F5F9'}, align:'center', bold:true });
        
        pptx.writeFile({ fileName: "Quality_Performance_Report.pptx" });
    }
</script>
</body>
</html>
