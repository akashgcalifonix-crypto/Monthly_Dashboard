<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Quality Dashboard</title>

    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Chart.js and Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root { --primary: #0d1b2a; --accent: #e63946; --bg: #f8f9fa; --success: #2a9d8f; --warning: #ffb703; --info: #00b4d8; }
        body { background-color: var(--bg); font-family: 'Poppins', sans-serif; font-size: 0.85rem; }
        .sidebar { min-height: 100vh; background: var(--primary); color: #fff; position: fixed; width: 220px; z-index: 1000; }
        .sidebar-logo { padding: 15px; background: white; text-align: center; border-bottom: 3px solid var(--accent); }
        .nav-link { color: rgba(255,255,255,0.7); padding: 12px 15px; margin: 5px 0; border-radius: 0 25px 25px 0; transition: 0.3s; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: var(--accent); color: white; font-weight: 600; }
        .main-content { margin-left: 220px; padding: 25px; }
        
        /* Scorecard */
        .scorecard-row { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .score-card { flex: 1; min-width: 140px; background: white; padding: 15px 10px; text-align: center; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-bottom: 4px solid transparent; }
        .score-val { font-size: 1.3rem; font-weight: 700; color: #333; margin-bottom: 5px; }
        .score-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #888; }
        
        /* Product Summary Cards */
        .prod-summary-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .prod-summary-card { min-width: 240px; background: white; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); overflow: hidden; }
        .prod-header { padding: 8px; font-weight: bold; text-align: center; color: white; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.85rem; }
        .prod-body { padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .prod-stat { text-align: center; flex: 1; }
        .prod-stat-val { font-size: 1rem; font-weight: 800; color: #333; margin-bottom: 2px; }
        .prod-stat-rate { font-size: 0.85rem; font-weight: bold; }
        .prod-stat-lbl { font-size: 0.65rem; color: #777; text-transform: uppercase; margin-top: 2px;}
        
        /* Table Styles */
        .custom-table thead tr:first-child th { background-color: var(--primary); color: white; vertical-align: middle; font-size: 0.75rem; text-transform: uppercase; border: 1px solid #444; }
        .custom-table td { vertical-align: middle; font-weight: 500; font-size: 0.85rem; }
        .badge-prod { font-size: 0.7rem; padding: 5px 8px; }
        
        /* Sort Controls */
        .sort-select { width: 100%; font-size: 0.65rem; padding: 2px; border: 1px solid #ccc; border-radius: 4px; background-color: white; cursor: pointer; font-weight: bold; }
        .sort-select:focus { outline: 2px solid var(--accent); }
        
        /* Custom Tabs */
        .nav-tabs .nav-link { color: #555; font-weight: 600; border-radius: 5px 5px 0 0; }
        .nav-tabs .nav-link.active { color: var(--accent); border-color: #dee2e6 #dee2e6 #fff; background-color: #fff; }
        
        /* Colors & Alerts */
        .text-orange { color: #fd7e14 !important; }
        .text-success { color: #198754 !important; }
        .text-danger { color: #dc3545 !important; }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        /* NEW STYLES FOR DETAIL ANALYSIS */
        .line-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding: 15px 0; }
        .line-box { 
            background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px 10px; 
            text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .line-box:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--accent); background: #fff5f5; }
        .line-box h5 { margin: 0; font-weight: bold; color: var(--primary); }
        .line-box small { color: #777; font-size: 0.7rem; }
        
        /* Modal Styles */
        .modal-xl { max-width: 95%; }
        .chart-container-sm { height: 250px; width: 100%; margin-bottom: 20px; }
        .chart-container-xs { height: 250px; width: 100%; margin-bottom: 10px; }
        
        /* Table Input Filter Styles */
        .filter-input { width: 100%; font-size: 0.7rem; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; }

        /* Comparison Table */
        .comp-header-1 { background-color: #e0f2f1; color: #004d40; border-bottom: 2px solid #004d40; }
        .comp-header-2 { background-color: #fff3e0; color: #e65100; border-bottom: 2px solid #e65100; }
        .comp-header-3 { background-color: #f3e5f5; color: #4a148c; border-bottom: 2px solid #4a148c; }
        .comp-header-4 { background-color: #e3f2fd; color: #0d47a1; border-bottom: 2px solid #0d47a1; }
        .comp-header-diff { background-color: #212529; color: #fff; border-bottom: 2px solid #000; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-danger" role="status"></div>
    <h6 class="mt-3 text-dark">Processing Data...</h6>
</div>

<div class="sidebar">
    <div class="sidebar-logo"><img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="max-width: 80%; height: auto;"></div>
    <div class="p-3">
        <label class="small text-white-50 fw-bold">DATE RANGE (Global)</label>
        <input type="date" id="dateFrom" class="form-control form-control-sm mb-2" onchange="loadData()">
        <input type="date" id="dateTo" class="form-control form-control-sm" onchange="loadData()">
    </div>
    <nav class="nav flex-column">
        <a class="nav-link active" onclick="switchSection('dashboard')"><i class="fas fa-chart-pie me-2"></i> Main Dashboard</a>
        <a class="nav-link" onclick="switchSection('category-analysis')"><i class="fas fa-layer-group me-2"></i> Category & Floor</a>
        <a class="nav-link" onclick="switchSection('weekly-comparison')"><i class="fas fa-balance-scale me-2"></i> Weekly Comparison</a>
        <a class="nav-link" onclick="switchSection('detail-analysis')"><i class="fas fa-search-plus me-2"></i> Detail Analysis</a>
        <a class="nav-link" onclick="switchSection('model-analysis')"><i class="fas fa-cubes me-2"></i> Model Analysis</a>
        <a class="nav-link" onclick="switchSection('line-analysis')"><i class="fas fa-microchip me-2"></i> Line Analysis</a>
        <a class="nav-link" onclick="switchSection('upload')"><i class="fas fa-file-upload me-2"></i> Bulk Upload</a>
        <a class="nav-link" onclick="switchSection('production')"><i class="fas fa-industry me-2"></i> Prod Entry</a>
    </nav>
</div>

<div class="main-content">
    <div id="dashboard-section" class="content-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold text-dark">Main Dashboard</h3>
            <button class="btn btn-success btn-sm" onclick="exportTable()"><i class="fas fa-file-excel me-1"></i> Excel Export</button>
        </div>

        <!-- OVERALL SCORECARD -->
        <div class="scorecard-row">
            <div class="score-card" style="border-color:#333"><div class="score-val" id="ovr-qty">0</div><div class="score-label">Total Output</div></div>
            <div class="score-card" style="border-color:#2a9d8f"><div class="score-val" id="ovr-val" style="color:#2a9d8f">₹0</div><div class="score-label">Prod Value</div></div>
            <div class="score-card" style="border-color:#ffb703"><div class="score-val text-warning" id="ovr-proc-val">₹0</div><div class="score-label">Process Scrap</div></div>
            <div class="score-card" style="border-color:#00b4d8"><div class="score-val text-info" id="ovr-rmd-val">₹0</div><div class="score-label">RMD Scrap</div></div>
            <div class="score-card" style="border-color:#e63946"><div class="score-val text-danger" id="ovr-tot-val">₹0</div><div class="score-label">Total Scrap</div></div>
            <div class="score-card" style="background:#fff8e1"><div class="score-val text-warning" id="ovr-proc-rate">0%</div><div class="score-label">Proc Rate</div></div>
            <div class="score-card" style="background:#e0f7fa"><div class="score-val text-info" id="ovr-rmd-rate">0%</div><div class="score-label">RMD Rate</div></div>
            <div class="score-card" style="background:#2c3e50"><div class="score-val text-white" id="ovr-all-rate">0%</div><div class="score-label text-white-50">Overall Rate</div></div>
        </div>

        <!-- PRODUCT SUMMARY -->
        <h6 class="fw-bold text-dark mb-2"><i class="fas fa-layer-group me-2"></i>Product Wise Performance</h6>
        <div class="prod-summary-container" id="productSummaryContainer"></div>

        <!-- DATE WISE SCRAP TREND -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap py-2">
                <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-chart-line me-2"></i>Date Wise Scrap Trend (Value vs Rate)</h6>
                <div class="d-flex gap-2 align-items-center">
                    <select id="trendGraphProduct" class="form-select form-select-sm" style="width: 150px; border:1px solid #aaa;" onchange="renderTrendChart()">
                        <option value="ALL">All Products</option>
                        <option value="EARBUDS">Earbuds</option>
                        <option value="CHARGING CASE">Charging Case</option>
                        <option value="SMART WATCH">Smart Watch</option>
                        <option value="HEADPHONE">Headphone</option>
                        <option value="DASHCAM">Dashcam</option>
                    </select>
                    <select id="trendGraphType" class="form-select form-select-sm" style="width: 150px; border:1px solid #aaa;" onchange="renderTrendChart()">
                        <option value="ALL">Total (Proc + RMD)</option>
                        <option value="PROCESS">Process Only</option>
                        <option value="RMD">RMD Only</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div style="height: 350px; width: 100%;">
                    <canvas id="scrapTrendCanvas"></canvas>
                </div>
            </div>
        </div>

        <!-- GLOBAL FILTERS -->
        <div class="bg-white p-3 rounded shadow-sm mb-3 d-flex gap-2 align-items-center flex-wrap">
            <div class="input-group input-group-sm" style="width: 200px;">
                <span class="input-group-text fw-bold">Defect</span>
                <select id="filterDefect" class="form-select" onchange="processAndRender()">
                    <option value="ALL">All Defects</option>
                    <option value="PCBA">PCBA</option>
                    <option value="BATTERY">Battery</option>
                    <option value="SPEAKER">Speaker</option>
                    <option value="SCREEN">Screen</option>
                </select>
            </div>
            <button class="btn btn-primary btn-sm ms-auto" onclick="loadData()"><i class="fas fa-sync"></i> Refresh Data</button>
        </div>

        <!-- DETAILED TABLE -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-list me-2"></i> Line Wise Breakdown</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover custom-table text-center mb-0" id="analysisTable">
                        <thead>
                            <tr>
                                <th rowspan="2" class="align-middle">Line No</th>
                                <th rowspan="2" class="align-middle">Product</th>
                                <th rowspan="2" class="align-middle bg-dark">Prod Value</th>
                                <th colspan="2" class="bg-warning text-dark border-bottom-0">Process (6003)</th>
                                <th colspan="2" class="bg-info text-white border-bottom-0">RMD (6002)</th>
                                <th colspan="2" class="bg-danger text-white border-bottom-0">Total Scrap</th>
                            </tr>
                            <tr>
                                <th class="bg-warning bg-opacity-25 text-dark">Value (₹)</th>
                                <th class="bg-warning bg-opacity-25 text-dark">Rate %</th>
                                <th class="bg-info bg-opacity-75 text-white">Value (₹)</th>
                                <th class="bg-info bg-opacity-75 text-white">Rate %</th>
                                <th class="bg-danger bg-opacity-75 text-white">Value (₹)</th>
                                <th class="bg-danger bg-opacity-75 text-white">Rate %</th>
                            </tr>
                            <!-- SORT/FILTER ROW -->
                            <tr class="filter-row">
                                <th><select class="sort-select" onchange="triggerSort(0, 'text', this)"><option value="" disabled selected>Sort</option><option value="asc">A-Z</option><option value="desc">Z-A</option></select></th>
                                <th>
                                    <select class="sort-select" id="prodFilterDropdown" onchange="applyProductFilter(this)">
                                        <option value="">All</option>
                                        <option value="EARBUDS">Earbuds</option>
                                        <option value="CHARGING CASE">Case</option>
                                        <option value="SMART WATCH">Watch</option>
                                        <option value="HEADPHONE">Headphone</option>
                                        <option value="DASHCAM">Dashcam</option>
                                    </select>
                                </th>
                                <th><select class="sort-select" onchange="triggerSort(2, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>
                                <th><select class="sort-select" onchange="triggerSort(3, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>
                                <th><select class="sort-select" onchange="triggerSort(4, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>
                                <th><select class="sort-select" onchange="triggerSort(5, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>
                                <th><select class="sort-select" onchange="triggerSort(6, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>
                                <th><select class="sort-select" onchange="triggerSort(7, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>
                                <th><select class="sort-select" onchange="triggerSort(8, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW SECTION: CATEGORY & FLOOR ANALYSIS -->
    <div id="category-analysis-section" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold text-dark">Category & Floor Analysis</h3>
        </div>
        
        <div class="bg-white p-3 rounded shadow-sm mb-4 d-flex gap-4 align-items-center flex-wrap">
            <div>
                <label class="small fw-bold text-secondary">Floor Filter</label>
                <select id="caFloor" class="form-select form-select-sm" style="width:200px" onchange="renderCategoryAnalysis()">
                    <option value="ALL">All Floors</option>
                    <option value="1">1st Floor (Line 1-8)</option>
                    <option value="2">2nd Floor (Line 9-16)</option>
                    <option value="B">Basement (Line 17-24)</option>
                </select>
            </div>
            <div>
                <label class="small fw-bold text-secondary">Process / RMD</label>
                <select id="caType" class="form-select form-select-sm" style="width:200px" onchange="renderCategoryAnalysis()">
                    <option value="ALL">All (Process + RMD)</option>
                    <option value="PROCESS">Process Only</option>
                    <option value="RMD">RMD Only</option>
                </select>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-7">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white fw-bold">Category Wise Scrap Value</div>
                    <div class="card-body">
                        <div style="height: 350px;">
                            <canvas id="caChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white fw-bold">Category Details</div>
                    <div class="card-body p-0">
                        <table class="table table-bordered table-striped text-center mb-0 custom-table">
                            <thead class="bg-dark text-white">
                                <tr>
                                    <th>Category</th>
                                    <th>Scrap Value (₹)</th>
                                    <th>Scrap Rate %</th>
                                </tr>
                            </thead>
                            <tbody id="caTableBody">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END NEW SECTION -->

    <!-- WEEKLY COMPARISON REPORT -->
    <div id="weekly-comparison-section" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold text-dark">Weekly Comparison Report</h3>
        </div>

        <div class="card shadow-sm border-0 p-3 bg-white mb-4">
            <div class="row g-2 mb-3">
                <div class="col-md-3">
                    <label class="fw-bold text-success small">Week 1 (Base)</label>
                    <div class="input-group input-group-sm">
                        <input type="date" id="wcFrom1" class="form-control">
                        <input type="date" id="wcTo1" class="form-control">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="fw-bold text-warning small">Week 2</label>
                    <div class="input-group input-group-sm">
                        <input type="date" id="wcFrom2" class="form-control">
                        <input type="date" id="wcTo2" class="form-control">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="fw-bold text-info small">Week 3</label>
                    <div class="input-group input-group-sm">
                        <input type="date" id="wcFrom3" class="form-control">
                        <input type="date" id="wcTo3" class="form-control">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="fw-bold text-primary small">Week 4</label>
                    <div class="input-group input-group-sm">
                        <input type="date" id="wcFrom4" class="form-control">
                        <input type="date" id="wcTo4" class="form-control">
                    </div>
                </div>
            </div>
            
            <div class="row align-items-end g-3">
                <div class="col-md-4">
                    <label class="small fw-bold">Product Filter</label>
                    <select id="wcProductInput" class="form-select form-select-sm">
                        <option value="ALL">All Products</option>
                        <option value="EARBUDS">Earbuds</option>
                        <option value="CHARGING CASE">Charging Case</option>
                        <option value="DASHCAM">Dashcam</option>
                        <option value="SMART WATCH">Smart Watch</option>
                        <option value="HEADPHONE">Headphone</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">Select Comparison (Difference)</label>
                    <select id="wcDiffSelect" class="form-select form-select-sm">
                        <option value="none">No Difference Column</option>
                        <option value="1_0">Week 2 vs Week 1</option>
                        <option value="2_1">Week 3 vs Week 2</option>
                        <option value="3_2">Week 4 vs Week 3</option>
                        <option value="3_0">Week 4 vs Week 1</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-dark btn-sm w-100" onclick="renderWeeklyComparison()"><i class="fas fa-exchange-alt me-2"></i>Compare Data</button>
                </div>
            </div>

            <!-- NEW CATEGORY MULTI-SELECT -->
            <div class="row mt-3 border-top pt-3">
                <div class="col-md-12">
                    <label class="small fw-bold text-secondary mb-2">Category Filter (Multi-select)</label>
                    <div class="d-flex flex-wrap gap-3">
                        <div class="form-check">
                            <input class="form-check-input wc-cat-filter" type="checkbox" value="FRESH" id="wcCatFresh" checked>
                            <label class="form-check-label small" for="wcCatFresh">Fresh</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input wc-cat-filter" type="checkbox" value="REWORK" id="wcCatRework" checked>
                            <label class="form-check-label small" for="wcCatRework">Rework</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input wc-cat-filter" type="checkbox" value="WIP" id="wcCatWip" checked>
                            <label class="form-check-label small" for="wcCatWip">WIP</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input wc-cat-filter" type="checkbox" value="OLD WIP" id="wcCatOldWip" checked>
                            <label class="form-check-label small" for="wcCatOldWip">Old WIP</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input wc-cat-filter" type="checkbox" value="SHORT" id="wcCatShort" checked>
                            <label class="form-check-label small" for="wcCatShort">Short</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold">Performance Summary</div>
                    <div class="card-body p-0">
                        <table class="table table-bordered text-center mb-0">
                            <thead class="bg-light">
                                <tr id="wcTableHeaders">
                                    <th>Metric</th>
                                    <th class="comp-header-1">Week 1</th>
                                    <th class="comp-header-2">Week 2</th>
                                    <th class="comp-header-3">Week 3</th>
                                    <th class="comp-header-4">Week 4</th>
                                </tr>
                            </thead>
                            <tbody id="wcTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold">Line Wise Scrap Value Comparison</div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-hover text-center mb-0 custom-table">
                                <thead class="bg-dark text-white" style="position: sticky; top: 0;">
                                    <tr id="wcLineTableHeaders">
                                        <th>Line No</th>
                                        <th class="comp-header-1">W1 Scrap (₹)</th>
                                        <th class="comp-header-2">W2 Scrap (₹)</th>
                                        <th class="comp-header-3">W3 Scrap (₹)</th>
                                        <th class="comp-header-4">W4 Scrap (₹)</th>
                                    </tr>
                                </thead>
                                <tbody id="wcLineTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold">Scrap Value Trend Chart</div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="wcChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAIL ANALYSIS -->
    <div id="detail-analysis-section" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-dark">Detail Analysis & History</h3>
        </div>

        <div class="card shadow-sm border-0 p-4 bg-white">
            <div class="d-flex gap-4 mb-4 align-items-end flex-wrap">
                <div>
                    <label class="fw-bold small text-secondary">Product Wise</label>
                    <select id="daProduct" class="form-select" style="width: 200px;" onchange="renderDetailLines()">
                        <option value="EARBUDS">Earbuds</option>
                        <option value="CHARGING CASE">Charging Case</option>
                        <option value="SMART WATCH">Smart Watch</option>
                        <option value="DASHCAM">Dashcam</option>
                    </select>
                </div>
                <div>
                    <label class="fw-bold small text-secondary">Process Selection</label>
                    <select id="daType" class="form-select" style="width: 200px;" onchange="renderDetailLines()">
                        <option value="ALL">Total (Proc + RMD)</option>
                        <option value="PROCESS">Process Only</option>
                        <option value="RMD">RMD Only</option>
                    </select>
                </div>
                <div class="text-muted small ms-auto align-self-center">
                    Select a Line below to view detailed history
                </div>
            </div>

            <h6 class="fw-bold text-dark border-bottom pb-2">Select Line (1-24)</h6>
            <div class="line-grid" id="lineGridContainer"></div>
        </div>
    </div>

    <!-- MODAL FOR LINE HISTORY -->
    <div class="modal fade" id="lineHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="lineModalTitle">Line History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-daily">Daily Trend</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-weekly">Week Wise Report</button></li>
                    </ul>

                    <div class="tab-content">
                        <!-- DAILY TAB -->
                        <div class="tab-pane fade show active" id="tab-daily">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <div class="card shadow-sm border-0">
                                        <div class="card-header bg-white fw-bold small">Scrap Value & Rate Trend (Date Wise)</div>
                                        <div class="card-body">
                                            <div class="chart-container-sm">
                                                <canvas id="daTrendCanvas"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card shadow-sm border-0 h-100">
                                        <div class="card-header bg-white fw-bold small text-primary">PCBA Analysis (Qty & Rate)</div>
                                        <div class="card-body">
                                            <div class="chart-container-xs">
                                                <canvas id="daPcbaChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card shadow-sm border-0 h-100">
                                        <div class="card-header bg-white fw-bold small text-warning">Speaker Analysis (Qty & Rate)</div>
                                        <div class="card-body">
                                            <div class="chart-container-xs">
                                                <canvas id="daSpkrChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card shadow-sm border-0 h-100">
                                        <div class="card-header bg-white fw-bold small text-success">Battery Analysis (Qty & Rate)</div>
                                        <div class="card-body">
                                            <div class="chart-container-xs">
                                                <canvas id="daBattChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card shadow-sm border-0">
                                        <div class="card-header bg-white fw-bold small">Model Wise Scrap Breakdown</div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive" style="max-height:200px; overflow-y:auto;">
                                                <table class="table table-sm table-bordered table-striped text-center mb-0" style="font-size:0.8rem;">
                                                    <thead class="bg-dark text-white" style="position:sticky; top:0;">
                                                        <tr>
                                                            <th>Model Name</th>
                                                            <th>Total Scrap Value (₹)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="daModelTableBody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- WEEKLY TAB -->
                        <div class="tab-pane fade" id="tab-weekly">
                            <div class="card shadow-sm border-0 mb-3">
                                <div class="card-header bg-white fw-bold small d-flex justify-content-between align-items-center">
                                    <span>Week Wise Performance</span>
                                    <div class="d-flex gap-2">
                                        <input type="date" id="lineWFrom" class="form-control form-control-sm" style="width:130px">
                                        <input type="date" id="lineWTo" class="form-control form-control-sm" style="width:130px">
                                        <button class="btn btn-sm btn-primary" onclick="filterLineWeeklyTable()">Filter</button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-bordered table-striped text-center mb-0 custom-table">
                                        <thead class="bg-dark text-white">
                                            <tr>
                                                <th>Week Range</th>
                                                <th>Prod Qty</th>
                                                <th>Scrap Value</th>
                                                <th>Scrap Rate %</th>
                                            </tr>
                                        </thead>
                                        <tbody id="daWeeklyTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-white fw-bold small d-flex justify-content-between align-items-center">
                                    <span>All Materials Breakdown</span>
                                    <select id="matSort" class="form-select form-select-sm" style="width:200px;" onchange="filterMaterials()">
                                        <option value="val_desc" selected>Sort Value: High - Low</option>
                                        <option value="val_asc">Sort Value: Low - High</option>
                                        <option value="qty_desc">Sort Qty: High - Low</option>
                                        <option value="qty_asc">Sort Qty: Low - High</option>
                                    </select>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-sm table-hover text-center mb-0" style="font-size:0.8rem">
                                            <thead class="bg-primary text-white" style="position:sticky; top:0; z-index:10;">
                                                <tr>
                                                    <th>Material Description</th>
                                                    <th>Model</th>
                                                    <th>Type</th>
                                                    <th style="width:100px;">Total Qty</th>
                                                    <th style="width:120px;">Total Value (₹)</th>
                                                </tr>
                                                <tr class="bg-light">
                                                    <th><input type="text" id="sDesc" class="filter-input" placeholder="Search..." onkeyup="filterMaterials()"></th>
                                                    <th><input type="text" id="sModel" class="filter-input" placeholder="Search..." onkeyup="filterMaterials()"></th>
                                                    <th><input type="text" id="sType" class="filter-input" placeholder="Search..." onkeyup="filterMaterials()"></th>
                                                    <th><input type="text" id="sQty" class="filter-input" placeholder="Filter..." onkeyup="filterMaterials()"></th>
                                                    <th><input type="text" id="sVal" class="filter-input" placeholder="Filter..." onkeyup="filterMaterials()"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="daMatTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- MODEL ANALYSIS -->
    <div id="model-analysis-section" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold text-dark">Model Wise Analysis</h3>
        </div>

        <div class="bg-white p-3 rounded shadow-sm mb-4 d-flex gap-4 align-items-center flex-wrap">
            <div>
                <label class="small fw-bold text-secondary">Product</label>
                <select id="modelGraphProduct" class="form-select form-select-sm" style="width:150px" onchange="renderModelAnalysisTabs()">
                    <option value="ALL">All Products</option>
                    <option value="EARBUDS">Earbuds</option>
                    <option value="CHARGING CASE">Charging Case</option>
                    <option value="SMART WATCH">Smart Watch</option>
                    <option value="DASHCAM">Dashcam</option>
                </select>
            </div>
            <div>
                <label class="small fw-bold text-secondary">Type</label>
                <select id="modelGraphType" class="form-select form-select-sm" style="width:150px" onchange="renderModelAnalysisTabs()">
                    <option value="ALL">Total (Proc + RMD)</option>
                    <option value="PROCESS">Process Only</option>
                    <option value="RMD">RMD Only</option>
                </select>
            </div>
            <div>
                <label class="small fw-bold text-secondary">Component</label>
                <select id="modelGraphComp" class="form-select form-select-sm" style="width:150px" onchange="renderModelAnalysisTabs()">
                    <option value="ALL">All Components</option>
                    <option value="PCBA">PCBA</option>
                    <option value="SPEAKER">Speaker</option>
                    <option value="BATTERY">Battery</option>
                </select>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="modelTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="val-tab" data-bs-toggle="tab" data-bs-target="#val-content" type="button" role="tab" aria-selected="true"><i class="fas fa-rupee-sign me-2"></i>Value Wise Analysis</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="qty-tab" data-bs-toggle="tab" data-bs-target="#qty-content" type="button" role="tab" aria-selected="false"><i class="fas fa-boxes me-2"></i>Qty Wise Analysis</button>
            </li>
        </ul>

        <div class="tab-content" id="modelTabsContent">
            
            <!-- TAB 1: VALUE WISE -->
            <div class="tab-pane fade show active" id="val-content" role="tabpanel">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold py-2 text-success">Top Models by Scrap Value (INR)</div>
                    <div class="card-body">
                        <div style="height: 400px; width: 100%;">
                            <canvas id="modelValueCanvas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white fw-bold py-3"><i class="fas fa-table me-2"></i> Value Wise Data</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped custom-table text-center mb-0">
                                <thead class="bg-dark text-white">
                                    <tr>
                                        <th rowspan="2" class="align-middle">#</th>
                                        <th rowspan="2" class="align-middle">Model Name</th>
                                        <th rowspan="2" class="align-middle">Prod Qty (Sets)</th>
                                        <th rowspan="2" class="align-middle">Prod Value (₹)</th>
                                        <th colspan="2" class="bg-white text-dark">Charging case</th>
                                        <th colspan="2" class="bg-white text-dark">Earbuds</th>
                                        <th rowspan="2" class="align-middle">Overall process</th>
                                        <th rowspan="2" class="align-middle">Scrap rate %</th>
                                    </tr>
                                    <tr>
                                        <th class="bg-light text-dark">Scrap Value (₹)</th>
                                        <th class="bg-light text-dark">Scrap Rate %</th>
                                        <th class="bg-light text-dark">Scrap Value (₹)</th>
                                        <th class="bg-light text-dark">Scrap Rate %</th>
                                    </tr>
                                    <tr class="bg-secondary p-0">
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(0, 'num', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">1-9</option><option value="desc">9-1</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(1, 'text', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">A-Z</option><option value="desc">Z-A</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(2, 'num', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(3, 'num', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(4, 'num', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(5, 'num', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(6, 'num', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(7, 'num', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(8, 'num', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(9, 'num', this, 'modelValueTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                    </tr>
                                </thead>
                                <tbody id="modelValueTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: QTY WISE -->
            <div class="tab-pane fade" id="qty-content" role="tabpanel">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold py-2 text-primary">Top Models by Scrap Quantity</div>
                    <div class="card-body">
                        <div style="height: 400px; width: 100%;">
                            <canvas id="modelQtyCanvas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white fw-bold py-3"><i class="fas fa-table me-2"></i> Qty Wise Data</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped custom-table text-center mb-0">
                                <thead class="bg-primary text-white">
                                    <tr>
                                        <th rowspan="2" class="align-middle">#</th>
                                        <th rowspan="2" class="align-middle">Model Name</th>
                                        <th rowspan="2" class="align-middle">Prod Qty (Sets)</th>
                                        <th colspan="2" class="bg-white text-dark">Charging case (1x)</th>
                                        <th colspan="2" class="bg-white text-dark">Earbuds (2x)</th>
                                        <th rowspan="2" class="align-middle">Total Scrap Qty</th>
                                    </tr>
                                    <tr>
                                        <th class="bg-light text-dark">Scrap Qty</th>
                                        <th class="bg-light text-dark">Rate %</th>
                                        <th class="bg-light text-dark">Scrap Qty</th>
                                        <th class="bg-light text-dark">Rate %</th>
                                    </tr>
                                    <tr class="bg-secondary p-0">
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(0, 'num', this, 'modelQtyTableBody')"><option value="" disabled selected>Sort</option><option value="asc">1-9</option><option value="desc">9-1</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(1, 'text', this, 'modelQtyTableBody')"><option value="" disabled selected>Sort</option><option value="asc">A-Z</option><option value="desc">Z-A</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(2, 'num', this, 'modelQtyTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(3, 'num', this, 'modelQtyTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(4, 'num', this, 'modelQtyTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(5, 'num', this, 'modelQtyTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(6, 'num', this, 'modelQtyTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                        <th class="p-1"><select class="sort-select" onchange="triggerModelSort(7, 'num', this, 'modelQtyTableBody')"><option value="" disabled selected>Sort</option><option value="asc">Low</option><option value="desc">High</option></select></th>
                                    </tr>
                                </thead>
                                <tbody id="modelQtyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- LINE ANALYSIS -->
    <div id="line-analysis-section" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold text-dark">Line Wise Component Analysis</h3>
        </div>

        <div class="bg-white p-3 rounded shadow-sm mb-4 d-flex gap-3 align-items-center flex-wrap">
            <div>
                <label class="small fw-bold text-secondary">Product</label>
                <select id="laProduct" class="form-select form-select-sm" style="width:160px" onchange="processAndRender()">
                    <option value="ALL">All Products</option>
                    <option value="EARBUDS">Earbuds</option>
                    <option value="CHARGING CASE">Charging Case</option>
                    <option value="SMART WATCH">Smart Watch</option>
                    <option value="DASHCAM">Dashcam</option>
                </select>
            </div>
            <div>
                <label class="small fw-bold text-secondary">Type</label>
                <select id="laType" class="form-select form-select-sm" style="width:160px" onchange="processAndRender()">
                    <option value="ALL">Total (Proc + RMD)</option>
                    <option value="PROCESS">Process Only</option>
                    <option value="RMD">RMD Only</option>
                </select>
            </div>
            <div>
                <label class="small fw-bold text-secondary">Graph Focus</label>
                <select id="laComponent" class="form-select form-select-sm" style="width:160px" onchange="processAndRender()">
                    <option value="ALL">All Components</option>
                    <option value="PCBA">PCBA Only</option>
                    <option value="SPEAKER">Speaker Only</option>
                    <option value="BATTERY">Battery Only</option>
                </select>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white fw-bold py-2">Pareto Analysis: Scrap Qty & Rate %</div>
            <div class="card-body">
                <div style="height: 400px; width: 100%;">
                    <canvas id="componentAnalysisCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white fw-bold py-3"><i class="fas fa-table me-2"></i> Detailed Data</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped custom-table text-center mb-0" id="compTable">
                        <thead>
                            <tr>
                                <th rowspan="2" class="align-middle bg-dark text-white">Line No
                                    <select class="sort-select mt-1" onchange="triggerCompSort(0, 'text', this)"><option value="" disabled selected>Sort</option><option value="asc">A-Z</option><option value="desc">Z-A</option></select>
                                </th>
                                <th rowspan="2" class="align-middle bg-dark text-white">Product
                                    <select class="sort-select mt-1" id="laTableProdFilter" onchange="applyCompProdFilter(this)">
                                        <option value="">All</option>
                                        <option value="EARBUDS">Earbuds</option>
                                        <option value="CHARGING CASE">Case</option>
                                        <option value="SMART WATCH">Watch</option>
                                        <option value="DASHCAM">Dashcam</option>
                                    </select>
                                </th>
                                <th rowspan="2" class="align-middle bg-dark text-white">Prod Qty
                                    <select class="sort-select mt-1" onchange="triggerCompSort(2, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Small &#10142; Large</option><option value="desc">Large &#10142; Small</option></select>
                                </th>
                                <th colspan="2" class="bg-primary text-white">PCBA</th>
                                <th colspan="2" class="bg-warning text-dark">SPEAKER</th>
                                <th colspan="2" class="bg-success text-white">BATTERY</th>
                            </tr>
                            <tr>
                                <th class="bg-light text-dark">Qty <select class="sort-select" onchange="triggerCompSort(3, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Small &#10142; Large</option><option value="desc">Large &#10142; Small</option></select></th>
                                <th class="bg-light text-dark">Rate % <select class="sort-select" onchange="triggerCompSort(4, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Small &#10142; Large</option><option value="desc">Large &#10142; Small</option></select></th>
                                <th class="bg-light text-dark">Qty <select class="sort-select" onchange="triggerCompSort(5, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Small &#10142; Large</option><option value="desc">Large &#10142; Small</option></select></th>
                                <th class="bg-light text-dark">Rate % <select class="sort-select" onchange="triggerCompSort(6, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Small &#10142; Large</option><option value="desc">Large &#10142; Small</option></select></th>
                                <th class="bg-light text-dark">Qty <select class="sort-select" onchange="triggerCompSort(7, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Small &#10142; Large</option><option value="desc">Large &#10142; Small</option></select></th>
                                <th class="bg-light text-dark">Rate % <select class="sort-select" onchange="triggerCompSort(8, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Small &#10142; Large</option><option value="desc">Large &#10142; Small</option></select></th>
                            </tr>
                        </thead>
                        <tbody id="compTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Sections -->
    <div id="upload-section" class="content-section" style="display:none;">
        <h4 class="mb-4">Bulk Upload</h4>
        <div class="card p-5 text-center shadow-sm">
            <div class="border dashed p-5 bg-white rounded"><input type="file" id="uploadFile" class="form-control w-50 mx-auto mb-3" accept=".xlsx"><button class="btn btn-primary" onclick="uploadExcel()">Upload</button></div>
        </div>
    </div>

    <!-- PRODUCTION ENTRY SECTION -->
    <div id="production-section" class="content-section" style="display:none;">
        <h4 class="mb-4">Production Entry</h4>
        <div class="card p-4 shadow-sm" style="max-width: 500px;">
            <form id="prodForm">
                <label class="form-label fw-bold">Date</label>
                <input type="date" id="pDate" class="form-control mb-3">
                <label class="form-label fw-bold">Line Number</label>
                <input type="text" id="pLine" class="form-control mb-3" placeholder="e.g. 303">
                <label class="form-label fw-bold">Product Type</label>
                <select id="pProduct" class="form-select mb-3">
                    <option value="" disabled selected>Select Product</option>
                    <option value="Earbuds & Charging case">Earbuds & Charging case</option>
                    <option value="Dashcam">Dashcam</option>
                    <option value="Smart Watch">Smart Watch</option>
                    <option value="Headphone">Headphone</option>
                    <option value="Other">Other</option>
                </select>
                <label class="form-label fw-bold">Model</label>
                <select id="pModel" class="form-select mb-3"></select>
                <label class="form-label fw-bold">Output Qty</label>
                <input type="number" id="pOut" class="form-control mb-3" placeholder="0">
                <button type="button" class="btn btn-success w-100" onclick="saveProduction()">Save Production</button>
            </form>
        </div>
    </div>
</div>

<!-- BootStrap JS (Required for Tabs) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyD8FFtDs-2BR-9k2UkvdhaMcF1WrCWoVNOYcm8qI9aq0uT8OntsthgjgMIwNFlyFCtGw/exec"; 

    Chart.register(ChartDataLabels);

    let rawData = { production: [], scrap: [], models: [] };
    let modelPrices = {};
    let aggregatedModelData = {}; 
    
    // Global Chart Instances
    let scrapTrendChart = null;
    let componentChart = null;
    let modelValueChart = null;
    let modelQtyChart = null;
    let daTrendChart = null;
    let daPcbaChart = null;
    let daSpkrChart = null;
    let daBattChart = null;
    let wcChart = null;
    let caChart = null; 

    let currentMaterialsList = [];
    let currentLineWeeklyData = {}; 

    window.onload = function() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
        document.getElementById('dateTo').value = today.toISOString().split('T')[0];
        loadData();
    };

    function switchSection(id) {
        document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
        document.getElementById(id + '-section').style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => {
             if(l.getAttribute('onclick') && l.getAttribute('onclick').includes(id)) l.classList.add('active');
        });
        if (id === 'detail-analysis') { renderDetailLines(); }
        if (id === 'category-analysis') { renderCategoryAnalysis(); }
    }

    async function loadData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            let res = await fetch(API_URL);
            let json = await res.json();
            if(!json.production || !json.scrap) throw new Error("Invalid Data Structure");
            rawData = json;
            if(json.models) {
                let pSelect = document.getElementById('pModel');
                pSelect.innerHTML = "";
                json.models.slice(1).forEach(r => {
                    let mName = (r[0] || "").toString().trim().toUpperCase();
                    modelPrices[mName] = parseFloat(r[1]) || 0;
                    pSelect.add(new Option(r[0], r[0]));
                });
            }
            processAndRender();
        } catch(e) { 
            console.error(e);
            Swal.fire("Error", "Details: " + e.message, "error"); 
        }
        document.getElementById('loader').style.display = 'none';
    }

    function normalizeDate(dateInput) {
        if(!dateInput) return null;
        if (typeof dateInput === 'string') return dateInput.substring(0, 10);
        if (typeof dateInput === 'number') {
            const date = new Date(Math.round((dateInput - 25569) * 86400 * 1000));
            return date.toISOString().substring(0, 10);
        }
        let d = new Date(dateInput);
        if(isNaN(d.getTime())) return null;
        return d.toISOString().substring(0, 10);
    }

    function normalizeLine(str) { return str ? str.toString().toUpperCase().trim().replace("L-", "").replace("LINE", "").replace(/^0+/, '') : "Unknown"; }
    
    function formatCurrency(val) {
        if (val >= 10000000) return "₹" + (val / 10000000).toFixed(2) + "Cr";
        if (val >= 100000) return "₹" + (val / 100000).toFixed(2) + "L";
        if (val >= 1000) return "₹" + (val / 1000).toFixed(2) + "K";
        return "₹" + Math.round(val).toLocaleString();
    }
    
    function getProductCategory(prodStr, lineStr) {
        let p = (prodStr || "").toString().toUpperCase();
        let l = (lineStr || "").toString().toUpperCase();
        let combined = p + " " + l;
        if(combined.includes('DASHCAM') || combined.includes('DASH CAM')) return 'DASHCAM';
        if(combined.includes('WATCH')) return 'SMART WATCH';
        if(combined.includes('HEADPHONE')) return 'HEADPHONE';
        if(combined.includes('CHARGING') || combined.includes('CASE')) return 'CHARGING CASE';
        if(combined.includes('BUD') || combined.includes('EAR') || combined.includes('TWS') || combined.includes('AIR') || combined.includes('ANC') || combined.includes('ENC') || combined.includes('POD')) return 'EARBUDS';
        return 'OTHER';
    }

    function processAndRender() {
        if(document.getElementById('category-analysis-section').style.display !== 'none') {
            renderCategoryAnalysis();
        }
        
        const dFrom = document.getElementById('dateFrom').value;
        const dTo = document.getElementById('dateTo').value;
        const defectFilter = document.getElementById('filterDefect').value;
        let lineDominantCategory = {}; 
        if(rawData.scrap.length > 0) {
            rawData.scrap.slice(1).forEach(row => {
                let ln = normalizeLine(row[4]); 
                let floorVal = row[5]; 
                let cat = getProductCategory(floorVal, ln); 
                if(cat !== 'OTHER') lineDominantCategory[ln] = cat; 
            });
        }
        let prodMap = {}; 
        let lineProdQtyMap = {}; 
        let totalProdQty=0, totalProdVal=0;
        aggregatedModelData = {};

        if(rawData.production.length > 0) {
            rawData.production.slice(1).forEach(row => {
                let rDate = normalizeDate(row[0]);
                if (!rDate || rDate < dFrom || rDate > dTo) return;
                let ln = normalizeLine(row[3]); 
                let model = (row[2] || "").toString().trim().toUpperCase(); 
                let rawOut = parseFloat(row[4]) || 0; 
                let productCol = (row[1] || "").toString().toUpperCase(); 
                let val = rawOut * (modelPrices[model]||0); 
                let cat = "OTHER";
                if(productCol !== "") cat = getProductCategory(productCol, "");
                else {
                    cat = getProductCategory(model, ln);
                    if(cat === 'OTHER' && lineDominantCategory[ln]) cat = lineDominantCategory[ln];
                }
                if(!prodMap[ln]) prodMap[ln] = 0;
                prodMap[ln] += val; 
                if(productCol.includes("EARBUDS") && productCol.includes("CHARGING")) {
                    let keyE = ln + "|EARBUDS"; if(!lineProdQtyMap[keyE]) lineProdQtyMap[keyE] = 0; lineProdQtyMap[keyE] += rawOut;
                    let keyC = ln + "|CHARGING CASE"; if(!lineProdQtyMap[keyC]) lineProdQtyMap[keyC] = 0; lineProdQtyMap[keyC] += rawOut;
                } else {
                    let key = ln + "|" + cat; if(!lineProdQtyMap[key]) lineProdQtyMap[key] = 0; lineProdQtyMap[key] += rawOut;
                }
                totalProdQty += rawOut;
                totalProdVal += val;
            });
        }

        let lineStats = {}; 
        let lineCompStats = {}; 
        let overallStats = { proc:0, rmd:0, tot:0 };
        let productStats = { 'EARBUDS': { val: 0, proc: 0, rmd: 0 }, 'CHARGING CASE': { val: 0, proc: 0, rmd: 0 }, 'SMART WATCH': { val: 0, proc: 0, rmd: 0 }, 'HEADPHONE': { val: 0, proc: 0, rmd: 0 }, 'DASHCAM': { val: 0, proc: 0, rmd: 0 }, 'OTHER': { val: 0, proc: 0, rmd: 0 } };

        if(rawData.scrap.length > 0) {
            rawData.scrap.slice(1).forEach(row => {
                let rDate = normalizeDate(row[0]);
                if (!rDate || rDate < dFrom || rDate > dTo) return;
                let ln = normalizeLine(row[4]); 
                let floorVal = row[5]; 
                let model = (row[8] || "").toString().trim().toUpperCase(); 
                let prodName = getProductCategory(floorVal, ln);
                if(!productStats[prodName]) prodName = 'OTHER';
                let typeVal = (row[9]||"").toString().toUpperCase(); 
                let rejTypeVal = (row[10] || "").toString().toUpperCase(); 
                let fullType = typeVal + " " + rejTypeVal; 
                if(defectFilter !== 'ALL' && !typeVal.includes(defectFilter)) return;
                let q = parseFloat(row[12])||0; 
                let val = q * (parseFloat(row[11])||0); 
                let storeVal = String(row[1] || "").toUpperCase(); 
                let isProc = storeVal.includes('6003') || storeVal.includes('PROCESS') || rejTypeVal.includes('PROCESS');
                let isRMD = storeVal.includes('6002') || storeVal.includes('RMD') || rejTypeVal.includes('RMD');
                let key = ln + "_" + prodName; 
                if(!lineStats[key]) lineStats[key] = { ln: ln, cat: prodName, proc:0, rmd:0, total:0 };
                if(isProc) { lineStats[key].proc += val; overallStats.proc += val; productStats[prodName].proc += val; } 
                else if(isRMD) { lineStats[key].rmd += val; overallStats.rmd += val; productStats[prodName].rmd += val; }
                lineStats[key].total += val;
                overallStats.tot += val;
                let compKey = ln + "|" + prodName;
                if(!lineCompStats[compKey]) lineCompStats[compKey] = { ln: ln, cat: prodName, raw: { pcba_proc:0, pcba_rmd:0, spkr_proc:0, spkr_rmd:0, batt_proc:0, batt_rmd:0 } };
                let compType = "";
                if(fullType.includes("PCBA") || fullType.includes("MAIN BOARD") || fullType.includes("PCB")) compType = "pcba";
                else if(fullType.includes("BATTERY") || fullType.includes("CELL") || fullType.includes("BATT")) compType = "batt";
                else if(fullType.includes("SPEAKER") || fullType.includes("DRIVER") || fullType.includes("SPK")) compType = "spkr";
                if(compType) {
                    if(isProc) lineCompStats[compKey].raw[compType + "_proc"] += q;
                    else if(isRMD) lineCompStats[compKey].raw[compType + "_rmd"] += q;
                }
            });
        }

        document.getElementById('ovr-qty').innerText = totalProdQty.toLocaleString();
        document.getElementById('ovr-val').innerText = formatCurrency(totalProdVal);
        document.getElementById('ovr-proc-val').innerText = formatCurrency(overallStats.proc);
        document.getElementById('ovr-rmd-val').innerText = formatCurrency(overallStats.rmd);
        document.getElementById('ovr-tot-val').innerText = formatCurrency(overallStats.tot);
        document.getElementById('ovr-proc-rate').innerText = totalProdVal>0?((overallStats.proc/totalProdVal)*100).toFixed(2)+"%":"0%";
        document.getElementById('ovr-rmd-rate').innerText = totalProdVal>0?((overallStats.rmd/totalProdVal)*100).toFixed(2)+"%":"0%";
        document.getElementById('ovr-all-rate').innerText = totalProdVal>0?((overallStats.tot/totalProdVal)*100).toFixed(2)+"%":"0%";

        Object.keys(prodMap).forEach(ln => {
            let val = prodMap[ln];
            let potentialCats = [];
            Object.values(lineStats).forEach(s => { if(s.ln === ln && !potentialCats.includes(s.cat)) potentialCats.push(s.cat); });
            if(potentialCats.length === 0) { let guessed = getProductCategory('', ln); potentialCats.push(guessed !== 'OTHER' ? guessed : 'EARBUDS'); }
            potentialCats.forEach(cat => {
                if(productStats[cat]) productStats[cat].val += val;
                let key = ln + "_" + cat;
                if(!lineStats[key]) lineStats[key] = { ln: ln, cat: cat, proc:0, rmd:0, total:0 };
                if(!lineStats[key].prodVal) lineStats[key].prodVal = 0;
                lineStats[key].prodVal += val;
            });
        });

        const prodContainer = document.getElementById('productSummaryContainer');
        prodContainer.innerHTML = "";
        const productsToCheck = ['EARBUDS', 'CHARGING CASE', 'SMART WATCH', 'HEADPHONE', 'DASHCAM'];
        const prodColors = { 'EARBUDS': '#0d6efd', 'CHARGING CASE': '#dc3545', 'SMART WATCH': '#198754', 'HEADPHONE': '#6610f2', 'DASHCAM': '#212529', 'OTHER': '#6c757d' };
        productsToCheck.forEach(cat => {
            let s = productStats[cat];
            if(s.val > 0 || s.proc > 0 || s.rmd > 0) {
                let pRate = s.val > 0 ? (s.proc/s.val)*100 : 0;
                let rRate = s.val > 0 ? (s.rmd/s.val)*100 : 0;
                let card = `<div class="prod-summary-card"><div class="prod-header" style="background:${prodColors[cat]}">${cat}</div>
                <div class="prod-body"><div class="prod-stat border-end"><div class="prod-stat-val text-dark">${formatCurrency(s.proc)}</div>
                <div class="prod-stat-rate text-warning">${pRate.toFixed(2)}%</div><div class="prod-stat-lbl">Process</div></div>
                <div class="prod-stat"><div class="prod-stat-val text-dark">${formatCurrency(s.rmd)}</div>
                <div class="prod-stat-rate text-info">${rRate.toFixed(2)}%</div><div class="prod-stat-lbl">RMD</div></div></div></div>`;
                prodContainer.innerHTML += card;
            }
        });

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        let allKeys = Object.keys(lineStats);
        allKeys.sort((a,b) => lineStats[b].total - lineStats[a].total);
        allKeys.forEach(k => {
            let s = lineStats[k];
            let pVal = s.prodVal || 0;
            let pRate = pVal>0 ? (s.proc/pVal)*100 : 0;
            let rRate = pVal>0 ? (s.rmd/pVal)*100 : 0;
            let tRate = pVal>0 ? (s.total/pVal)*100 : 0;
            let pClass = pRate <= 0.20 ? 'text-success' : (pRate <= 0.25 ? 'text-orange' : 'text-danger');
            let bClass = s.cat === 'EARBUDS' ? 'bg-primary' : (s.cat === 'CHARGING CASE' ? 'bg-danger' : (s.cat === 'SMART WATCH' ? 'bg-success' : 'bg-dark'));
            
            let row = `<tr><td class="fw-bold" data-val="${s.ln}">${s.ln}</td><td data-val="${s.cat}"><span class="badge ${bClass} badge-prod">${s.cat}</span></td>
            <td class="text-muted small fw-bold" data-val="${pVal}">${formatCurrency(pVal)}</td><td class="text-warning fw-bold" data-val="${s.proc}">${formatCurrency(s.proc)}</td>
            <td class="${pClass} small fw-bold" data-val="${pRate}">${pRate.toFixed(2)}%</td><td class="text-info fw-bold" data-val="${s.rmd}">${formatCurrency(s.rmd)}</td>
            <td class="small text-muted fw-bold" data-val="${rRate}">${rRate.toFixed(2)}%</td><td class="text-danger fw-bold border-start border-2" data-val="${s.total}">${formatCurrency(s.total)}</td>
            <td class="fw-bold text-danger" data-val="${tRate}">${tRate.toFixed(2)}%</td></tr>`;
            tbody.innerHTML += row;
        });

        renderTrendChart();
        renderLineComponentAnalysis(lineCompStats, lineProdQtyMap);
        renderModelAnalysisTabs();
    }

    function getFloorFromLine(lineStr) {
        let ln = parseInt(lineStr.replace(/\D/g, ''));
        if (isNaN(ln)) return "Unknown";
        if (ln >= 1 && ln <= 8) return "1"; // 1st Floor
        if (ln >= 9 && ln <= 16) return "2"; // 2nd Floor
        if (ln >= 17 && ln <= 24) return "B"; // Basement
        return "Unknown";
    }

    function renderCategoryAnalysis() {
        const dFrom = document.getElementById('dateFrom').value;
        const dTo = document.getElementById('dateTo').value;
        const floorFilter = document.getElementById('caFloor').value;
        const typeFilter = document.getElementById('caType').value;

        let totalFloorProdVal = 0;
        // Step 1: Calculate Total Production Value
        if(rawData.production.length > 0) {
            rawData.production.slice(1).forEach(row => {
                let d = normalizeDate(row[0]);
                if(!d || d < dFrom || d > dTo) return;
                
                let ln = normalizeLine(row[3]);
                let floor = getFloorFromLine(ln);
                
                if (floorFilter !== 'ALL' && floor !== floorFilter) return;

                let model = (row[2] || "").toString().trim().toUpperCase();
                let rawOut = parseFloat(row[4]) || 0;
                let val = rawOut * (modelPrices[model]||0);
                totalFloorProdVal += val;
            });
        }

        let cats = { 'FRESH': 0, 'REWORK': 0, 'WIP': 0, 'OLD WIP': 0, 'SHORT': 0, 'OTHER': 0 };

        // Step 2: Iterate Scrap Data
        if(rawData.scrap.length > 0) {
            rawData.scrap.slice(1).forEach(row => {
                let d = normalizeDate(row[0]);
                if(!d || d < dFrom || d > dTo) return;

                let ln = normalizeLine(row[4]);
                let floor = getFloorFromLine(ln);

                if (floorFilter !== 'ALL' && floor !== floorFilter) return;

                let storeVal = String(row[1] || "").toUpperCase();
                let rejTypeVal = (row[10] || "").toString().toUpperCase();
                
                let isProc = storeVal.includes('6003') || storeVal.includes('PROCESS') || rejTypeVal.includes('PROCESS');
                let isRMD = storeVal.includes('6002') || storeVal.includes('RMD') || rejTypeVal.includes('RMD');

                if (typeFilter === 'PROCESS' && !isProc) return;
                if (typeFilter === 'RMD' && !isRMD) return;

                let q = parseFloat(row[12])||0;
                let val = q * (parseFloat(row[11])||0);
                
                // Using Column O (Index 14) for Category
                let categoryStr = (row[14] || "").toString().toUpperCase();

                if (categoryStr.includes("FRESH")) { cats['FRESH'] += val; }
                else if (categoryStr.includes("REWORK")) { cats['REWORK'] += val; }
                else if (categoryStr.includes("OLD WIP")) { cats['OLD WIP'] += val; } 
                else if (categoryStr.includes("WIP")) { cats['WIP'] += val; } 
                else if (categoryStr.includes("SHORT")) { cats['SHORT'] += val; }
                else { cats['OTHER'] += val; }
            });
        }

        // Step 3: Render Table with Subtotal
        const tbody = document.getElementById('caTableBody');
        tbody.innerHTML = "";
        let labels = ['FRESH', 'REWORK', 'WIP', 'OLD WIP', 'SHORT'];
        let chartData = [];
        let chartColors = ['#28a745', '#ffc107', '#17a2b8', '#6c757d', '#dc3545'];
        
        let totalScrapDisplayed = 0;

        labels.forEach(lbl => {
            let sVal = cats[lbl];
            let rate = totalFloorProdVal > 0 ? (sVal / totalFloorProdVal * 100) : 0;
            chartData.push(sVal);
            totalScrapDisplayed += sVal;
            
            let row = `<tr>
                <td class="fw-bold text-start">${lbl}</td>
                <td class="fw-bold">${formatCurrency(sVal)}</td>
                <td class="text-danger fw-bold">${rate.toFixed(3)}%</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        if(cats['OTHER'] > 0) {
            let sVal = cats['OTHER'];
            let rate = totalFloorProdVal > 0 ? (sVal / totalFloorProdVal * 100) : 0;
            totalScrapDisplayed += sVal;
             let row = `<tr>
                <td class="fw-bold text-start text-muted">OTHER</td>
                <td class="fw-bold text-muted">${formatCurrency(sVal)}</td>
                <td class="text-muted">${rate.toFixed(3)}%</td>
            </tr>`;
            tbody.innerHTML += row;
        }

        // Add Subtotal Row
        let totalRate = totalFloorProdVal > 0 ? (totalScrapDisplayed / totalFloorProdVal * 100) : 0;
        tbody.innerHTML += `<tr class="bg-secondary text-white fw-bold">
            <td class="text-end text-uppercase">Subtotal</td>
            <td>${formatCurrency(totalScrapDisplayed)}</td>
            <td>${totalRate.toFixed(3)}%</td>
        </tr>`;

        const ctx = document.getElementById('caChartCanvas').getContext('2d');
        if (caChart) caChart.destroy();

        caChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Scrap Value (₹)',
                    data: chartData,
                    backgroundColor: chartColors,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        color: '#000',
                        anchor: 'end',
                        align: 'top',
                        formatter: (val) => val > 0 ? formatCurrency(val) : ''
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function renderWeeklyComparison() {
        const ranges = [
            { from: document.getElementById('wcFrom1').value, to: document.getElementById('wcTo1').value, name: 'Week 1' },
            { from: document.getElementById('wcFrom2').value, to: document.getElementById('wcTo2').value, name: 'Week 2' },
            { from: document.getElementById('wcFrom3').value, to: document.getElementById('wcTo3').value, name: 'Week 3' },
            { from: document.getElementById('wcFrom4').value, to: document.getElementById('wcTo4').value, name: 'Week 4' }
        ];

        const productFilter = document.getElementById('wcProductInput').value;
        const diffMode = document.getElementById('wcDiffSelect').value;

        // NEW: Get selected categories
        let selectedCats = [];
        document.querySelectorAll('.wc-cat-filter:checked').forEach(el => selectedCats.push(el.value));

        if(!ranges[0].from || !ranges[0].to || !ranges[1].from || !ranges[1].to) {
            Swal.fire("Inputs Missing", "Please select at least Week 1 and Week 2 ranges", "warning");
            return;
        }

        function calculateStats(start, end) {
            let stats = { prodQty:0, prodVal:0, scrapVal:0, proc:0, rmd:0, pcba:0, batt:0, spkr:0, lineBreakdown: {} };
            if(!start || !end) return stats;

            rawData.production.slice(1).forEach(row => {
                let d = normalizeDate(row[0]);
                if(!d || d < start || d > end) return;
                let ln = normalizeLine(row[3]); 
                let model = (row[2] || "").toString().trim().toUpperCase();
                let productCol = (row[1] || "").toString().toUpperCase(); 
                let cat = productCol !== "" ? getProductCategory(productCol, "") : getProductCategory(model, ln);
                let isCombo = productCol.includes("EARBUDS") && productCol.includes("CHARGING");
                if(productFilter !== 'ALL') {
                    if (isCombo) { if (productFilter !== 'EARBUDS' && productFilter !== 'CHARGING CASE') return; } else { if (cat !== productFilter) return; }
                }
                let rawOut = parseFloat(row[4]) || 0;
                let val = rawOut * (modelPrices[model]||0);
                stats.prodQty += rawOut;
                stats.prodVal += val;
            });

            rawData.scrap.slice(1).forEach(row => {
                let d = normalizeDate(row[0]);
                if(!d || d < start || d > end) return;
                
                // NEW: CATEGORY MULTI-SELECT LOGIC
                let rowCat = (row[14] || "").toString().toUpperCase(); // Column O (Index 14)
                let rowCatType = "OTHER";
                if (rowCat.includes("FRESH")) rowCatType = "FRESH";
                else if (rowCat.includes("REWORK")) rowCatType = "REWORK";
                else if (rowCat.includes("OLD WIP")) rowCatType = "OLD WIP";
                else if (rowCat.includes("WIP")) rowCatType = "WIP";
                else if (rowCat.includes("SHORT")) rowCatType = "SHORT";

                // Filter Logic: Only include if selectedCats includes the row's category type
                if (selectedCats.length > 0) {
                    if (!selectedCats.includes(rowCatType)) return;
                }

                let ln = normalizeLine(row[4]); 
                let floorVal = row[5]; 
                let cat = getProductCategory(floorVal, ln);
                if(productFilter !== 'ALL' && cat !== productFilter) return;
                let q = parseFloat(row[12])||0;
                let val = q * (parseFloat(row[11])||0);
                let typeVal = (row[9]||"").toString().toUpperCase(); 
                let rejTypeVal = (row[10] || "").toString().toUpperCase();
                let storeVal = String(row[1] || "").toUpperCase();
                let isProc = storeVal.includes('6003') || storeVal.includes('PROCESS') || rejTypeVal.includes('PROCESS');
                stats.scrapVal += val;
                if(isProc) stats.proc += val; else stats.rmd += val;
                let fullType = typeVal + " " + rejTypeVal; 
                if(fullType.includes("PCBA") || fullType.includes("MAIN BOARD")) stats.pcba += q;
                if(fullType.includes("BATTERY") || fullType.includes("CELL")) stats.batt += q;
                if(fullType.includes("SPEAKER") || fullType.includes("DRIVER")) stats.spkr += q;
                if(!stats.lineBreakdown[ln]) stats.lineBreakdown[ln] = 0;
                stats.lineBreakdown[ln] += val;
            });
            return stats;
        }

        let results = ranges.map(r => calculateStats(r.from, r.to));
        
        let thRow = `<th>Metric</th><th class="comp-header-1">Week 1</th><th class="comp-header-2">Week 2</th><th class="comp-header-3">Week 3</th><th class="comp-header-4">Week 4</th>`;
        let lineThRow = `<th>Line No <select class="sort-select mt-1" onchange="triggerWcSort(0, 'text', this)"><option value="" disabled selected>Sort</option><option value="asc">A-Z</option><option value="desc">Z-A</option></select></th>`;
        lineThRow += `<th class="comp-header-1">W1 Scrap (₹) <select class="sort-select mt-1" onchange="triggerWcSort(1, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>`;
        lineThRow += `<th class="comp-header-2">W2 Scrap (₹) <select class="sort-select mt-1" onchange="triggerWcSort(2, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>`;
        lineThRow += `<th class="comp-header-3">W3 Scrap (₹) <select class="sort-select mt-1" onchange="triggerWcSort(3, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>`;
        lineThRow += `<th class="comp-header-4">W4 Scrap (₹) <select class="sort-select mt-1" onchange="triggerWcSort(4, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>`;
        
        let diffLabel = "";
        let iA = -1, iB = -1;
        if(diffMode !== 'none') {
            let parts = diffMode.split('_');
            iA = parseInt(parts[0]);
            iB = parseInt(parts[1]);
            diffLabel = `Diff (W${iA+1}-W${iB+1})`;
            thRow += `<th class="comp-header-diff">${diffLabel}</th>`;
            lineThRow += `<th class="comp-header-diff">${diffLabel} <select class="sort-select mt-1" onchange="triggerWcSort(5, 'num', this)"><option value="" disabled selected>Sort</option><option value="asc">Low-High</option><option value="desc">High-Low</option></select></th>`;
        }
        document.getElementById('wcTableHeaders').innerHTML = thRow;
        document.getElementById('wcLineTableHeaders').innerHTML = lineThRow;

        let tbody = document.getElementById('wcTableBody');
        tbody.innerHTML = "";
        
        let metrics = [
            { lbl: "Production Qty", fmt: v=>v.toLocaleString(), key: 'prodQty', isProd:true },
            { lbl: "Production Value", fmt: formatCurrency, key: 'prodVal', isProd:true },
            { lbl: "Total Scrap Value", fmt: formatCurrency, key: 'scrapVal' },
            { lbl: "Overall Scrap Rate %", fmt: v=>v.toFixed(2)+'%', calc: (s)=> s.prodVal>0 ? (s.scrapVal/s.prodVal*100) : 0 },
            { lbl: "Process Scrap Rate %", fmt: v=>v.toFixed(2)+'%', calc: (s)=> s.prodVal>0 ? (s.proc/s.prodVal*100) : 0 },
            { lbl: "RMD Scrap Rate %", fmt: v=>v.toFixed(2)+'%', calc: (s)=> s.prodVal>0 ? (s.rmd/s.prodVal*100) : 0 },
            { lbl: "Process Scrap (₹)", fmt: formatCurrency, key: 'proc' },
            { lbl: "RMD Scrap (₹)", fmt: formatCurrency, key: 'rmd' },
            { lbl: "PCBA Defect Qty", fmt: v=>v, key: 'pcba' },
            { lbl: "Speaker Defect Qty", fmt: v=>v, key: 'spkr' },
            { lbl: "Battery Defect Qty", fmt: v=>v, key: 'batt' }
        ];

        metrics.forEach(m => {
            let vals = results.map(r => m.key ? r[m.key] : m.calc(r));
            let row = `<tr><td class="text-start fw-bold">${m.lbl}</td>`;
            vals.forEach(v => row += `<td>${m.fmt(v)}</td>`);
            if(diffMode !== 'none') {
                let valA = vals[iA];
                let valB = vals[iB];
                let diff = valA - valB;
                let colorClass = "";
                if (m.isProd) { colorClass = diff > 0 ? "text-success" : (diff < 0 ? "text-danger" : "text-white"); } 
                else { colorClass = diff > 0 ? "text-danger" : (diff < 0 ? "text-success" : "text-white"); }
                let diffStr = m.fmt(diff);
                if (diff > 0) diffStr = "+" + diffStr;
                row += `<td class="bg-dark fw-bold ${colorClass}">${diffStr}</td>`;
            }
            row += `</tr>`;
            tbody.innerHTML += row;
        });

        let lineBody = document.getElementById('wcLineTableBody');
        lineBody.innerHTML = "";
        let allLines = new Set();
        results.forEach(r => Object.keys(r.lineBreakdown).forEach(ln => allLines.add(ln)));
        let sortedLines = Array.from(allLines).sort();
        
        sortedLines.forEach(ln => {
            let row = `<tr><td class="fw-bold" data-val="${ln}">${ln}</td>`;
            let vals = [];
            results.forEach(r => {
                let val = r.lineBreakdown[ln] || 0;
                vals.push(val);
                row += `<td data-val="${val}">${formatCurrency(val)}</td>`;
            });
            if(diffMode !== 'none') {
                let valA = vals[iA];
                let valB = vals[iB];
                let diff = valA - valB;
                let colorClass = diff > 0 ? "text-danger" : (diff < 0 ? "text-success" : "text-white");
                let diffStr = formatCurrency(diff);
                if (diff > 0) diffStr = "+" + diffStr;
                row += `<td class="bg-dark fw-bold ${colorClass}" data-val="${diff}">${diffStr}</td>`;
            }
            row += `</tr>`;
            lineBody.innerHTML += row;
        });

        const ctx = document.getElementById('wcChartCanvas').getContext('2d');
        if(wcChart) wcChart.destroy();
        const colors = ['#004d40', '#e65100', '#4a148c', '#0d47a1'];
        let barData = results.map(r => r.scrapVal);
        let labels = ranges.map(r => r.name);
        wcChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [ { label: 'Total Scrap Value', data: barData, backgroundColor: colors } ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } },
                plugins: { datalabels: { color: 'white', anchor: 'end', align: 'bottom', formatter: (val) => formatCurrency(val) } }
            }
        });
    }

    function renderTrendChart() {
        const pFilter = document.getElementById('trendGraphProduct').value;
        const tFilter = document.getElementById('trendGraphType').value;
        const dFrom = document.getElementById('dateFrom').value;
        const dTo = document.getElementById('dateTo').value;
        let dailyProd = {};
        if(rawData.production.length > 0) {
            rawData.production.slice(1).forEach(row => {
                let d = normalizeDate(row[0]);
                if(!d || d < dFrom || d > dTo) return;
                let productCol = (row[1] || "").toString().toUpperCase(); 
                let ln = normalizeLine(row[3]);
                let model = (row[2] || "").toString().trim().toUpperCase(); 
                let cat = "";
                if(productCol !== "") cat = getProductCategory(productCol, ""); else cat = getProductCategory(model, ln);
                if (productCol.includes("EARBUDS") && productCol.includes("CHARGING")) { if (pFilter === 'EARBUDS') cat = 'EARBUDS'; else if (pFilter === 'CHARGING CASE') cat = 'CHARGING CASE'; }
                if(pFilter !== 'ALL' && cat !== pFilter) return;
                let val = (parseFloat(row[4])||0) * (modelPrices[model]||0);
                if(!dailyProd[d]) dailyProd[d] = 0; dailyProd[d] += val;
            });
        }
        let trendData = {}; 
        if(rawData.scrap.length > 0) {
            rawData.scrap.slice(1).forEach(row => {
                let d = normalizeDate(row[0]);
                if(!d || d < dFrom || d > dTo) return;
                let ln = normalizeLine(row[4]); let floorVal = row[5]; let cat = getProductCategory(floorVal, ln);
                if(pFilter !== 'ALL' && cat !== pFilter) return;
                let val = (parseFloat(row[11])||0) * (parseFloat(row[12])||0); 
                let storeVal = String(row[1]||"").toUpperCase(); let rejVal = String(row[10]||"").toUpperCase();
                let isProc = storeVal.includes('6003') || storeVal.includes('PROCESS') || rejVal.includes('PROCESS');
                let isRMD = storeVal.includes('6002') || storeVal.includes('RMD') || rejVal.includes('RMD');
                if(!trendData[d]) trendData[d] = { proc:0, rmd:0 };
                if(isProc) trendData[d].proc += val; if(isRMD) trendData[d].rmd += val;
            });
        }
        let allDates = new Set([...Object.keys(dailyProd), ...Object.keys(trendData)]);
        let labels = Array.from(allDates).sort();
        let barData = []; let lineRateData = []; let lbl = '';
        labels.forEach(d => {
            let scrapVal = 0; let currentScrap = trendData[d] || { proc:0, rmd:0 };
            if(tFilter === 'PROCESS') scrapVal = currentScrap.proc; else if (tFilter === 'RMD') scrapVal = currentScrap.rmd; else scrapVal = currentScrap.proc + currentScrap.rmd;
            barData.push(scrapVal);
            let prodVal = dailyProd[d] || 0; 
            let rate = prodVal > 0 ? (scrapVal / prodVal) * 100 : 0;
            lineRateData.push(rate);
        });
        if(tFilter === 'PROCESS') lbl = 'Process'; else if(tFilter === 'RMD') lbl = 'RMD'; else lbl = 'Total';
        const ctx = document.getElementById('scrapTrendCanvas').getContext('2d');
        if(scrapTrendChart) scrapTrendChart.destroy();
        scrapTrendChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { type: 'bar', label: lbl + ' Value (₹)', data: barData, backgroundColor: '#dc3545', order: 2, yAxisID: 'y', datalabels: { display: true, color: 'white', anchor: 'end', align: 'bottom', backgroundColor: 'rgba(220, 53, 69, 0.9)', borderRadius: 4, padding: 4, font: { size: 10, weight: 'bold' }, formatter: function(value) { return value >= 1000 ? (value/1000).toFixed(1) + 'k' : Math.round(value); } } },
                    { type: 'line', label: lbl + ' Rate (%)', data: lineRateData, borderColor: '#0d6efd', backgroundColor: '#0d6efd', borderWidth: 2, tension: 0.3, pointRadius: 4, order: 1, yAxisID: 'y1', datalabels: { display: true, color: 'white', align: 'top', backgroundColor: '#0d6efd', borderRadius: 4, padding: 4, font: { size: 10, weight: 'bold' }, formatter: function(value) { return value.toFixed(2) + '%'; } } }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true }, tooltip: { mode: 'index', intersect: false } }, scales: { y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Value (₹)' }, beginAtZero: true, ticks: { callback: function(value) { return value >= 1000 ? (value/1000) + 'K' : value; } } }, y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Rate (%)' }, beginAtZero: true, grid: { drawOnChartArea: false } } } }
        });
    }

    function renderLineComponentAnalysis(lineCompStats, lineProdQtyMap) {
        const prodFilter = document.getElementById('laProduct').value;
        const typeFilter = document.getElementById('laType').value; 
        const compFilter = document.getElementById('laComponent').value; 
        let allKeys = new Set([...Object.keys(lineCompStats), ...Object.keys(lineProdQtyMap)]);
        let keys = Array.from(allKeys).sort(); 
        let processedData = []; let totalEffectiveProd = 0; let totalRawProd = 0; let totalP = 0, totalS = 0, totalB = 0;
        keys.forEach(k => {
            let [ln, cat] = k.split("|");
            if (prodFilter !== 'ALL' && cat !== prodFilter) return;
            let stats = lineCompStats[k] || { raw: {} }; let raw = stats.raw || {};
            let pQ = 0, sQ = 0, bQ = 0;
            if(typeFilter === 'ALL') { pQ = (raw.pcba_proc||0) + (raw.pcba_rmd||0); sQ = (raw.spkr_proc||0) + (raw.spkr_rmd||0); bQ = (raw.batt_proc||0) + (raw.batt_rmd||0); } 
            else if (typeFilter === 'PROCESS') { pQ = raw.pcba_proc||0; sQ = raw.spkr_proc||0; bQ = raw.batt_proc||0; } 
            else { pQ = raw.pcba_rmd||0; sQ = raw.spkr_rmd||0; bQ = raw.batt_rmd||0; }
            let prodRaw = lineProdQtyMap[k] || 0;
            let effectiveProd = prodRaw; 
            if (cat === 'EARBUDS') { effectiveProd = prodRaw * 2; } else { effectiveProd = prodRaw * 1; }
            if(prodRaw === 0 && pQ === 0 && sQ === 0 && bQ === 0) return;
            let pR = effectiveProd > 0 ? (pQ / effectiveProd * 100) : 0;
            let sR = effectiveProd > 0 ? (sQ / effectiveProd * 100) : 0;
            let bR = effectiveProd > 0 ? (bQ / effectiveProd * 100) : 0;
            totalEffectiveProd += effectiveProd; totalRawProd += prodRaw; totalP += pQ; totalS += sQ; totalB += bQ;
            processedData.push({ ln: ln, cat: cat, prodDisplay: prodRaw, prodEffective: effectiveProd, pQ: pQ, pR: pR, sQ: sQ, sR: sR, bQ: bQ, bR: bR, sortMetric: (compFilter==='ALL'?(pQ+sQ+bQ):(compFilter==='PCBA'?pQ:(compFilter==='SPEAKER'?sQ:bQ))) });
        });
        processedData.sort((a,b) => { if (a.cat < b.cat) return -1; if (a.cat > b.cat) return 1; if (a.ln < b.ln) return -1; if (a.ln > b.ln) return 1; return 0; });
        let totPR = totalEffectiveProd > 0 ? (totalP/totalEffectiveProd*100) : 0;
        let totSR = totalEffectiveProd > 0 ? (totalS/totalEffectiveProd*100) : 0;
        let totBR = totalEffectiveProd > 0 ? (totalB/totalEffectiveProd*100) : 0;
        let tableHTML = `<tr class="fw-bold bg-secondary text-white border-top border-3 border-dark" id="subtotalRow"><td class="text-end">GRAND TOTAL</td><td>-</td><td data-val="${totalRawProd}">${totalRawProd.toLocaleString()}</td><td data-val="${totalP}">${totalP}</td><td class="small text-danger fw-bold" data-val="${totPR}">${totPR.toFixed(2)}%</td><td data-val="${totalS}">${totalS}</td><td class="small text-danger fw-bold" data-val="${totSR}">${totSR.toFixed(2)}%</td><td data-val="${totalB}">${totalB}</td><td class="small text-danger fw-bold" data-val="${totBR}">${totBR.toFixed(2)}%</td></tr>`;
        processedData.forEach(d => {
            let bClass = d.cat === 'EARBUDS' ? 'bg-primary' : (d.cat === 'CHARGING CASE' ? 'bg-danger' : 'bg-dark');
            tableHTML += `<tr><td class="fw-bold" data-val="${d.ln}">${d.ln}</td><td data-val="${d.cat}"><span class="badge ${bClass} badge-prod">${d.cat}</span></td><td class="bg-light fw-bold" data-val="${d.prodDisplay}">${d.prodDisplay.toLocaleString()}</td><td class="text-primary" data-val="${d.pQ}">${d.pQ}</td><td class="text-danger fw-bold small" data-val="${d.pR}">${d.pR.toFixed(2)}%</td><td class="text-warning text-dark" data-val="${d.sQ}">${d.sQ}</td><td class="text-danger fw-bold small" data-val="${d.sR}">${d.sR.toFixed(2)}%</td><td class="text-success" data-val="${d.bQ}">${d.bQ}</td><td class="text-danger fw-bold small" data-val="${d.bR}">${d.bR.toFixed(2)}%</td></tr>`;
        });
        document.getElementById('compTableBody').innerHTML = tableHTML;
        let graphData = [...processedData].sort((a,b) => b.sortMetric - a.sortMetric);
        const ctx = document.getElementById('componentAnalysisCanvas').getContext('2d');
        if (componentChart) componentChart.destroy();
        let gl = graphData.map(d => d.ln);
        let gpQ = graphData.map(d => d.pQ); let gpR = graphData.map(d => d.pR);
        let gsQ = graphData.map(d => d.sQ); let gsR = graphData.map(d => d.sR);
        let gbQ = graphData.map(d => d.bQ); let gbR = graphData.map(d => d.bR);
        const lblStyle = { display: true, backgroundColor: 'rgba(255,255,255,0.9)', borderRadius: 3, color: 'black', font: { weight: 'bold', size: 9 }, padding: 3 };
        let datasets = [];
        if(compFilter === 'ALL') {
             datasets.push({ label: 'PCBA Qty', data: gpQ, backgroundColor: '#0d6efd', order:2, datalabels: { align:'end', anchor:'end', ...lblStyle } });
             datasets.push({ label: 'Spkr Qty', data: gsQ, backgroundColor: '#ffc107', order:2, datalabels: { align:'end', anchor:'end', ...lblStyle } });
             datasets.push({ label: 'Batt Qty', data: gbQ, backgroundColor: '#198754', order:2, datalabels: { align:'end', anchor:'end', ...lblStyle } });
        } else if (compFilter === 'PCBA') {
            datasets.push({ label: 'PCBA Qty', data: gpQ, backgroundColor: '#0d6efd', order:2, yAxisID: 'y', datalabels: { align:'end', anchor:'end', ...lblStyle } });
            datasets.push({ label: 'PCBA Rate %', data: gpR, type: 'line', borderColor: '#0d6efd', borderWidth: 2, pointRadius: 4, order:1, yAxisID: 'y1', datalabels: { align:'top', anchor:'start', offset:5, ...lblStyle, color:'#0d6efd', formatter: v=>v.toFixed(2)+'%' } });
        } else if (compFilter === 'SPEAKER') {
            datasets.push({ label: 'Spkr Qty', data: gsQ, backgroundColor: '#ffc107', order:2, yAxisID: 'y', datalabels: { align:'end', anchor:'end', ...lblStyle } });
            datasets.push({ label: 'Spkr Rate %', data: gsR, type: 'line', borderColor: '#ffc107', borderWidth: 2, pointRadius: 4, order:1, yAxisID: 'y1', datalabels: { align:'top', anchor:'start', offset:5, ...lblStyle, color:'#d39e00', formatter: v=>v.toFixed(2)+'%' } });
        } else if (compFilter === 'BATTERY') {
            datasets.push({ label: 'Batt Qty', data: gbQ, backgroundColor: '#198754', order:2, yAxisID: 'y', datalabels: { align:'end', anchor:'end', ...lblStyle } });
            datasets.push({ label: 'Batt Rate %', data: gbR, type: 'line', borderColor: '#198754', borderWidth: 2, pointRadius: 4, order:1, yAxisID: 'y1', datalabels: { align:'top', anchor:'start', offset:5, ...lblStyle, color:'#198754', formatter: v=>v.toFixed(2)+'%' } });
        }
        componentChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: gl, datasets: datasets },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: {display:true, text:'Quantity'} }, y1: { display: (compFilter!=='ALL'), position: 'right', beginAtZero: true, title: {display:true, text:'Rate %'}, grid: {drawOnChartArea:false} } } }
        });
    }

    function triggerSort(colIndex, type, selectEl) { 
        let dir = selectEl.value; if(!dir) return; 
        document.querySelectorAll('#analysisTable .sort-select').forEach(el => { if(el !== selectEl && el.id !== 'prodFilterDropdown') el.selectedIndex = 0; }); 
        sortTable(colIndex, type, dir, 'tableBody'); 
    }
    function triggerModelSort(colIndex, type, selectEl, tbodyId) {
        let dir = selectEl.value; if(!dir) return;
        const headerRow = selectEl.closest('tr');
        headerRow.querySelectorAll('.sort-select').forEach(el => { if(el !== selectEl) el.selectedIndex = 0; });
        sortTable(colIndex, type, dir, tbodyId);
    }
    function triggerCompSort(colIndex, type, selectEl) { 
        let dir = selectEl.value; if(!dir) return; 
        sortCompTable(colIndex, type, dir); 
    }
    function sortTable(colIndex, type, dir, tbodyId) { 
        const tbody = document.getElementById(tbodyId); 
        const rows = Array.from(tbody.querySelectorAll('tr')); 
        rows.sort((rowA, rowB) => { 
            const cellA = rowA.children[colIndex]; 
            const cellB = rowB.children[colIndex]; 
            let valA, valB; 
            if (type === 'num') { valA = parseFloat(cellA.getAttribute('data-val')) || 0; valB = parseFloat(cellB.getAttribute('data-val')) || 0; } 
            else { valA = (cellA.getAttribute('data-val') || cellA.innerText).trim().toLowerCase(); valB = (cellB.getAttribute('data-val') || cellB.innerText).trim().toLowerCase(); } 
            if (valA < valB) return dir === 'asc' ? -1 : 1; 
            if (valA > valB) return dir === 'asc' ? 1 : -1; 
            return 0; 
        }); 
        rows.forEach(row => tbody.appendChild(row)); 
    }
    function sortCompTable(colIndex, type, dir) { 
        const tbody = document.getElementById('compTableBody'); 
        const rows = Array.from(tbody.querySelectorAll('tr')); 
        const subtotalRow = rows.shift(); 
        rows.sort((rowA, rowB) => { 
            const cellA = rowA.children[colIndex]; 
            const cellB = rowB.children[colIndex]; 
            let valA, valB; 
            if (type === 'num') { valA = parseFloat(cellA.getAttribute('data-val')) || 0; valB = parseFloat(cellB.getAttribute('data-val')) || 0; } 
            else { valA = cellA.innerText.trim().toLowerCase(); valB = cellB.innerText.trim().toLowerCase(); } 
            if (valA < valB) return dir === 'asc' ? -1 : 1; 
            if (valA > valB) return dir === 'asc' ? 1 : -1; 
            return 0; 
        }); 
        tbody.appendChild(subtotalRow); 
        rows.forEach(row => tbody.appendChild(row)); 
    }

    function applyProductFilter(selectEl) { 
        const filter = selectEl.value.toUpperCase(); 
        const tr = document.getElementById("analysisTable").getElementsByTagName("tr"); 
        for (let i = 2; i < tr.length; i++) { 
            const td = tr[i].getElementsByTagName("td")[1]; 
            if (td) { 
                const txt = td.getAttribute('data-val') || td.textContent; 
                tr[i].style.display = (filter === "" || txt.toUpperCase().indexOf(filter) > -1) ? "" : "none"; 
            } 
        } 
    }
    
    function applyCompProdFilter(selectEl) { 
        const filter = selectEl.value.toUpperCase(); 
        const tr = document.getElementById("compTable").getElementsByTagName("tr"); 
        for (let i = 2; i < tr.length; i++) { 
            const td = tr[i].getElementsByTagName("td")[1]; 
            if (td) { 
                const txt = td.getAttribute('data-val') || td.textContent; 
                tr[i].style.display = (filter === "" || txt.toUpperCase().indexOf(filter) > -1) ? "" : "none"; 
            } 
        } 
    }
    
    function uploadExcel() { let f = document.getElementById('uploadFile').files[0]; if(!f) return Swal.fire("Error","Select file","warning"); let r = new FileReader(); r.onload = e => { let w = XLSX.read(e.target.result,{type:'array'}); let j = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]); document.getElementById('loader').style.display='flex'; fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'bulk_scrap',rows:j})}).then(()=>{ document.getElementById('loader').style.display='none'; Swal.fire("Success","Uploaded","success"); }); }; r.readAsArrayBuffer(f); }
    function saveProduction() { 
        let dateVal = document.getElementById('pDate').value;
        let lineVal = document.getElementById('pLine').value;
        let productVal = document.getElementById('pProduct').value;
        let modelVal = document.getElementById('pModel').value;
        let outVal = document.getElementById('pOut').value;
        if(!dateVal || !lineVal || !productVal || !modelVal || !outVal) { Swal.fire("Incomplete Data", "Please fill all fields", "warning"); return; }
        let p = { action:'production', date: dateVal, lineNo: lineVal, product: productVal, model: modelVal, output: outVal }; 
        document.getElementById('loader').style.display='flex';
        fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify(p)}).then(()=>{ document.getElementById('loader').style.display='none'; Swal.fire("Saved","Production Entry Saved Successfully","success"); document.getElementById('prodForm').reset(); }); 
    }
    function exportTable() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("analysisTable")), "Quality_Report.xlsx"); }
</script>
</body>
</html>
