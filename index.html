<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality & Scrap Master Dashboard</title>
    
    <!-- CSS & JS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --danger: #e74a3b; --success: #1cc88a; }
        body { background-color: var(--bg); font-family: 'Poppins', sans-serif; font-size: 0.9rem; }
        
        /* Sidebar */
        .sidebar { min-height: 100vh; background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); color: #fff; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 12px 20px; cursor: pointer; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: #fff; border-left-color: var(--accent); }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* Scorecard (Top Header) */
        .scorecard-container { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .score-box { text-align: center; padding: 10px; border-right: 1px solid #eee; }
        .score-box:last-child { border-right: none; }
        .score-val { font-weight: 700; font-size: 1.1rem; color: #2c3e50; }
        .score-label { font-size: 0.75rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; }

        /* High Stats Cards */
        .high-stat-card { background: white; border-radius: 8px; padding: 15px; border-left: 5px solid var(--danger); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .high-stat-title { font-size: 0.75rem; color: #777; text-transform: uppercase; }
        .high-stat-val { font-size: 1.1rem; font-weight: bold; color: #333; }
        .high-stat-sub { font-size: 0.8rem; color: var(--danger); }

        /* Controls */
        .controls-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; background: white; padding: 10px; border-radius: 8px; }
        .toggle-btn { cursor: pointer; padding: 5px 15px; border: 1px solid var(--primary); border-radius: 4px; color: var(--primary); transition: 0.3s; background: white; }
        .toggle-btn.active { background: var(--primary); color: white; }

        /* Tables */
        .table thead { background-color: #2c3e50; color: white; }
        .table th, .table td { vertical-align: middle; padding: 10px; font-size: 0.85rem; }
        .badge-lg { font-size: 0.9rem; padding: 6px 10px; }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="mt-3 text-secondary">Analyzing Quality Data...</h5>
</div>

<div class="container-fluid">
    <div class="row">
        
        <!-- SIDEBAR -->
        <div class="col-md-2 sidebar p-0">
            <div class="sidebar-header">
                <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="max-height: 50px; background: white; padding: 5px; border-radius: 5px;">
                <h6 class="mt-3 mb-0">Quality Control</h6>
            </div>
            <nav class="nav flex-column mt-2">
                <a class="nav-link active" onclick="switchSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i> Main Dashboard</a>
                
                <div class="nav-link text-uppercase small text-muted mt-2">Component Analysis</div>
                <a class="nav-link" onclick="switchSection('pcba')"><i class="fas fa-microchip me-2"></i> PCBA Report</a>
                <a class="nav-link" onclick="switchSection('speaker')"><i class="fas fa-volume-up me-2"></i> Speaker Report</a>
                <a class="nav-link" onclick="switchSection('battery')"><i class="fas fa-battery-full me-2"></i> Battery Report</a>

                <div class="nav-link text-uppercase small text-muted mt-2">Data Entry</div>
                <a class="nav-link" onclick="switchSection('production')"><i class="fas fa-edit me-2"></i> Production Entry</a>
                <a class="nav-link" onclick="switchSection('upload')"><i class="fas fa-file-upload me-2"></i> Bulk Upload</a>
            </nav>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-10 p-4">

            <!-- SECTION: DASHBOARD -->
            <div id="dashboard-section" class="content-section">
                
                <!-- 1. SCORECARD (TOP METRICS) -->
                <div class="scorecard-container">
                    <div class="row g-0">
                        <div class="col score-box">
                            <div class="score-val" id="sc-total-out">0</div>
                            <div class="score-label">Total Output</div>
                        </div>
                        <div class="col score-box">
                            <div class="score-val text-primary" id="sc-total-val">₹0</div>
                            <div class="score-label">Total Prod Value</div>
                        </div>
                        <div class="col score-box">
                            <div class="score-val text-danger" id="sc-tot-scrap">₹0</div>
                            <div class="score-label">Total Scrap</div>
                        </div>
                        <div class="col score-box" style="background: #e8f5e9;">
                            <div class="score-val text-success" id="sc-ovr-rate">0%</div>
                            <div class="score-label">Overall Scrap Rate</div>
                        </div>
                    </div>
                </div>

                <!-- 2. HIGH SCRAP STATS (Top Line, Model, Floor) -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="high-stat-card">
                            <div class="high-stat-title">Highest Scrap Line</div>
                            <div class="high-stat-val" id="high-line">N/A</div>
                            <div class="high-stat-sub" id="high-line-rate">0% Rate</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="high-stat-card" style="border-left-color: #f6c23e;">
                            <div class="high-stat-title">Highest Scrap Model</div>
                            <div class="high-stat-val" id="high-model">N/A</div>
                            <div class="high-stat-sub" id="high-model-val">₹0 Loss</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="high-stat-card" style="border-left-color: #4e73df;">
                            <div class="high-stat-title">Highest Scrap Floor</div>
                            <div class="high-stat-val" id="high-floor">N/A</div>
                            <div class="high-stat-sub" id="high-floor-val">₹0 Loss</div>
                        </div>
                    </div>
                </div>

                <!-- 3. CONTROLS -->
                <div class="controls-bar">
                    <!-- Line Type Toggle -->
                    <div class="btn-group">
                        <button class="btn btn-outline-dark btn-sm" id="btn-earbuds" onclick="setLineType('EARBUDS')">Earbuds</button>
                        <button class="btn btn-outline-dark btn-sm" id="btn-case" onclick="setLineType('CASE')">Charging Case</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="setLineType('ALL')">Reset</button>
                    </div>

                    <div class="d-flex gap-2 align-items-center">
                        <!-- Storage Filter (Restored) -->
                        <select id="storageFilter" class="form-select form-select-sm" style="width: 150px; border-color: #3498db;" onchange="processAndRender()">
                            <option value="ALL">All Storage</option>
                            <option value="PROCESS">Process (6003)</option>
                            <option value="RMD">RMD (6002)</option>
                        </select>

                        <!-- View Mode Toggle -->
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary active" id="view-val" onclick="toggleViewMode('VALUE')">₹ Value</button>
                            <button type="button" class="btn btn-outline-primary" id="view-qty" onclick="toggleViewMode('QTY')">123 Qty</button>
                        </div>
                        
                        <!-- Sort -->
                        <select id="sortFilter" class="form-select form-select-sm" style="width: 140px;" onchange="processAndRender()">
                            <option value="DESC">Rate: High to Low</option>
                            <option value="ASC">Rate: Low to High</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="loadData()"><i class="fas fa-sync"></i></button>
                    </div>
                </div>

                <!-- 4. MAIN LINE TABLE -->
                <div class="card">
                    <div class="card-header">Line Wise Analysis</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped table-hover text-center align-middle mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Line No</th>
                                        <th>Prod Value</th>
                                        <th>Scrap Value</th>
                                        <th>Rate %</th>
                                        <th id="breakdown-header">Defect Breakdown (Value ₹)</th> <!-- merged for cleaner look, handled in row -->
                                        <th>PCBA</th><th>Speaker</th><th>Battery</th><th>Magnet</th><th>Other</th>
                                    </tr>
                                </thead>
                                <tbody id="lineTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMPONENT REPORTS -->
            <div id="pcba-section" class="content-section" style="display:none;"></div>
            <div id="speaker-section" class="content-section" style="display:none;"></div>
            <div id="battery-section" class="content-section" style="display:none;"></div>

            <!-- ENTRY & UPLOAD -->
            <div id="production-section" class="content-section" style="display:none;">
                <h3>Production Entry</h3>
                <div class="card p-4 shadow-sm" style="max-width: 600px;">
                    <form id="prodForm">
                        <div class="mb-3"><label>Date</label><input type="date" id="pDate" class="form-control" required></div>
                        <div class="mb-3"><label>Model</label><select id="pModel" class="form-select"></select></div>
                        <div class="mb-3">
                            <label>Line No</label>
                            <input type="text" id="pLine" class="form-control" placeholder="e.g. L-11 or L-11C" required>
                            <small class="text-muted">Enter Line No (L-1, L-1C are linked automatically)</small>
                        </div>
                        <div class="mb-3"><label>Output Qty</label><input type="number" id="pOut" class="form-control" required></div>
                        <button type="button" class="btn btn-success w-100" onclick="saveProduction()">Save Data</button>
                    </form>
                </div>
            </div>

            <div id="upload-section" class="content-section" style="display:none;">
                <h3>Bulk Scrap Upload</h3>
                <div class="card p-5 text-center">
                    <div class="border dashed p-5 bg-white rounded">
                        <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                        <h5>Upload Excel</h5>
                        <input type="file" id="uploadFile" class="form-control w-50 mx-auto mb-3" accept=".xlsx">
                        <button class="btn btn-primary" onclick="uploadExcel()">Process & Upload</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // ********************************************************
    // PASTE YOUR GOOGLE APPS SCRIPT URL HERE
    // ********************************************************
    const API_URL = "https://script.google.com/macros/s/AKfycbyD1Y63nykh84uHHhUWxkfucyVi6crvEdY4KEXVzKg3FgQCGRj55ljmjTZfGyZFcCbUyg/exec"; 

    // STATE
    let rawData = { production: [], scrap: [], models: [] };
    let modelPrices = {};
    let currentLineType = 'ALL'; // ALL, EARBUDS, CASE
    let viewMode = 'VALUE'; // VALUE, QTY

    window.onload = loadData;

    function switchSection(id) {
        document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
        
        if(['pcba','speaker','battery'].includes(id)) {
            renderComponentReport(id);
            document.getElementById(id+'-section').style.display = 'block';
        } else {
            document.getElementById(id+'-section').style.display = 'block';
        }
        
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    async function loadData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            let res = await fetch(API_URL);
            let json = await res.json();
            rawData = json;
            
            if(json.models) {
                let pSelect = document.getElementById('pModel');
                pSelect.innerHTML = "";
                json.models.slice(1).forEach(r => {
                    modelPrices[r[0]] = parseFloat(r[1]) || 0;
                    pSelect.add(new Option(r[0], r[0]));
                });
            }
            processAndRender();
        } catch(e) { Swal.fire("Error", "Failed to load data", "error"); }
        document.getElementById('loader').style.display = 'none';
    }

    function processAndRender() {
        const storageFilter = document.getElementById('storageFilter').value;

        // 1. CALCULATE PRODUCTION (Unified Baseline)
        let prodMap = {}; // Key: "1", "2", "3" (Base Number) -> { val: 0, qty: 0 }
        
        if(rawData.production.length > 0) {
            let h = rawData.production[0].map(x=>x.toLowerCase());
            let iLine = h.findIndex(x=>x.includes('line'));
            let iMod = h.indexOf('model') > -1 ? h.indexOf('model') : 2;
            let iOut = h.indexOf('output') > -1 ? h.indexOf('output') : h.length-1;

            rawData.production.slice(1).forEach(row => {
                let lineRaw = (row[iLine] || "").toString();
                let baseLine = normalizeLine(lineRaw); 
                let model = row[iMod];
                let qty = parseFloat(row[iOut]) || 0;
                let price = modelPrices[model] || 0;
                
                if(!prodMap[baseLine]) prodMap[baseLine] = { val: 0, qty: 0 };
                prodMap[baseLine].val += (qty * price); 
                prodMap[baseLine].qty += qty;
            });
        }

        // 2. CALCULATE SCRAP & HIGH STATS
        let scrapMap = {}; 
        let modelStats = {};
        let floorStats = { 'First Floor':0, 'Second Floor':0, 'Basement':0, 'Other':0 };
        let totalStats = { out:0, prodVal:0, totScrap:0 };

        // Add Prod Totals
        Object.values(prodMap).forEach(p => { totalStats.out += p.qty; totalStats.prodVal += p.val; });

        if(rawData.scrap.length > 0) {
            let h = rawData.scrap[0].map(x=>x.toString().toLowerCase());
            let iLine = h.findIndex(x=>x.includes('line'));
            let iStore = h.findIndex(x=>x.includes('storage'));
            let iCat = h.indexOf('category');
            let iPrice = h.indexOf('price');
            let iQty = h.findIndex(x=>x.includes('reject') || x.includes('qty'));
            let iModel = h.indexOf('model');

            rawData.scrap.slice(1).forEach(row => {
                let lineRaw = (row[iLine] || "").toString().toUpperCase().trim();
                let baseLine = normalizeLine(lineRaw);
                let isCase = lineRaw.endsWith('C') || lineRaw.includes('-C'); 

                // STORAGE FILTER
                let storeVal = (row[iStore] || "").toString().toLowerCase();
                if(storageFilter === 'PROCESS' && !storeVal.includes('6003') && !storeVal.includes('process')) return;
                if(storageFilter === 'RMD' && !storeVal.includes('6002') && !storeVal.includes('rmd')) return;

                // TYPE FILTER
                if(currentLineType === 'EARBUDS' && isCase) return;
                if(currentLineType === 'CASE' && !isCase) return;

                let price = parseFloat(row[iPrice]) || 0;
                let qty = parseFloat(row[iQty]) || 0;
                let val = price * qty;
                if(val === 0) return;

                totalStats.totScrap += val;

                // Map Scrap to Line
                let cat = row[iCat] || "Other Parts";
                if(!scrapMap[baseLine]) scrapMap[baseLine] = { total:0, cats:{}, catsQty:{} };
                scrapMap[baseLine].total += val;
                if(!scrapMap[baseLine].cats[cat]) scrapMap[baseLine].cats[cat] = 0;
                scrapMap[baseLine].cats[cat] += val;
                if(!scrapMap[baseLine].catsQty[cat]) scrapMap[baseLine].catsQty[cat] = 0;
                scrapMap[baseLine].catsQty[cat] += qty;

                // Map Scrap to Model
                let model = row[iModel] || "Unknown";
                if(!modelStats[model]) modelStats[model] = 0;
                modelStats[model] += val;

                // Map Scrap to Floor
                let floor = getFloor(baseLine);
                if(!floorStats[floor]) floorStats[floor] = 0;
                floorStats[floor] += val;
            });
        }

        renderScorecard(totalStats);
        renderHighStats(scrapMap, prodMap, modelStats, floorStats);
        renderTable(prodMap, scrapMap);
    }

    // --- HELPER LOGIC ---

    function normalizeLine(str) {
        // Fix for IQC, PDI, TRC: Return as is if no numbers, or specific text
        if(str.match(/IQC|PDI|TRC/i)) return str.toUpperCase();
        // Else extract numbers for unifying L-1 and L-1C
        let nums = str.replace(/[^0-9]/g, '');
        return nums ? nums : str; // If empty (like "L-"), return original
    }

    function getFloor(lineStr) {
        let num = parseInt(lineStr);
        if(isNaN(num)) return "Other";
        if(num >= 1 && num <= 8) return "First Floor";
        if(num >= 9 && num <= 16) return "Second Floor";
        if(num >= 17 && num <= 24) return "Basement";
        return "Other";
    }

    function renderScorecard(s) {
        document.getElementById('sc-total-out').innerText = s.out.toLocaleString();
        document.getElementById('sc-total-val').innerText = "₹" + (s.prodVal/100000).toFixed(2) + " L";
        document.getElementById('sc-tot-scrap').innerText = "₹" + s.totScrap.toLocaleString();
        let rate = s.prodVal > 0 ? (s.totScrap/s.prodVal)*100 : 0;
        document.getElementById('sc-ovr-rate').innerText = rate.toFixed(2) + "%";
    }

    function renderHighStats(lineScrap, prodMap, modelScrap, floorStats) {
        // 1. High Line
        let topLine = "N/A", topRate = 0;
        Object.keys(lineScrap).forEach(ln => {
            let p = prodMap[ln] ? prodMap[ln].val : 0;
            let s = lineScrap[ln].total;
            let r = p > 0 ? (s/p)*100 : 0;
            if(r > topRate) { topRate = r; topLine = "Line " + ln; }
        });
        document.getElementById('high-line').innerText = topLine;
        document.getElementById('high-line-rate').innerText = topRate.toFixed(2) + "% Rate";

        // 2. High Model (by Value)
        let topMod = "N/A", topModVal = 0;
        Object.entries(modelScrap).forEach(([m, v]) => {
            if(v > topModVal) { topModVal = v; topMod = m; }
        });
        document.getElementById('high-model').innerText = topMod;
        document.getElementById('high-model-val').innerText = "₹" + topModVal.toLocaleString();

        // 3. High Floor
        let topFlr = "N/A", topFlrVal = 0;
        Object.entries(floorStats).forEach(([f, v]) => {
            if(v > topFlrVal) { topFlrVal = v; topFlr = f; }
        });
        document.getElementById('high-floor').innerText = topFlr;
        document.getElementById('high-floor-val').innerText = "₹" + topFlrVal.toLocaleString();
    }

    function renderTable(prodMap, scrapMap) {
        const tbody = document.getElementById('lineTableBody');
        tbody.innerHTML = "";
        
        let allLines = new Set([...Object.keys(prodMap), ...Object.keys(scrapMap)]);
        let lineArray = [];

        allLines.forEach(ln => {
            let pVal = prodMap[ln] ? prodMap[ln].val : 0;
            let sVal = scrapMap[ln] ? scrapMap[ln].total : 0;
            let rate = pVal > 0 ? (sVal/pVal)*100 : 0;
            if(pVal === 0 && sVal > 0) rate = 100; // IQC/PDI case

            let cats = scrapMap[ln] ? scrapMap[ln].cats : {};
            let catsQty = scrapMap[ln] ? scrapMap[ln].catsQty : {};
            
            lineArray.push({ ln, pVal, sVal, rate, cats, catsQty });
        });

        // Sort
        let sortOrd = document.getElementById('sortFilter').value;
        lineArray.sort((a,b) => sortOrd === 'DESC' ? b.rate - a.rate : a.rate - b.rate);

        lineArray.forEach(item => {
            let src = viewMode === 'VALUE' ? item.cats : item.catsQty;
            let sym = viewMode === 'VALUE' ? '₹' : '';
            
            // Safe access
            let cPCBA = (src['PCBA']||0);
            let cSpk = (src['Speaker']||0);
            let cBat = (src['Battery']||0);
            let cMag = (src['Magnet']||0);
            let cOth = (src['Other Parts']||src['Other']||0);

            // Display Logic for Line Name
            let displayLine = isNaN(item.ln) ? item.ln : "Line " + item.ln;

            let row = `<tr>
                <td class="fw-bold text-start ps-3">${displayLine}</td>
                <td>₹${item.pVal.toLocaleString()}</td>
                <td class="text-danger fw-bold">₹${item.sVal.toLocaleString()}</td>
                <td><span class="badge ${item.rate>5?'bg-danger':'bg-success'} badge-lg">${item.rate.toFixed(2)}%</span></td>
                <td></td>
                <td>${sym}${cPCBA.toLocaleString()}</td>
                <td>${sym}${cSpk.toLocaleString()}</td>
                <td>${sym}${cBat.toLocaleString()}</td>
                <td>${sym}${cMag.toLocaleString()}</td>
                <td>${sym}${cOth.toLocaleString()}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // --- COMPONENT REPORTS ---
    function renderComponentReport(compName) {
        let title = compName.toUpperCase() + " Daily Report";
        let targetDiv = document.getElementById(compName + '-section');
        
        // Filter Scrap Data
        let filtered = [];
        if(rawData.scrap.length > 0) {
            let h = rawData.scrap[0].map(x=>x.toLowerCase());
            let iDate = 0; 
            let iLine = h.findIndex(x=>x.includes('line'));
            let iCat = h.indexOf('category');
            let iPrice = h.indexOf('price');
            let iQty = h.findIndex(x=>x.includes('reject')||x.includes('qty'));

            rawData.scrap.slice(1).forEach(row => {
                let cat = (row[iCat]||"").toLowerCase();
                if(cat.includes(compName)) {
                    filtered.push({
                        date: new Date(row[iDate]),
                        line: row[iLine],
                        qty: row[iQty],
                        val: row[iPrice]*row[iQty]
                    });
                }
            });
        }

        // HTML Build
        let html = `<h3>${title}</h3><div class="card mt-3"><div class="card-body">
            <table class="table table-striped table-sm text-center">
            <thead class="table-dark"><tr><th>Date</th><th>Line</th><th>Qty</th><th>Value (₹)</th></tr></thead><tbody>`;
        
        if(filtered.length === 0) html += `<tr><td colspan="4">No data found</td></tr>`;
        else {
            filtered.sort((a,b) => b.date - a.date); // Sort desc
            filtered.forEach(f => {
                html += `<tr><td>${f.date.toLocaleDateString()}</td><td>${f.line}</td><td>${f.qty}</td><td class="fw-bold">₹${f.val.toLocaleString()}</td></tr>`;
            });
        }
        html += `</tbody></table></div></div>`;
        targetDiv.innerHTML = html;
    }

    // --- UTILS ---
    function setLineType(type) {
        currentLineType = type;
        document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
        if(type==='EARBUDS') document.getElementById('btn-earbuds').classList.add('active');
        if(type==='CASE') document.getElementById('btn-case').classList.add('active');
        // 'ALL' has no specific button highlight or reset button logic
        processAndRender();
    }

    function toggleViewMode(mode) {
        viewMode = mode;
        document.getElementById('view-val').classList.toggle('active', mode==='VALUE');
        document.getElementById('view-qty').classList.toggle('active', mode==='QTY');
        document.getElementById('breakdown-header').innerText = mode==='VALUE' ? "Defect Breakdown (Value ₹)" : "Defect Breakdown (Qty)";
        processAndRender();
    }

    // --- SAVE / UPLOAD ---
    function saveProduction() {
        sendData({
            action: 'production',
            date: document.getElementById('pDate').value,
            model: document.getElementById('pModel').value,
            lineNo: document.getElementById('pLine').value,
            output: document.getElementById('pOut').value
        });
    }

    function uploadExcel() {
        let file = document.getElementById('uploadFile').files[0];
        if(!file) return Swal.fire("Error","Select file","warning");
        let r = new FileReader();
        r.onload = e => {
            let wb = XLSX.read(e.target.result, {type:'array'});
            let json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            sendData({action:'bulk_scrap', rows:json});
        };
        r.readAsArrayBuffer(file);
    }

    function sendData(payload) {
        document.getElementById('loader').style.display = 'flex';
        fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload)})
        .then(() => {
            document.getElementById('loader').style.display = 'none';
            Swal.fire("Success","Data Saved","success");
            if(payload.action==='production') document.getElementById('prodForm').reset();
        });
    }
</script>

</body>
</html>
