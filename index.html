<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality & Scrap Master Dashboard</title>
    
    <!-- CSS & JS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --danger: #e74a3b; --success: #1cc88a; }
        body { background-color: var(--bg); font-family: 'Poppins', sans-serif; font-size: 0.9rem; }
        
        /* Sidebar */
        .sidebar { min-height: 100vh; background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); color: #fff; position: fixed; width: 18%; height: 100%; overflow-y: auto; z-index: 1000; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 12px 20px; cursor: pointer; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: #fff; border-left-color: var(--accent); }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .month-selector { padding: 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        /* Main Content */
        .main-content { margin-left: 18%; padding: 20px; width: 82%; }

        /* Scorecard (8-Box Layout) */
        .scorecard-container { background: white; padding: 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        .score-box { text-align: center; padding: 15px 5px; border-right: 1px solid #eee; display: flex; flex-direction: column; justify-content: center; }
        .score-val { font-weight: 700; font-size: 1.1rem; color: #2c3e50; margin-bottom: 5px; }
        .score-label { font-size: 0.7rem; color: #7f8c8d; text-transform: uppercase; font-weight: 600; }
        
        /* Colors */
        .text-blue { color: #2980b9; } .text-yellow { color: #f1c40f; } .text-cyan { color: #00bcd4; } .text-red { color: #e74a3b; }
        .bg-yellow-light { background-color: #fff3cd; } .bg-cyan-light { background-color: #e0f7fa; } .bg-dark-blue { background-color: #2c3e50; color: white; }
        .bg-dark-blue .score-val { color: white; } .bg-dark-blue .score-label { color: rgba(255,255,255,0.7); }

        /* Cards & Tables */
        .comp-card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .comp-header { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-weight: 700; color: #444; display: flex; justify-content: space-between; align-items: center; }
        .controls-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; background: white; padding: 10px; border-radius: 8px; }
        .table thead { background-color: #2c3e50; color: white; }
        .table th, .table td { vertical-align: middle; padding: 8px; font-size: 0.85rem; }
        .badge-lg { font-size: 0.85rem; padding: 5px 8px; }
        
        /* High Stats */
        .high-stat-card { background: white; border-radius: 8px; padding: 15px; border-left: 5px solid var(--danger); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .high-stat-title { font-size: 0.75rem; color: #777; text-transform: uppercase; }
        .high-stat-val { font-size: 1.1rem; font-weight: bold; color: #333; }
        .high-stat-sub { font-size: 0.8rem; color: var(--danger); }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="mt-3 text-secondary">Processing Data...</h5>
</div>

<div class="container-fluid p-0">
    <div class="row g-0">
        
        <!-- SIDEBAR -->
        <div class="col-md-2 sidebar">
            <div class="sidebar-header">
                <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="max-height: 45px; background: white; padding: 5px; border-radius: 5px;">
                <h6 class="mt-2 mb-0">Quality Control</h6>
            </div>
            
            <div class="month-selector">
                <label class="small text-white-50 mb-1">Select Month (Optional)</label>
                <input type="month" id="globalMonth" class="form-control form-control-sm" onchange="applyGlobalFilter()">
            </div>

            <nav class="nav flex-column mt-2">
                <a class="nav-link active" onclick="switchSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i> Main Dashboard</a>
                
                <div class="nav-link text-uppercase small text-muted mt-2">Deep Analysis</div>
                <a class="nav-link" onclick="switchSection('line-analysis')"><i class="fas fa-chart-bar me-2"></i> Line & Floor</a>
                <a class="nav-link" onclick="switchSection('model-analysis')"><i class="fas fa-cube me-2"></i> Model Analysis</a>

                <div class="nav-link text-uppercase small text-muted mt-2">Component Reports</div>
                <a class="nav-link" onclick="switchSection('pcba')"><i class="fas fa-microchip me-2"></i> PCBA Report</a>
                <a class="nav-link" onclick="switchSection('speaker')"><i class="fas fa-volume-up me-2"></i> Speaker Report</a>
                <a class="nav-link" onclick="switchSection('battery')"><i class="fas fa-battery-full me-2"></i> Battery Report</a>

                <div class="nav-link text-uppercase small text-muted mt-2">Input</div>
                <a class="nav-link" onclick="switchSection('production')"><i class="fas fa-edit me-2"></i> Production Entry</a>
                <a class="nav-link" onclick="switchSection('upload')"><i class="fas fa-file-upload me-2"></i> Bulk Upload</a>
            </nav>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-10 main-content">

            <!-- ========================= 1. MAIN DASHBOARD ========================= -->
            <div id="dashboard-section" class="content-section">
                <!-- Scorecard -->
                <div class="scorecard-container">
                    <div class="row g-0">
                        <div class="col score-box"><div class="score-val" id="sc-total-out">0</div><div class="score-label">Total Output</div></div>
                        <div class="col score-box"><div class="score-val text-blue" id="sc-total-val">₹0</div><div class="score-label">Total Value</div></div>
                        <div class="col score-box"><div class="score-val text-yellow" id="sc-proc-scrap">₹0</div><div class="score-label">Process Scrap</div></div>
                        <div class="col score-box"><div class="score-val text-cyan" id="sc-rmd-scrap">₹0</div><div class="score-label">RMD Scrap</div></div>
                        <div class="col score-box"><div class="score-val text-red" id="sc-tot-scrap">₹0</div><div class="score-label">Total Scrap</div></div>
                        <div class="col score-box bg-yellow-light"><div class="score-val" id="sc-proc-rate">0%</div><div class="score-label">Process Rate</div></div>
                        <div class="col score-box bg-cyan-light"><div class="score-val" id="sc-rmd-rate">0%</div><div class="score-label">RMD Rate</div></div>
                        <div class="col score-box bg-dark-blue"><div class="score-val" id="sc-ovr-rate">0%</div><div class="score-label">Overall Rate</div></div>
                    </div>
                </div>

                <!-- High Stats -->
                <div class="row">
                    <div class="col-md-4"><div class="high-stat-card"><div class="high-stat-title">Highest Scrap Line</div><div class="high-stat-val" id="high-line">N/A</div><div class="high-stat-sub" id="high-line-rate">0% Rate</div></div></div>
                    <div class="col-md-4"><div class="high-stat-card" style="border-left-color:#f6c23e;"><div class="high-stat-title">Highest Scrap Model</div><div class="high-stat-val" id="high-model">N/A</div><div class="high-stat-sub" id="high-model-val">₹0 Loss</div></div></div>
                    <div class="col-md-4"><div class="high-stat-card" style="border-left-color:#4e73df;"><div class="high-stat-title">Highest Scrap Floor</div><div class="high-stat-val" id="high-floor">N/A</div><div class="high-stat-sub" id="high-floor-val">₹0 Loss</div></div></div>
                </div>

                <!-- Controls -->
                <div class="controls-bar">
                    <div class="btn-group">
                        <button class="btn btn-outline-dark btn-sm" id="btn-earbuds" onclick="setLineType('EARBUDS')">Earbuds</button>
                        <button class="btn btn-outline-dark btn-sm" id="btn-case" onclick="setLineType('CASE')">Charging Case</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="setLineType('ALL')">Reset</button>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <select id="storageFilter" class="form-select form-select-sm" style="width:130px;" onchange="processAndRender()"><option value="ALL">All Storage</option><option value="PROCESS">Process</option><option value="RMD">RMD</option></select>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary active" id="view-val" onclick="toggleViewMode('VALUE')">₹ Value</button>
                            <button class="btn btn-outline-primary" id="view-qty" onclick="toggleViewMode('QTY')">Qty</button>
                        </div>
                        <select id="sortFilter" class="form-select form-select-sm" style="width:130px;" onchange="processAndRender()"><option value="DESC">Rate: High</option><option value="ASC">Rate: Low</option></select>
                        <button class="btn btn-primary btn-sm" onclick="loadData()"><i class="fas fa-sync"></i></button>
                    </div>
                </div>

                <!-- Main Table -->
                <div class="comp-card">
                    <div class="comp-header">Line Wise Analysis</div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover text-center align-middle mb-0">
                            <thead class="table-dark">
                                <tr><th>Line</th><th>Prod Value</th><th>Scrap Value</th><th>Rate %</th><th colspan="5">Defect Breakdown (Value ₹)</th></tr>
                                <tr class="table-secondary"><th colspan="4"></th><th>PCBA</th><th>Speaker</th><th>Battery</th><th>Magnet</th><th>Other</th></tr>
                            </thead>
                            <tbody id="lineTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========================= 2. LINE & FLOOR ANALYSIS (New) ========================= -->
            <div id="line-analysis-section" class="content-section" style="display:none;">
                <div class="controls-bar">
                    <div class="d-flex gap-2">
                         <div class="btn-group">
                            <button class="btn btn-sm btn-outline-dark" onclick="updateLineFilter('type','EARBUDS')">Earbuds</button>
                            <button class="btn btn-sm btn-outline-dark" onclick="updateLineFilter('type','CASE')">Case</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="updateLineFilter('type','ALL')">All</button>
                        </div>
                        <select class="form-select form-select-sm" onchange="updateLineFilter('storage',this.value)" style="width:120px;">
                            <option value="ALL">All Storage</option><option value="PROCESS">Process</option><option value="RMD">RMD</option>
                        </select>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <label class="fw-bold">Select Line:</label>
                        <select id="lineSelector" class="form-select form-select-sm" style="width:150px;" onchange="renderLineFloorAnalysis()"></select>
                    </div>
                </div>

                <!-- Top: Floor Stats -->
                <div class="comp-card">
                    <div class="comp-header">Floor Wise Summary</div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered text-center mb-0">
                            <thead class="bg-dark-blue text-white"><tr><th>Floor</th><th>Prod Val</th><th>Scrap Val</th><th>Rate %</th><th>PCBA Loss</th><th>Spk Loss</th><th>Bat Loss</th><th>Overall Qty</th></tr></thead>
                            <tbody id="floorStatsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6"><div class="comp-card"><div class="comp-header"><span>Model Wise Scrap (Selected Line)</span><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="modelRateSwitch" onchange="renderLineFloorAnalysis()"><label class="form-check-label small">Show Rate %</label></div></div><div class="p-2"><canvas id="lineModelChart" height="150"></canvas></div></div></div>
                    <div class="col-md-6"><div class="comp-card"><div class="comp-header">Daily Scrap Value Trend</div><div class="p-2"><canvas id="lineTrendChart" height="150"></canvas></div></div></div>
                </div>
                <div class="row">
                    <div class="col-md-4"><div class="comp-card"><div class="comp-header small">PCBA Qty Trend (Date Wise)</div><div class="p-2"><canvas id="linePCBAChart" height="150"></canvas></div></div></div>
                    <div class="col-md-4"><div class="comp-card"><div class="comp-header small">Speaker Qty Trend (Date Wise)</div><div class="p-2"><canvas id="lineSpkChart" height="150"></canvas></div></div></div>
                    <div class="col-md-4"><div class="comp-card"><div class="comp-header small">Battery Qty Trend (Date Wise)</div><div class="p-2"><canvas id="lineBatChart" height="150"></canvas></div></div></div>
                </div>
            </div>

            <!-- ========================= 3. MODEL ANALYSIS (New) ========================= -->
            <div id="model-analysis-section" class="content-section" style="display:none;">
                <div class="comp-card">
                    <div class="comp-header">Model Wise Scrap Rate % vs Value</div>
                    <div class="p-3"><canvas id="modelMainChart" height="100"></canvas></div>
                </div>
                <h6 class="text-secondary mt-3">Model Component Defect Qty</h6>
                <div class="row">
                    <div class="col-md-4"><div class="comp-card"><div class="comp-header small">PCBA Defect Qty</div><div class="p-2"><canvas id="modPCBAChart"></canvas></div></div></div>
                    <div class="col-md-4"><div class="comp-card"><div class="comp-header small">Speaker Defect Qty</div><div class="p-2"><canvas id="modSpkChart"></canvas></div></div></div>
                    <div class="col-md-4"><div class="comp-card"><div class="comp-header small">Battery Defect Qty</div><div class="p-2"><canvas id="modBatChart"></canvas></div></div></div>
                </div>
            </div>

            <!-- ========================= 4. COMPONENT REPORTS ========================= -->
            <div id="component-container" class="content-section" style="display:none;"></div>

            <!-- ========================= 5. ENTRY FORMS ========================= -->
            <div id="production-section" class="content-section" style="display:none;">
                <h3>Production Entry</h3>
                <div class="card p-4 shadow-sm" style="max-width: 600px;">
                    <form id="prodForm">
                        <div class="mb-3"><label>Date</label><input type="date" id="pDate" class="form-control" required></div>
                        <div class="mb-3"><label>Model</label><select id="pModel" class="form-select"></select></div>
                        <div class="mb-3"><label>Line No</label><input type="text" id="pLine" class="form-control" placeholder="e.g. L-11 or L-11C" required></div>
                        <div class="mb-3"><label>Output Qty</label><input type="number" id="pOut" class="form-control" required></div>
                        <button type="button" class="btn btn-success w-100" onclick="saveProduction()">Save Data</button>
                    </form>
                </div>
            </div>
            <div id="upload-section" class="content-section" style="display:none;">
                <h3>Bulk Scrap Upload</h3>
                <div class="card p-5 text-center">
                    <div class="border dashed p-5 bg-white rounded">
                        <i class="fas fa-file-excel fa-4x text-success mb-3"></i><h5>Upload Excel</h5>
                        <input type="file" id="uploadFile" class="form-control w-50 mx-auto mb-3" accept=".xlsx">
                        <button class="btn btn-primary" onclick="uploadExcel()">Process & Upload</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyD1Y63nykh84uHHhUWxkfucyVi6crvEdY4KEXVzKg3FgQCGRj55ljmjTZfGyZFcCbUyg/exec"; 

    // STATE
    let rawData = { production: [], scrap: [], models: [] };
    let filteredData = { production: [], scrap: [] };
    let modelPrices = {};
    let currentLineType = 'ALL'; 
    let viewMode = 'VALUE'; 
    let charts = {}; 
    let lineFilter = { type: 'ALL', storage: 'ALL' };
    let currentCompFilter = { type: 'ALL', storage: 'ALL' };

    // Register DataLabels
    Chart.register(ChartDataLabels);
    Chart.defaults.set('plugins.datalabels', {
        display: 'auto',
        color: '#444',
        align: 'end',
        anchor: 'end',
        formatter: function(value, context) {
            // Format only if value is significant
            if(value === 0) return '';
            if(context.dataset.label && context.dataset.label.includes('%')) return value + '%';
            if(value > 1000) return formatCompact(value, false);
            return value;
        },
        font: { weight: 'bold', size: 10 }
    });

    window.onload = loadData;

    function switchSection(id) {
        document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
        
        if(['pcba','speaker','battery'].includes(id)) {
            currentCompFilter = { type: 'ALL', storage: 'ALL' };
            renderComponentDashboard(id);
            document.getElementById('component-container').style.display = 'block';
        } else if(id === 'line-analysis') {
            renderLineFloorAnalysis();
            document.getElementById('line-analysis-section').style.display = 'block';
        } else if(id === 'model-analysis') {
            renderModelAnalysis();
            document.getElementById('model-analysis-section').style.display = 'block';
        } else {
            document.getElementById(id+'-section').style.display = 'block';
            if(id === 'dashboard') processAndRender();
        }
        
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    async function loadData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            let res = await fetch(API_URL);
            let json = await res.json();
            rawData = json;
            if(json.models) {
                let pSelect = document.getElementById('pModel');
                pSelect.innerHTML = "";
                json.models.slice(1).forEach(r => { modelPrices[r[0]] = parseFloat(r[1]) || 0; pSelect.add(new Option(r[0], r[0])); });
            }
            applyGlobalFilter();
        } catch(e) { Swal.fire("Error", "Failed to load data", "error"); }
        document.getElementById('loader').style.display = 'none';
    }

    function applyGlobalFilter() {
        let selMonth = document.getElementById('globalMonth').value; 
        if(!selMonth) {
            filteredData = { ...rawData };
        } else {
            filteredData.production = rawData.production.filter((row, idx) => {
                if(idx === 0) return true;
                return new Date(row[0]).toISOString().slice(0, 7) === selMonth;
            });
            filteredData.scrap = rawData.scrap.filter((row, idx) => {
                if(idx === 0) return true;
                let dStr = row[1]; // Doc Date
                if(!dStr) return false;
                return new Date(dStr).toISOString().slice(0, 7) === selMonth;
            });
        }
        
        let active = document.querySelector('.nav-link.active').innerText;
        if(active.includes('Main')) processAndRender();
        else if(active.includes('Line')) renderLineFloorAnalysis();
        else if(active.includes('Model')) renderModelAnalysis();
        else if(active.includes('Report')) renderComponentDashboard(active.split(' ')[0].toLowerCase());
    }

    /* === MAIN DASHBOARD === */
    function processAndRender() {
        const storageFilter = document.getElementById('storageFilter').value;
        let prodMap = getProductionData(filteredData.production); 
        let scrapMap = {}; let modelStats = {}; let floorStats = { 'First Floor':0, 'Second Floor':0, 'Basement':0, 'Other':0 };
        let totalStats = { out:0, prodVal:0, totScrap:0, procScrap:0, rmdScrap:0 };

        Object.values(prodMap).forEach(p => { totalStats.out += p.qty; totalStats.prodVal += p.val; });

        if(filteredData.scrap.length > 1) {
            let h = filteredData.scrap[0].map(x=>x.toLowerCase());
            let idx = getColIndices(h);

            filteredData.scrap.slice(1).forEach(row => {
                let lineRaw = (row[idx.line] || "").toString().toUpperCase().trim();
                let baseLine = normalizeLine(lineRaw);
                let isCase = lineRaw.endsWith('C') || lineRaw.includes('-C'); 
                let storeVal = (row[idx.store] || "").toString().toLowerCase();
                let isProcess = storeVal.includes('6003') || storeVal.includes('process');
                let isRMD = storeVal.includes('6002') || storeVal.includes('rmd');

                let val = (parseFloat(row[idx.price]) || 0) * (parseFloat(row[idx.qty]) || 0);
                if(val === 0) return;

                if( (currentLineType === 'EARBUDS' && isCase) || (currentLineType === 'CASE' && !isCase) ) return;
                if( (storageFilter === 'PROCESS' && !isProcess) || (storageFilter === 'RMD' && !isRMD) ) return;

                totalStats.totScrap += val;
                if(isProcess) totalStats.procScrap += val;
                if(isRMD) totalStats.rmdScrap += val;

                let cat = row[idx.cat] || "Other Parts";
                if(!scrapMap[baseLine]) scrapMap[baseLine] = { total:0, cats:{}, catsQty:{} };
                scrapMap[baseLine].total += val;
                if(!scrapMap[baseLine].cats[cat]) scrapMap[baseLine].cats[cat] = 0;
                scrapMap[baseLine].cats[cat] += val;
                
                let qty = parseFloat(row[idx.qty]) || 0;
                if(!scrapMap[baseLine].catsQty[cat]) scrapMap[baseLine].catsQty[cat] = 0;
                scrapMap[baseLine].catsQty[cat] += qty;

                let model = row[idx.model] || "Unknown";
                if(!modelStats[model]) modelStats[model] = 0;
                modelStats[model] += val;

                let floor = getFloor(baseLine);
                if(!floorStats[floor]) floorStats[floor] = 0;
                floorStats[floor] += val;
            });
        }
        renderScorecard(totalStats);
        renderHighStats(scrapMap, prodMap, modelStats, floorStats);
        renderTable(prodMap, scrapMap);
    }

    /* === LINE & FLOOR ANALYSIS === */
    function updateLineFilter(k,v) { lineFilter[k]=v; renderLineFloorAnalysis(); }
    function renderLineFloorAnalysis() {
        let prodMap = getProductionData(filteredData.production);
        let lineSet = new Set([...Object.keys(prodMap)]);
        let scrapRows = filteredData.scrap.length > 1 ? filteredData.scrap.slice(1) : [];
        let h = filteredData.scrap.length > 0 ? filteredData.scrap[0].map(x=>x.toLowerCase()) : [];
        let idx = getColIndices(h);

        scrapRows.forEach(r => lineSet.add(normalizeLine((r[idx.line]||"").toString())));
        let sortedLines = Array.from(lineSet).sort((a,b)=> a.replace(/\D/g,'') - b.replace(/\D/g,''));
        let sel = document.getElementById('lineSelector');
        
        if(sel.options.length === 0 || sel.options.length !== sortedLines.length) {
             sel.innerHTML = "";
             sortedLines.forEach(l => sel.add(new Option("Line "+l, l)));
        }
        let selectedLine = sel.value || sortedLines[0];

        let lineStats = { modelVal:{}, dateVal:{}, pcba:{}, spk:{}, bat:{} };
        let floorData = { 'First Floor':{p:0,s:0,q:0,comp:{}}, 'Second Floor':{p:0,s:0,q:0,comp:{}}, 'Basement':{p:0,s:0,q:0,comp:{}}, 'Other':{p:0,s:0,q:0,comp:{}} };

        Object.keys(prodMap).forEach(ln => { floorData[getFloor(ln)].p += prodMap[ln].val; });

        scrapRows.forEach(row => {
            let lineRaw = (row[idx.line]||"").toString().toUpperCase().trim();
            let baseLine = normalizeLine(lineRaw);
            let isCase = lineRaw.includes('C');
            let store = (row[idx.store]||"").toLowerCase();
            let isProc = store.includes('process')||store.includes('6003');
            let isRMD = store.includes('rmd')||store.includes('6002');

            if(lineFilter.type==='EARBUDS' && isCase) return;
            if(lineFilter.type==='CASE' && !isCase) return;
            if(lineFilter.storage==='PROCESS' && !isProc) return;
            if(lineFilter.storage==='RMD' && !isRMD) return;

            let qty = parseFloat(row[idx.qty])||0;
            let val = (parseFloat(row[idx.price])||0)*qty;
            let cat = (row[idx.cat]||"").toLowerCase();
            let date = new Date(row[1]).toLocaleDateString(); 
            let mod = row[idx.model]||"Unknown";
            let fl = getFloor(baseLine);

            floorData[fl].s += val; floorData[fl].q += qty;
            if(!floorData[fl].comp[cat]) floorData[fl].comp[cat]=0; floorData[fl].comp[cat] += val;

            if(baseLine === selectedLine) {
                if(!lineStats.modelVal[mod]) lineStats.modelVal[mod]=0; lineStats.modelVal[mod] += val;
                if(!lineStats.dateVal[date]) lineStats.dateVal[date]=0; lineStats.dateVal[date] += val;
                if(cat.includes('pcba')) { if(!lineStats.pcba[date]) lineStats.pcba[date]=0; lineStats.pcba[date]+=qty; }
                if(cat.includes('speaker')) { if(!lineStats.spk[date]) lineStats.spk[date]=0; lineStats.spk[date]+=qty; }
                if(cat.includes('battery')) { if(!lineStats.bat[date]) lineStats.bat[date]=0; lineStats.bat[date]+=qty; }
            }
        });

        let fBody = document.getElementById('floorStatsBody'); fBody.innerHTML = "";
        Object.keys(floorData).forEach(f => {
            let d = floorData[f]; if(d.p === 0 && d.s === 0) return;
            let r = d.p>0 ? (d.s/d.p)*100 : 0;
            fBody.innerHTML += `<tr><td class="fw-bold">${f}</td><td>${formatCompact(d.p, true)}</td><td class="text-danger">${formatCompact(d.s, true)}</td><td><span class="badge ${r>5?'bg-danger':'bg-success'}">${r.toFixed(2)}%</span></td><td>${formatCompact(getErrorVal(d.comp,'pcba'),true)}</td><td>${formatCompact(getErrorVal(d.comp,'speaker'),true)}</td><td>${formatCompact(getErrorVal(d.comp,'battery'),true)}</td><td>${d.q.toLocaleString()}</td></tr>`;
        });

        let showRate = document.getElementById('modelRateSwitch').checked;
        let modLabels = Object.keys(lineStats.modelVal);
        let modData = Object.values(lineStats.modelVal);

        renderChart('lineModelChart', 'bar', modLabels, [{label:'Scrap Value', data:modData, backgroundColor:'#3498db'}]);
        renderChart('lineTrendChart', 'line', Object.keys(lineStats.dateVal), [{label:'Value', data:Object.values(lineStats.dateVal), borderColor:'#e74a3b', fill:false}]);
        renderChart('linePCBAChart', 'bar', Object.keys(lineStats.pcba), [{label:'Qty', data:Object.values(lineStats.pcba), backgroundColor:'#1cc88a'}]);
        renderChart('lineSpkChart', 'bar', Object.keys(lineStats.spk), [{label:'Qty', data:Object.values(lineStats.spk), backgroundColor:'#f6c23e'}]);
        renderChart('lineBatChart', 'bar', Object.keys(lineStats.bat), [{label:'Qty', data:Object.values(lineStats.bat), backgroundColor:'#858796'}]);
    }

    /* === MODEL ANALYSIS === */
    function renderModelAnalysis() {
        let prodByModel = {}; let scrapByModel = {}; let compByModel = { pcba:{}, spk:{}, bat:{} };
        filteredData.production.slice(1).forEach(row => {
            let m = row[2]; let q = parseFloat(row[row.length-1])||0; let pr = modelPrices[m]||0;
            if(!prodByModel[m]) prodByModel[m] = {val:0}; prodByModel[m].val += (q*pr);
        });

        let h = filteredData.scrap[0].map(x=>x.toLowerCase());
        let idx = getColIndices(h);
        filteredData.scrap.slice(1).forEach(row => {
            let m = row[idx.model]||"Unknown"; let q = parseFloat(row[idx.qty])||0; let v = (parseFloat(row[idx.price])||0)*q; let cat = (row[idx.cat]||"").toLowerCase();
            if(!scrapByModel[m]) scrapByModel[m] = 0; scrapByModel[m] += v;
            if(!compByModel.pcba[m]) compByModel.pcba[m]=0; if(!compByModel.spk[m]) compByModel.spk[m]=0; if(!compByModel.bat[m]) compByModel.bat[m]=0;
            if(cat.includes('pcba')) compByModel.pcba[m]+=q; if(cat.includes('speaker')) compByModel.spk[m]+=q; if(cat.includes('battery')) compByModel.bat[m]+=q;
        });

        let models = Object.keys(scrapByModel).sort((a,b)=>scrapByModel[b]-scrapByModel[a]).slice(0,15);
        let vals = models.map(m=>scrapByModel[m]);
        let rates = models.map(m => { let p = prodByModel[m] ? prodByModel[m].val : 0; return p > 0 ? ((scrapByModel[m]/p)*100).toFixed(2) : 0; });

        renderChart('modelMainChart', 'bar', models, [ { label: 'Scrap Value (₹)', data: vals, backgroundColor: '#4e73df', order: 2, yAxisID: 'y' }, { label: 'Scrap Rate %', data: rates, type: 'line', borderColor: '#e74a3b', order: 1, yAxisID: 'y1' } ]);
        renderChart('modPCBAChart', 'bar', models, [{label:'Qty', data:models.map(m=>compByModel.pcba[m]), backgroundColor:'#1cc88a'}]);
        renderChart('modSpkChart', 'bar', models, [{label:'Qty', data:models.map(m=>compByModel.spk[m]), backgroundColor:'#f6c23e'}]);
        renderChart('modBatChart', 'bar', models, [{label:'Qty', data:models.map(m=>compByModel.bat[m]), backgroundColor:'#858796'}]);
    }

    /* === COMPONENT REPORTS === */
    function renderComponentDashboard(compName) {
        const container = document.getElementById('component-container');
        let title = compName.toUpperCase();
        let stats = { totalVal: 0, totalQty: 0, trendDate: {}, byLine: {}, byModel: {}, tableRows: [] };
        let h = filteredData.scrap[0].map(x=>x.toLowerCase());
        let idx = getColIndices(h);

        filteredData.scrap.slice(1).forEach(row => {
            let cat = (row[idx.cat]||"").toLowerCase();
            if(!cat.includes(compName)) return;

            let lineRaw = (row[idx.line] || "").toString().toUpperCase();
            let baseLine = normalizeLine(lineRaw);
            let isCase = lineRaw.endsWith('C') || lineRaw.includes('-C');
            let storeVal = (row[idx.store] || "").toString().toLowerCase();
            let isProcess = storeVal.includes('6003') || storeVal.includes('process');
            let isRMD = storeVal.includes('6002') || storeVal.includes('rmd');

            if(currentCompFilter.type === 'EARBUDS' && isCase) return;
            if(currentCompFilter.type === 'CASE' && !isCase) return;
            if(currentCompFilter.storage === 'PROCESS' && !isProcess) return;
            if(currentCompFilter.storage === 'RMD' && !isRMD) return;

            let date = new Date(row[1]).toLocaleDateString();
            let qty = parseFloat(row[idx.qty]) || 0;
            let val = (parseFloat(row[idx.price]) || 0) * qty;
            let model = row[idx.model] || "Unknown";

            stats.totalVal += val; stats.totalQty += qty;
            if(!stats.trendDate[date]) stats.trendDate[date] = 0; stats.trendDate[date] += val;
            if(!stats.byLine[baseLine]) stats.byLine[baseLine] = { val: 0 }; stats.byLine[baseLine].val += val;
            if(!stats.byModel[model]) stats.byModel[model] = { val: 0 }; stats.byModel[model].val += val;
            stats.tableRows.push({ date, line: lineRaw, model, qty, val });
        });

        let html = `<div class="d-flex justify-content-between align-items-center mb-3"><h3 class="text-primary">${title} REPORT</h3><div class="d-flex gap-2"><div class="btn-group"><button class="btn btn-sm btn-outline-dark" onclick="updateCompFilter('${compName}','type','EARBUDS')">Earbuds</button><button class="btn btn-sm btn-outline-dark" onclick="updateCompFilter('${compName}','type','CASE')">Case</button><button class="btn btn-sm btn-outline-secondary" onclick="updateCompFilter('${compName}','type','ALL')">All</button></div><select class="form-select form-select-sm" style="width:120px;" onchange="updateCompFilter('${compName}','storage',this.value)"><option value="ALL">All Storage</option><option value="PROCESS">Process</option><option value="RMD">RMD</option></select></div></div><div class="row mb-4"><div class="col-md-4"><div class="high-stat-card"><div class="high-stat-title">Total ${title} Loss</div><div class="high-stat-val text-danger">${formatCompact(stats.totalVal, true)}</div></div></div><div class="col-md-4"><div class="high-stat-card" style="border-left-color:#36b9cc;"><div class="high-stat-title">Total ${title} Qty</div><div class="high-stat-val">${stats.totalQty.toLocaleString()}</div></div></div><div class="col-md-4"><div class="high-stat-card" style="border-left-color:#1cc88a;"><div class="high-stat-title">Avg Daily Loss</div><div class="high-stat-val">${formatCompact(stats.totalVal / (Object.keys(stats.trendDate).length || 1), true)}</div></div></div></div><div class="comp-card"><div class="comp-header">Daily Loss Trend (Value ₹)</div><div class="p-3"><canvas id="trendChart" height="80"></canvas></div></div><div class="row"><div class="col-md-6"><div class="comp-card"><div class="comp-header">Line Wise Loss</div><div class="p-3"><canvas id="lineCompChart"></canvas></div></div></div><div class="col-md-6"><div class="comp-card"><div class="comp-header">Model Wise Loss</div><div class="p-3"><canvas id="modelCompChart"></canvas></div></div></div></div>`;
        container.innerHTML = html;
        renderChart('trendChart', 'line', Object.keys(stats.trendDate), [{label: 'Loss Value', data: Object.values(stats.trendDate), borderColor: '#e74a3b', fill: false}]);
        renderChart('lineCompChart', 'bar', Object.keys(stats.byLine), [{label: 'Loss Value', data: Object.values(stats.byLine).map(x=>x.val), backgroundColor: '#4e73df'}]);
        renderChart('modelCompChart', 'bar', Object.keys(stats.byModel).sort((a,b)=>stats.byModel[b].val-stats.byModel[a].val).slice(0,10), [{label: 'Loss Value', data: Object.values(stats.byModel).sort((a,b)=>b.val-a.val).slice(0,10).map(x=>x.val), backgroundColor: '#f6c23e'}]);
    }
    function updateCompFilter(c,k,v){ currentCompFilter[k]=v; renderComponentDashboard(c); }

    /* === UTILS === */
    function renderChart(id, type, labels, datasets) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type: type,
            data: { labels: labels, datasets: datasets },
            options: { 
                responsive: true, 
                plugins: { 
                    datalabels: { display: 'auto', align: 'end', anchor: 'end', formatter: (val, ctx) => ctx.dataset.label.includes('%') ? val+'%' : formatCompact(val, false) }, 
                    tooltip: { callbacks: { label: ctx => (ctx.dataset.label.includes('Value')?formatCompact(ctx.raw,true):ctx.raw.toLocaleString()) } } 
                }, 
                scales: { y: { ticks: { callback: v => formatCompact(v, false) }, position:'left' }, y1: { position:'right', grid:{drawOnChartArea:false}, display: datasets.length>1 } } 
            }
        });
    }
    
    function formatCompact(num, isCurr) { if(num >= 100000) return (isCurr?'₹':'') + (num/100000).toFixed(2) + 'L'; if(num >= 1000) return (isCurr?'₹':'') + (num/1000).toFixed(1) + 'k'; return (isCurr?'₹':'') + num.toLocaleString(); }
    function getErrorVal(obj, keyPart) { let sum = 0; Object.keys(obj).forEach(k => { if(k.includes(keyPart)) sum += obj[k]; }); return sum; }
    function getProductionData(rows) { let map = {}; if(rows.length > 1) { let h = rows[0].map(x=>x.toLowerCase()); let idxLine = h.findIndex(x=>x.includes('line')); let idxMod = h.indexOf('model') > -1 ? h.indexOf('model') : 2; let idxOut = h.indexOf('output') > -1 ? h.indexOf('output') : h.length-1; rows.slice(1).forEach(row => { let ln = normalizeLine((row[idxLine]||"").toString()); let mod = row[idxMod]; let qty = parseFloat(row[idxOut])||0; let pr = modelPrices[mod]||0; if(!map[ln]) map[ln] = {val:0, qty:0}; map[ln].val += (qty*pr); map[ln].qty += qty; }); } return map; }
    function getColIndices(h) { return { line: h.findIndex(x=>x.includes('line')), store: h.findIndex(x=>x.includes('storage')), cat: h.indexOf('category'), model: h.indexOf('model'), price: h.indexOf('price'), qty: h.findIndex(x=>x.includes('reject')||x.includes('qty')) }; }
    function normalizeLine(s) { if(s.match(/IQC|PDI|TRC/i)) return s.toUpperCase(); let n = s.replace(/[^0-9]/g, ''); return n ? n : s; }
    function getFloor(s) { let n=parseInt(s); if(isNaN(n))return "Other"; if(n>=1&&n<=8)return "First Floor"; if(n>=9&&n<=16)return "Second Floor"; if(n>=17&&n<=24)return "Basement"; return "Other"; }
    function setLineType(t){ currentLineType=t; document.querySelectorAll('.controls-bar .btn-group button').forEach(b=>b.classList.remove('active')); if(t==='EARBUDS')document.getElementById('btn-earbuds').classList.add('active'); if(t==='CASE')document.getElementById('btn-case').classList.add('active'); processAndRender(); }
    function toggleViewMode(m){ viewMode=m; document.getElementById('view-val').classList.toggle('active',m==='VALUE'); document.getElementById('view-qty').classList.toggle('active',m==='QTY'); processAndRender(); }
    function renderScorecard(s) { document.getElementById('sc-total-out').innerText = formatCompact(s.out, false); document.getElementById('sc-total-val').innerText = formatCompact(s.prodVal, true); document.getElementById('sc-proc-scrap').innerText = formatCompact(s.procScrap, true); document.getElementById('sc-rmd-scrap').innerText = formatCompact(s.rmdScrap, true); document.getElementById('sc-tot-scrap').innerText = formatCompact(s.totScrap, true); document.getElementById('sc-proc-rate').innerText = (s.prodVal>0?(s.procScrap/s.prodVal)*100:0).toFixed(2) + "%"; document.getElementById('sc-rmd-rate').innerText = (s.prodVal>0?(s.rmdScrap/s.prodVal)*100:0).toFixed(2) + "%"; document.getElementById('sc-ovr-rate').innerText = (s.prodVal>0?(s.totScrap/s.prodVal)*100:0).toFixed(2) + "%"; }
    function renderHighStats(lineScrap, prodMap, modelScrap, floorStats) { let topLine="N/A", topRate=0; Object.keys(lineScrap).forEach(ln => { let p=prodMap[ln]?prodMap[ln].val:0; let r=p>0?(lineScrap[ln].total/p)*100:0; if(r>topRate){topRate=r; topLine="Line "+ln;} }); document.getElementById('high-line').innerText = topLine; document.getElementById('high-line-rate').innerText = topRate.toFixed(2)+"% Rate"; let topMod="N/A", topVal=0; Object.entries(modelScrap).forEach(([m,v])=>{if(v>topVal){topVal=v; topMod=m;}}); document.getElementById('high-model').innerText = topMod; document.getElementById('high-model-val').innerText = formatCompact(topVal, true); let topFlr="N/A", topFVal=0; Object.entries(floorStats).forEach(([f,v])=>{if(v>topFVal){topFVal=v; topFlr=f;}}); document.getElementById('high-floor').innerText = topFlr; document.getElementById('high-floor-val').innerText = formatCompact(topFVal, true); }
    function renderTable(prodMap, scrapMap) { const tbody = document.getElementById('lineTableBody'); tbody.innerHTML = ""; let arr = []; let allLines = new Set([...Object.keys(prodMap), ...Object.keys(scrapMap)]); allLines.forEach(ln => { let pVal = prodMap[ln]?prodMap[ln].val:0; let sVal=scrapMap[ln]?scrapMap[ln].total:0; let rate=pVal>0?(sVal/pVal)*100:0; if(pVal===0&&sVal>0)rate=100; arr.push({ln, pVal, sVal, rate, cats:scrapMap[ln]?scrapMap[ln].cats:{}, catsQty:scrapMap[ln]?scrapMap[ln].catsQty:{}}); }); let sort = document.getElementById('sortFilter').value; arr.sort((a,b)=>sort==='DESC'?b.rate-a.rate:a.rate-b.rate); arr.forEach(i=>{ let src=viewMode==='VALUE'?i.cats:i.catsQty; let sym=viewMode==='VALUE'; tbody.innerHTML += `<tr><td class="fw-bold text-start ps-3">${isNaN(i.ln)?i.ln:"Line "+i.ln}</td><td>${formatCompact(i.pVal,true)}</td><td class="text-danger fw-bold">${formatCompact(i.sVal,true)}</td><td><span class="badge ${i.rate>5?'bg-danger':'bg-success'} badge-lg">${i.rate.toFixed(2)}%</span></td><td>${formatCompact(src['PCBA']||0,sym)}</td><td>${formatCompact(src['Speaker']||0,sym)}</td><td>${formatCompact(src['Battery']||0,sym)}</td><td>${formatCompact(src['Magnet']||0,sym)}</td><td>${formatCompact((src['Other Parts']||src['Other']||0),sym)}</td></tr>`; }); }
    function saveProduction() { sendData({action:'production', date:document.getElementById('pDate').value, model:document.getElementById('pModel').value, lineNo:document.getElementById('pLine').value, output:document.getElementById('pOut').value}); }
    function uploadExcel() { let f=document.getElementById('uploadFile').files[0]; if(!f)return Swal.fire("Error","Select file","warning"); let r=new FileReader(); r.onload=e=>{ let w=XLSX.read(e.target.result,{type:'array'}); let j=XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]); sendData({action:'bulk_scrap',rows:j}); }; r.readAsArrayBuffer(f); }
    function sendData(p) { document.getElementById('loader').style.display='flex'; fetch(API_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},body:JSON.stringify(p)}).then(()=>{ document.getElementById('loader').style.display='none'; Swal.fire("Success","Data Saved","success"); if(p.action==='production')document.getElementById('prodForm').reset(); }); }
</script>
</body>
</html>
