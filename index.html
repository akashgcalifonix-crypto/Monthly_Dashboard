<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Scrap Review Dashboard</title>
    
    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart JS & Excel Libs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background-color: #f3f4f6; font-family: 'Nunito', sans-serif; }
        
        /* Sidebar Styling */
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #4e73df 0%, #224abe 100%);
            color: #fff;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        .logo-container { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .logo-container img { max-height: 50px; }
        
        .nav-link { color: rgba(255,255,255,0.8); font-size: 1.1rem; padding: 15px 20px; cursor: pointer; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.2); color: #fff; border-right: 5px solid #fff; }
        
        /* Dashboard Cards */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card-header { background: #fff; border-bottom: 2px solid #f8f9fc; font-weight: 700; color: #4e73df; }
        
        /* Loading Overlay */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<!-- Loader -->
<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="mt-3 text-primary">Fetching & Calculating Data...</h5>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- SIDEBAR -->
        <div class="col-md-2 sidebar p-0">
            <div class="p-4">
                <div class="logo-container">
                    <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
                </div>
                <h6 class="text-center mb-4">Quality Control System</h6>
                <nav class="nav flex-column">
                    <a class="nav-link active" onclick="switchTab('dashboard')"><i class="fas fa-chart-pie me-3"></i>Dashboard</a>
                    <a class="nav-link" onclick="switchTab('production')"><i class="fas fa-industry me-3"></i>Production Entry</a>
                    <a class="nav-link" onclick="switchTab('upload')"><i class="fas fa-file-upload me-3"></i>Bulk Upload</a>
                </nav>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-10 p-4">
            
            <!-- VIEW: DASHBOARD -->
            <div id="dashboard-view">
                <div class="d-flex justify-content-between mb-4">
                    <h2 class="text-dark fw-bold">Scrap Review Dashboard</h2>
                    <button class="btn btn-primary" onclick="loadData()"><i class="fas fa-sync-alt me-2"></i>Refresh Data</button>
                </div>

                <!-- Chart 1: Line Wise Analysis -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-bar me-2"></i>Line Wise Scrap Rate & Value</span>
                    </div>
                    <div class="card-body">
                        <canvas id="lineChart" style="max-height: 400px;"></canvas>
                        
                        <!-- Detailed Table -->
                        <div class="table-responsive mt-4">
                            <table class="table table-bordered table-hover text-center align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Line No</th>
                                        <th>Total Prod Value</th>
                                        <th>Total Scrap Value</th>
                                        <th>Scrap Rate %</th>
                                        <th class="bg-secondary">PCBA Loss</th>
                                        <th class="bg-secondary">Speaker Loss</th>
                                        <th class="bg-secondary">Battery Loss</th>
                                        <th class="bg-secondary">Other Loss</th>
                                    </tr>
                                </thead>
                                <tbody id="lineTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Chart 2: Model Wise -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">Model Wise Scrap Value</div>
                            <div class="card-body">
                                <canvas id="modelChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Chart 3: Part Wise -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">Top 5 Parts Contributing to Scrap</div>
                            <div class="card-body">
                                <canvas id="partChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: PRODUCTION ENTRY -->
            <div id="production-view" style="display:none;">
                <h3 class="mb-3">Daily Production Entry</h3>
                <div class="card p-4" style="max-width: 600px;">
                    <form id="prodForm">
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" id="pDate" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Model Name</label>
                            <select id="pModel" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Line No (e.g., L-11)</label>
                            <input type="text" id="pLine" class="form-control" placeholder="L-11" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Good Output Qty</label>
                            <input type="number" id="pOut" class="form-control" placeholder="0" required>
                        </div>
                        <button type="button" class="btn btn-success w-100" onclick="saveProduction()">Save Entry</button>
                    </form>
                </div>
            </div>

            <!-- VIEW: BULK UPLOAD -->
            <div id="upload-view" style="display:none;">
                <h3 class="mb-3">Bulk Data Upload</h3>
                <div class="card p-5 text-center">
                    <div class="border dashed p-5" style="border: 2px dashed #4e73df; border-radius: 10px; background: #f8f9fc;">
                        <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                        <h5>Upload Daily Scrap Report (.xlsx)</h5>
                        <p class="text-muted">Ensure columns match: Doc Date, Line No, Price, Reject Qty, Material...</p>
                        <input type="file" id="uploadFile" class="form-control w-50 mx-auto mb-3" accept=".xlsx">
                        <button class="btn btn-primary" onclick="processExcelUpload()">Upload & Process</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // ********************************************************
    // PASTE YOUR GOOGLE APPS SCRIPT URL HERE
    // ********************************************************
    const API_URL = "https://script.google.com/macros/s/AKfycbwWTb0jH6XlmDRgaTLEiDex-S-vKE1dqY364UaFo9CFhsL0NQ0bSbKyqfzBRcCEYJ0bjA/exec"; 

    // Global Data Holders
    let modelPrices = {}; 

    // --- INITIALIZE ---
    window.onload = loadData;

    function switchTab(tabId) {
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('production-view').style.display = 'none';
        document.getElementById('upload-view').style.display = 'none';
        document.getElementById(tabId + '-view').style.display = 'block';
        
        // Update Sidebar Active State
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- 1. FETCH DATA (SMART COLUMN MAPPING) ---
    async function loadData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            processData(data);
        } catch (err) {
            Swal.fire("Connection Error", "Check your internet or API URL.", "error");
        }
        document.getElementById('loader').style.display = 'none';
    }

    function processData(data) {
        // A. Process Model Prices (Col 0 = Name, Col 1 = Price)
        // Adjust based on your Model_List sheet structure
        if(data.models && data.models.length > 0) {
             const mHeader = data.models[0].map(h => h.toString().toLowerCase());
             const mIdxPrice = mHeader.indexOf("price") > -1 ? mHeader.indexOf("price") : 1; 
             
             for(let i=1; i<data.models.length; i++){
                 let row = data.models[i];
                 if(row[0]) modelPrices[row[0]] = parseFloat(row[mIdxPrice]) || 0;
             }
             
             // Populate Dropdown
             const sel = document.getElementById('pModel');
             sel.innerHTML = "";
             Object.keys(modelPrices).forEach(m => sel.add(new Option(m, m)));
        }

        // B. Process Production (Good Value)
        let prodStats = {}; // { LineNo: Value }
        if(data.production && data.production.length > 0) {
            // Find columns dynamically
            let headers = data.production[0].map(x => x.toString().toLowerCase());
            let iMod = headers.indexOf('model') > -1 ? headers.indexOf('model') : 2;
            let iLine = headers.indexOf('line') > -1 ? headers.indexOf('line') : 3; // loose match
            if (iLine === -1) iLine = headers.findIndex(h => h.includes('line'));
            let iQty = headers.indexOf('output') > -1 ? headers.indexOf('output') : headers.length - 1;

            for(let i=1; i<data.production.length; i++) {
                let row = data.production[i];
                let line = (row[iLine] || "Unknown").toString();
                let model = row[iMod];
                let qty = parseFloat(row[iQty]) || 0;
                let price = modelPrices[model] || 0;
                
                if(!prodStats[line]) prodStats[line] = 0;
                prodStats[line] += (qty * price);
            }
        }

        // C. Process Scrap (Bad Value) - THIS IS THE CRITICAL FIX
        let lineStats = {}; // { L-01: { scrapVal: 0, cat: {} } }
        let modelStats = {}; 
        let partStats = {}; 

        if(data.scrap && data.scrap.length > 0) {
            // SMART COLUMN DETECTION
            let headers = data.scrap[0].map(x => x.toString().toLowerCase().trim());
            
            // Find Index of specific columns
            let idxLine = headers.findIndex(h => h.includes("line"));
            let idxMat = headers.indexOf("material");
            let idxCat = headers.indexOf("category");
            let idxDesc = headers.indexOf("material description");
            let idxModel = headers.indexOf("model");
            let idxPrice = headers.indexOf("price");
            let idxQty = headers.indexOf("reject qty");

            // Loop Data
            for(let i=1; i<data.scrap.length; i++) {
                let row = data.scrap[i];
                
                // Get Price and Qty safely
                let price = (idxPrice > -1) ? parseFloat(row[idxPrice]) : 0;
                let qty = (idxQty > -1) ? parseFloat(row[idxQty]) : 0;
                
                // If Price is NaN (maybe "$500"), clean it
                if(isNaN(price) && idxPrice > -1) {
                    price = parseFloat(row[idxPrice].toString().replace(/[^0-9.]/g, '')) || 0;
                }

                let totalVal = price * qty;
                if(totalVal === 0) continue; // Skip empty rows

                let line = (idxLine > -1) ? row[idxLine] : "Unknown";
                let model = (idxModel > -1) ? row[idxModel] : "Unknown";
                let cat = (idxCat > -1) ? row[idxCat] : "Other";
                let desc = (idxDesc > -1) ? row[idxDesc] : row[idxMat];

                // Aggregations
                if(!lineStats[line]) lineStats[line] = { scrapVal: 0, cat: {} };
                lineStats[line].scrapVal += totalVal;
                if(!lineStats[line].cat[cat]) lineStats[line].cat[cat] = 0;
                lineStats[line].cat[cat] += totalVal;

                if(!modelStats[model]) modelStats[model] = 0;
                modelStats[model] += totalVal;

                if(!partStats[desc]) partStats[desc] = 0;
                partStats[desc] += totalVal;
            }
        }

        updateCharts(prodStats, lineStats, modelStats, partStats);
    }

    // --- 2. RENDER CHARTS ---
    let charts = {};

    function updateCharts(prodData, scrapData, modelData, partData) {
        // 1. Line Chart & Table
        const lines = Object.keys(scrapData).sort();
        const tbody = document.getElementById('lineTableBody');
        tbody.innerHTML = "";

        let chartLabels = [];
        let chartRates = [];

        lines.forEach(line => {
            let sVal = scrapData[line].scrapVal;
            let pVal = prodData[line] || 0;
            let rate = pVal > 0 ? (sVal / pVal) * 100 : 0;
            
            chartLabels.push(line);
            chartRates.push(rate.toFixed(2));

            // Breakdown
            let cats = scrapData[line].cat;
            
            let row = `<tr>
                <td><strong>${line}</strong></td>
                <td>${pVal.toLocaleString()}</td>
                <td class="text-danger fw-bold">${sVal.toLocaleString()}</td>
                <td><span class="badge ${rate > 2 ? 'bg-danger' : 'bg-success'}">${rate.toFixed(2)}%</span></td>
                <td>${(cats['PCBA'] || 0).toLocaleString()}</td>
                <td>${(cats['Speaker'] || 0).toLocaleString()}</td>
                <td>${(cats['Battery'] || 0).toLocaleString()}</td>
                <td>${(cats['Other Parts'] || cats['Other'] || 0).toLocaleString()}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        // Bar Chart
        if(charts.line) charts.line.destroy();
        charts.line = new Chart(document.getElementById('lineChart'), {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{ 
                    label: 'Scrap Rate %', 
                    data: chartRates, 
                    backgroundColor: '#4e73df',
                    borderRadius: 5 
                }]
            },
            options: { responsive: true, plugins: { legend: {display: false} } }
        });

        // 2. Model Chart (Doughnut)
        const models = Object.keys(modelData);
        const mVals = Object.values(modelData);
        
        if(charts.model) charts.model.destroy();
        charts.model = new Chart(document.getElementById('modelChart'), {
            type: 'doughnut',
            data: {
                labels: models,
                datasets: [{ data: mVals, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'] }]
            }
        });

        // 3. Part Chart (Horizontal Bar)
        const sortedParts = Object.entries(partData).sort((a,b) => b[1] - a[1]).slice(0, 5);
        if(charts.part) charts.part.destroy();
        charts.part = new Chart(document.getElementById('partChart'), {
            type: 'bar',
            data: {
                labels: sortedParts.map(x => x[0].substring(0, 20) + '...'),
                datasets: [{ label: 'Loss Value', data: sortedParts.map(x => x[1]), backgroundColor: '#e74a3b' }]
            },
            options: { indexAxis: 'y' }
        });
    }

    // --- 3. UPLOAD & SAVE ---
    function saveProduction() {
        const payload = {
            action: 'production',
            date: document.getElementById('pDate').value,
            model: document.getElementById('pModel').value,
            lineNo: document.getElementById('pLine').value,
            output: document.getElementById('pOut').value
        };
        sendData(payload);
    }

    function processExcelUpload() {
        const file = document.getElementById('uploadFile').files[0];
        if(!file) return Swal.fire("Error", "Please select a file", "warning");

        const reader = new FileReader();
        reader.onload = function(e) {
            const wb = XLSX.read(e.target.result, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            // Send JSON to Backend
            sendData({ action: 'bulk_scrap', rows: json });
        };
        reader.readAsArrayBuffer(file);
    }

    function sendData(payload) {
        document.getElementById('loader').style.display = 'flex';
        fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'text/plain'},
            body: JSON.stringify(payload)
        }).then(() => {
            document.getElementById('loader').style.display = 'none';
            Swal.fire("Success", "Data has been submitted!", "success");
            if(payload.action === 'production') document.getElementById('prodForm').reset();
        });
    }
</script>

</body>
</html>
